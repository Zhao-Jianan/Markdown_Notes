# 计算机网络
# 概述
## 三大类网络
### 电信网络
提供电话、电报及传真等服务
### 有线电视网络
向用户传送各种电视节目
### 计算机网络
使用户能在计算机之间传送数据文件

*发展最快的并起到核心作用的是计算机网络*

*三网融合：融入现代计算机网络技术*
## 计算机网络
### 互联网（Internet）
计算机网络的互相联接
#### 应用和服务
游戏，视频，社交，电子邮件，购物，网店，网银，无现金支付，数字钱包，数字货币...
#### 工作原理
互连结构，交换技术，TCP/IP 体系结构与协议...
### 互连网（internet）
局部范围互连起来的计算机网络网
## 互联网的重要基本特点
### 连通性 (connectivity)
- 使上网用户之间可以非常便捷、非常经济地交换各种信息
- 好像这些用户终端都彼此直接连通一样
### 资源共享 (Sharing)
- 实现信息共享、软件共享、硬件共享
- 由于网络的存在，这些资源好像就在用户身边一样地方便使用
这两个特点是 Internet 提供许多服务的基础
## 互联网+
- 指“互联网+各个传统行业”。
- 把互联网的创新成果深度融合于经济社会各领域

## 网络的网络
### 计算机网络
- 由若干节点(node)和连接这些节点的链路(link)组成
- 节点可以是计算机、集线器、交换机或路由器等
### 互连网
- internetwork 或 internet
- 多个网络通过一些路由器相互连接起来，构成了一个覆盖范围更大的计算机网络
- “网络的网络”(network of networks)

## 互联网基础结构发展的三个阶段
### 1969 – 1990
从单个网络 ARPANET 向互联网发展
- ARPANET：最初只是一个单个的分组交换网，不是一个互连网
- 1983 年，TCP/IP 协议成为 ARPANET 上的标准协议，使得所有使用 TCP/IP 协议的计算机都能利用互连网相互通信
- 人们把 1983 年作为互联网的诞生时间
- 1990 年，ARPANET 正式宣布关闭
### 1985 – 1993
建成了三级结构的互联网
- 国家科学基金网 NSFNET
- 三级结构：主干网、地区网和校园网（或企业网）
- 覆盖了全美国主要的大学和研究所，并且成为互联网中的主要组成部分
### 1993 – 现在
全球范围的多层次 ISP 结构的互联网
- 出现了互联网服务提供者 ISP (Internet Service Provider)
  - 提供接入到互联网的服务
  - 需要收取一定的费用
- 多层次 ISP 结构
  - 主干 ISP、地区 ISP 和本地 ISP
  - 覆盖面积大小和所拥有的 IP 地址数目的不同
- 互联网交换点 IXP (Internet eXchange Point)
允许两个网络直接相连并快速交换分组
  - 常采用工作在数据链路层的网络交换机
  - 世界上较大的 IXP 的峰值吞吐量都在 Tbit/s 量级
- 内容提供者 (Content Provider)
在互联网上向所有用户提供视频等内容的公司。不向用户提供互联网的转接服务

## 万维网 WWW  (World Wide Web)
- 20 世纪 90 年代，万维网 WWW 的问世
- 由欧洲原子核研究组织 CERN 开发
- 成为互联网指数级增长的主要驱动力。
- 2019 年 3 月底，互联网的用户数已超过了 43.8亿

## 互联网的标准化工作
互联网的标准化工作对互联网的发展起到了非常重要的作用
- 互联网协会（ISOC）
  - 互联网体系结构研究委员会（IAB）
    - 互联网研究部（IRTF）
    - 互联网工程部（IETF）


### 标准发表：以 RFC 的形式
- RFC：Request For Comments （请求评论）
- 所有的 RFC 文档都可从互联网上免费下载
- 任何人都可以用电子邮件随时发表对某个文档的意见或建议
- 但并非所有的 RFC 文档都是互联网标准。只有很少部分的 RFC 文档最后才能变成互联网标准
- RFC 文档按发表时间的先后编上序号（即 RFCxxxx，xxxx 是阿拉伯数字）

## 互联网的组成
从互联网的工作方式上看，可以划分为两大块：
### 互联网的边缘部分
由所有连接在互联网上的主机组成，由用户直接使用，用来进行通信（传送数据、音频或视频）和资源共享
#### 处在互联网边缘部分的就是连接在互联网上的所有的主机。这些主机又称为端系统 (end system)
#### 端系统在功能上可能有很大差别
- 小的端系统：普通个人电脑、智能手机、网络摄像头等。
- 大的端系统：非常昂贵的大型计算机或服务器。
#### 端系统的拥有者：可以是个人、单位、或某个 ISP

**“计算机之间通信”的含义：**
**实际上是指：主机 A 的某个进程和主机 B 上的另一个进程进行通信**

#### 端系统之间的两种通信方式
##### 客户/服务器方式
Client / Server 方式，简称为 C/S 方式
- 客户/服务器方式所描述的是进程之间服务和被服务的关系
- 客户是服务的请求方，服务器是服务的提供方
- 客户与服务器的通信关系建立后，通信可以是双向的，客户和服务器都可发送和接收数据
例如：客户 A 向服务器 B 发出请求服务，服务器 B 向客户 A 提供服务


客户程序和服务器程序主要特点
- 客户程序
  - 被用户调用后运行，需主动向远地服务器发起通信（请求服务）。必须知道服务器程序的地址
  - 不需要特殊的硬件和很复杂的操作系统
- 服务器程序
  - 专门用来提供某种服务的程序，可同时处理多个客户请求。
  - 一直不断地运行着，被动地等待并接受来自各地的客户的通信请求。不需要知道客户程序的地址
  - 一般需要强大的硬件和高级的操作系统支持

##### 对等方式
Peer to Peer 方式，简称为 P2P 方式
- 两台主机在通信时不区分服务请求方和服务提供方。
- 只要都运行了 P2P 软件，就可以进行平等的、对等连接通信

**对等连接方式从本质上看仍然是使用客户服务器方式，只是对等连接中的每一个主机既是客户端又是服务器**

## 互联网的核心部分
由大量网络和连接这些网络的路由器组成，为边缘部分提供服务（提供连通性和交换）
- 是互联网中最复杂的部分
- 向网络边缘中的主机提供连通性，使任何一台主机都能够向其他主机通信
- 在网络核心部分起特殊作用的是路由器 (router)
- 路由器是实现分组交换 (packet switching) 的关键构件，其任务是转发收到的分组

分组转发是网络核心部分最重要的功能
### 典型交换技术包括
#### 电路交换
电路交换的主要特点：
- 电线对的数量与电话机数量的平方（N2）成正比
- 当电话机的数量增多时，使用电话交换机将这些电话连接起来
每一部电话都直接连接到交换机上，而交换机使用交换的方法，让电话用户彼此之间可以很方便地通信。 这种交换方式就是电路交换 (circuit switching)

“交换 (switching)”的含义
- 转接：把一条电话线转接到另一条电话线，使它们连通起来
- 从通信资源的分配角度来看，就是按照某种方式动态地分配传输线路的资源

##### 电路交换分为3个阶段
- 建立连接：建立一条专用的物理通路（占用通信资源）
- 通话：主叫和被叫双方互相通电话（一直占用通信资源）
- 释放连接：释放刚才使用的专用的物理通路（归还通信资源）
这种必须经过“建立连接（占用通信资源）、通话（一直占用通信资源）、释放连接（归还通信资源）”三个步骤的交换方式称为电路交换
- 通话的两个用户始终占用端到端的通信资源

计算机数据具有突发性，这导致在传送数据时，通信线路的利用率很低，真正用来传送数据的时间往往不到 10%，甚至不到 1%，已被用户占用的通信线路资源在绝大部分时间里都是空闲的
#### 分组交换
互联网的核心部分采用分组交换技术
##### 分组交换的主要特点
###### 采用存储转发技术
- 在发送端，先把较长的报文划分成更小的等长数据段
- 数据段前面添加首部就构成了分组 (packet)
- 分组又称为“包”，而分组的首部也可称为“包头”
###### 分组交换以“分组”作为数据传输单元
- 互联网采用分组交换技术。分组是在互联网中传送的数据单元
- 发送端依次把各分组发送到接收端
###### 接收端收到分组后剥去首部，还原成原来的报文
##### 分组在互联网中的转发
- 根据首部中包含的目的地址、源地址等重要控制信息进行转发
- 每一个分组在互联网中独立选择传输路径
- 位于网络核心部分的路由器负责转发分组，即进行分组交换
- 路由器要创建和动态维护转发表

每个分组独立选择传输路径
##### 分组交换的优点
###### 高效
在分组传输的过程中动态分配传输带宽，对通信链路是逐段占用
###### 灵活
为每一个分组独立地选择最合适的转发路由
###### 迅速
以分组作为传送单位，可以不先建立连接就能向其他主机发送分组
###### 可靠
保证可靠性的网络协议；分布式多路由的分组交换网，使网络有很好的生存性

##### 分组交换带来的问题
- 排队延迟
分组在各路由器存储转发时需要排队
- 不保证带宽
动态分配
- 增加开销
各分组必须携带控制信息；路由器要暂存分组，维护转发表等
#### 报文交换
- 在 20 世纪 40 年代，电报通信就采用了基于存储转发原理的报文交换 (message switching)
- 但报文交换的时延较长，从几分钟到几小时不等
- 现在报文交换已经很少有人使用了


#### 三种交换方式的比较
- 若要连续传送大量的数据，且其传送时间远大于连接建立时间，则电路交换的传输速率较快
- 报文交换和分组交换不需要预先分配传输带宽，在传送突发数据时可提高整个网络的信道利用率
- 由于一个分组的长度往往远小于整个报文的长度，因此分组交换比报文交换的时延小，同时也具有更好的灵活性


## 计算机网络的定义
计算机网络的精确定义并未统一
### 较好的定义
计算机网络主要是由一些通用的、可编程的硬件互连而成的，而这些硬件并非专门用来实现某一特定目的（例如，传送数据或视频信号）。这些可编程的硬件能够用来传送多种不同类型的数据，并能支持广泛的和日益增长的应用

*“可编程的硬件”表明：这种硬件一定包含有中央处理器 CPU*

#### 计算机网络所连接的硬件包括
- 一般的计算机
-智能手机、电视 等
#### 计算机网络可以
- 传送数据
- 持多种应用（包括今后可能出现的各种应用）

## 计算机网络的类别
计算机网络有多种类别
可以按以下方法分类：
### 按照网络的作用范围进行分类
#### 个人区域网PAN----Personal Area Networks
范围很小，大约在 10 米左右。有时也称为无线个人区域网 WPAN (Wireless PAN)
#### 局域网LAN----Local Area Networks
局限在较小的范围（如 1 公里左右）。通常采用高速通信线路
#### 城域网MAN----Metropolitan Area Networks
作用范围一般是一个城市，作用距离约为 5-50 公里
#### 广域网WAN----Wide Area Networks
通常为几十到几千公里。有时也称为远程网(long haul network)。是互联网的核心部分
#### Internet
互联网，覆盖全球

*若中央处理机之间的距离非常近（如仅 1 米甚至更小些），则一般就称之为多处理机系统，而不称它为计算机网络*

### 按照网络的使用者进行分类
#### 公用网 (public network)
按规定交纳费用的人都可以使用的网络。也可称为公众网
#### 专用网 (private network)
为特殊业务工作的需要而建造的网络

*公用网和专用网都可以传送多种业务。如传送的是计算机数据，则分别是公用计算机网络和专用计算机网络*
### 用来把用户接入到互联网的网络
接入网 AN (Access Network)
- 又称为本地接入网或居民接入网
- 用于将用户接入互联网
- 实际上就是本地 ISP 所拥有的网络，它既不是互联网的核心部分，也不是互联网的边缘部分
- 是从某个用户端系统到本地 ISP 的第一个路由器（也称为边缘路由器）之间的一种网络
- 从覆盖的范围看，很多接入网还是属于局域网

## 拓扑
信道的分布方式。常见的拓扑结构
- 总线型
- 环型
- 星型
- 扩展的星型
- 层次型/树状
- 全联通/网状

## 协议
一系列规则和约定的规范性描述，它控制网络中的设备之间如何进行信息交换。如：TCP/IP

## 计算机网络的性能
### 计算机网络的性能指标
从不同的方面来度量计算机网络的性能
#### 速率
- 最重要的一个性能指标
- 指的是数据的传送速率，也称为数据率 (data rate) 或比特率 (bit rate)
- 单位：bit/s，或 kbit/s、Mbit/s、 Gbit/s 等
例如：4*10^ bit/s 的数据率就记为 40 Gbit/s。
- 速率往往是指额定速率或标称速率，非实际运行速率
千 = K = 210 = 1024，兆 = M = 220 = 1024 K，吉 = G = 230 = 1024 M
1 字节 (Byte) =  8 比特 (bit）
#### 带宽 (bandwidth)
##### 频域
- 某个信号具有的频带宽度
- 单位是赫兹（或千赫、兆赫、吉赫等）
- 某信道允许通过的信号频带范围称为该信道的带宽（或通频带）
##### 时域
- 某网络中某通道传送数据的能力，表示在单位时间内网络中的某信道所能通过的“最高数据率”
- 单位就是数据率的单位 bit/s
##### 两者本质相同
##### 一条通信链路的“带宽”越宽，其所能传输的“最高数据率”也越高
#### 吞吐量 (throughput)
- 单位时间内通过某个网络（或信道、接口）的实际数据量
- 受网络的带宽或网络的额定速率的限制
  - 额定速率是绝对上限值
  - 可能会远小于额定速率，甚至下降到零
- 有时可用每秒传送的字节数或帧数来表示
#### 时延 (delay 或 latency)
- 指数据（一个报文或分组，甚至比特）从网络（或链路）的一端传送到另一端所需的时间
- 有时也称为延迟或迟延
##### 组成
###### 发送时延
也称为传输时延
是主机或路由器发送数据帧所需要的时间，也就是从发送数据帧的第一个比特算起，到该帧的最后一个比特发送完毕所需的时间
发送时延=数据帧长度(bit)/发送速率(bit/s)
###### 传播时延
是电磁波在信道中传播一定的距离需要花费的时间
传播时延=信道长度(米)/信号在信道上的传播速率(米/秒)
*电磁波传播速率：*
- *自由空间的传播速率是光速 = 3.0 ⅹ 105 km/s*
- *在铜线电缆中的传播速率约 = 2.3 ⅹ 105 km/s*
- *在光纤中的传播速率约 = 2.0 ⅹ 105 km/s*

*注意：发送时延与传播时延有本质上的不同*
- 发送时延发生在机器内部的发送器中，与传输信道的长度（或信号传送的距离）没有任何关系
- 传播时延则发生在机器外部的传输信道媒体上，而与信号的发送速率无关。信号传送的距离越远，传播时延就越大
###### 处理时延
主机或路由器在收到分组时，为处理分组（例如分析首部、提取数据、差错检验或查找路由）所花费的时间
###### 排队时延
- 分组在路由器输入输出队列中排队等待处理和转发所经历的时延
- 排队时延的长短往往取决于网络中当时的通信量。当网络的通信量很大时会发生队列溢出，使分组丢失，这相当于排队时延为无穷大

##### 总时延
总时延  = 发送时延 + 传播时延 + 处理时延 + 排队时延
- 一般说来，小时延的网络要优于大时延的网络
- 在某些情况下，一个低速率、小时延的网络很可能要优于一个高速率但大时延的网络
- 必须指出，在总时延中，究竟是哪一种时延占主导地位，必须具体分析
##### 四种时延产生的地方
假设从结点 A 向结点 B 发送数据
- 在结点A的队列中产生处理时延和排队时延
- 在发送器产生发送时延(即传输时延)
- 在链路上产生传播时延
#### 容易产生的错误概念
以下说法是错误的：“在高速链路（或高带宽链路）上，比特会传送得更快些”
- 对于高速网络链路，我们提高的仅仅是数据的发送速率，而不是比特在链路上的传播速率
- 提高数据的发送速率只是减小了数据的发送时延
#### 时延带宽积
- 时延带宽积 = 传播时延*带宽
- 链路的时延带宽积又称为以比特为单位的链路长度
- 管道中的比特数表示从发送端发出但尚未到达接收端的比特数
- 只有在代表链路的管道都充满比特时，链路才得到了充分利用
#### 往返时间 RTT (Round-Trip Time)
- 表示从发送方发送完数据，到发送方收到来自接收方的确认总共经历的时间
- 往返时间 RTT =结点 A 到 B 的传播时延 tP + 结点 B 处理和排队时延 tPQB + 结点 B 发送时延 tTB + 结点 B 到 A 的传播时延 tP  = 2 x 传播时延 tP  + 结点 B 处理和排队时延 tPQB + 结点 B 发送时延 tTB
- 在互联网中，往返时间还包括各中间结点的处理时延、排队时延以及转发数据时的发送时延。
- 当使用卫星通信时，往返时间 RTT 相对较长，此时，RTT 是很重要的一个性能指标
#### 利用率
##### 信道利用率
- 某信道有百分之几的时间是被利用的（即有数据通过）
- 完全空闲的信道的利用率是零
##### 网络利用率
- 全网络的信道利用率的加权平均值
#### 时延与网络利用率的关系
根据排队论，当某信道的利用率增大时，时延会迅速增加
D=D0/(1-U)
- D0：网络空闲时的时延
- D：网络在当前的时延。
- U：网络当前的利用率，数值在 0 到 1 之间
### 计算机网络的非性能特征
- 费用
- 标准化
- 可靠性
- 质量
- 可扩展性和可升级性
- 管理和维护

## 点到点和端到端
### 点到点
信源机和信宿机之间的通信由一段一段的直接相连的机器间的通信组成，机器间的直接连接叫做点到点连接
### 端到端
信源机和信宿机之间直接通信，好象拥有一条直接的线路


# 计算机网络体系结构
## 计算机网络体系结构的形成
计算机网络是一个非常复杂的系统，两台计算机要互相传送文件需解决很多问题
- 必须有一条传送数据的通路
- 发起方必须激活通路
- 要告诉网络如何识别接收方
- 发起方要清楚对方是否已开机，且与网络连接正常
- 发起方要清楚对方是否准备好接收和存储文件
- 若文件格式不兼容，要完成格式的转换
- 要处理各种差错和意外事故，保证收到正确的文件
### 计算机网络体系结构的形成过程
- 最初的 ARPANET 设计时提出了分层的设计方法
- 分层：将庞大而复杂的问题，转化为若干较小的局部问题。
- 1974 年，IBM 按照分层的方法制定并提出了系统网络体系结构 SNA (System Network Architecture)。此后，其他一些公司也相继推出了具有不同名称的体系结构
- 但由于网络体系结构的不同，不同公司的设备很难互相连通
### 国际标准：开放系统互连参考模型 OSI/RM
- ISO (国际标准化组织) 提出的 OSI/RM (Open Systems Interconnection Reference Model) 是使各种计算机在世界范围内互连成网的标准框架
- OSI/RM 是个抽象的概念
- 1983年，形成了著名的 ISO 7498 国际标准，即七层协议的体系结构
- OSI 试图达到一种理想境界：全球计算机网络都遵循这个统一标准，因而全球的计算机将能够很方便地进行互连和交换数据
但 ISO/OSI 失败了
- 基于 TCP/IP 的互联网已抢先在全球相当大的范围成功地运行了
- OSI 的专家们在完成 OSI 标准时没有商业驱动力
- OSI 的协议实现起来过分复杂，且运行效率很低
- OSI 标准的制定周期太长，使得按 OSI 标准生产的设备无法及时进入市场
- OSI 的层次划分也不太合理，有些功能在多个层次中重复出现
### 存在两种国际标准
- 法律上的 (de jure) 国际标准 OSI，但并没有得到市场的认可
- 事实上的 (de facto) 国际标准 TCP/IP，获得了最广泛的应用

## 协议与划分层次
### 网络协议 (network protocol)
简称为协议，是为进行网络中的数据交换而建立的规则、标准或约定
### 三个组成要素
- 语法：数据与控制信息的结构或格式
- 语义：需要发出何种控制信息，完成何种动作以及做出何种响应
- 同步：事件实现顺序的详细说明
网络协议是计算机网络的不可缺少的组成部分
### 协议的两种形式
- 文字描述：便于人来阅读和理解
- 程序代码：让计算机能够理解

不论什么形式，都必须能够对网络上信息交换过程做出精确的解释
### 层次式协议结构
ARPANET 的研制经验表明：对于非常复杂的计算机网络协议，其结构应该是层次式的
### 分层优点
- 各层工作独立，层之间通过接口联系，降低协议工作的复杂程度
- 灵活性好，任何一层的改变不影响其它层
- 每层的实现技术可以不同，减少了实现的复杂度
- 易于维护，每层可以单独进行调试
- 便于标准化
### 分层缺点
有些功能会重复出现，因而产生了额外开销
**注意：每一层的功能应非常明确**
- 层数太少，就会使每一层的协议太复杂
- 层数太多，又会在描述和综合各层功能的系统工程任务时遇到较多的困难
### 各层完成的主要功能
- 差错控制
使相应层次对等方的通信更加可靠
- 流量控制
发送端的发送速率必须使接收端来得及接收，不要太快
- 分段和重装
发送端将要发送的数据块划分为更小的单位，在接收端将其还原
- 复用和分用
发送端几个高层会话复用一条低层的连接，在接收端再进行分用
- 连接建立和释放
交换数据前先建立一条逻辑连接，数据传送结束后释放连接

## 计算机网络的体系结构概念
- 网络的体系结构 (Network Architecture) 是计算机网络的各层及其协议的集合，就是这个计算机网络及其构件所应完成的功能的精确定义（不涉及实现）
- 实现 (implementation) 是遵循这种体系结构的前提下，用何种硬件或软件完成这些功能的问题
体系结构是抽象的，而实现则是具体的，是真正在运行的计算机硬件和软件

## 计算机网络的体系结构
### OSI 的七层协议体系结构
#### L7层----应用层----Application
- 网络进程到应用程序
- 为应用程序进程提供网络服务（如电子邮件、文件传输、终端仿真）
#### L6层----表示层----Presentation
数据表示
- 确保接收系统可以读取数据
- 数据格式
- 数据结构
- 协商应用层的数据传输语法
#### L5层----会话层----Session
主机间通信
- 建立、管理和终止应用程序之间的会话
#### L4层----传输层----Transport
关注主机之间的交通问题
- 数据传输可靠性
- 建立、维持、终止虚电路
- 故障检测与恢复
- 信息流控制
#### L3层----网络层----Network
地址和最佳路径
- 提供两个终端系统之间的连接和路径选择
- 路由域
#### L2层----数据链路层----Data Link
访问媒体
- 提供跨媒体的可靠数据传输
- 物理寻址、网络拓扑、错误通知、流量控制
#### L1层----物理层----Physical
二进制传输
- 电线、连接器、电压、数据速率

### TCP/IP 的四层协议体系结构
#### L4层----应用层----Application
各种应用层协议，如DNS, HTTP, SMTP 等
#### L3层----运输层----Transport
TCP 或 UDP
#### L2层----网际层----Internet
IP
#### L1层----网络接口层----Network Access
这一层并没有具体内容

**路由器在转发分组时最高只用到网际层，没有使用运输层和应用层**
*现在互联网使用的 TCP/IP 体系结构已经发生了演变，即某些应用程序可以直接使用 IP 层，或甚至直接使用最下面的网络接口层*
**沙漏计时器形状的 TCP/IP 协议族**
- Everything over IP ：IP 层可以支持多种的运输层协议
- IP over Everything：IP 协议可以在多种类型的网络上运行

### 五层协议的体系结构★★★
#### L5层----应用层----Application
##### 任务
通过应用进程间的交互来完成特定网络应用
##### 协议
定义的是应用进程间通信和交互的规则

**把应用层交互的数据单元称为报文(message)**
例如：DNS，HTTP，SMTP

#### L4层----运输层----Transport
##### 任务
负责向两台主机中进程之间的通信提供通用的数据传输服务
##### 功能
具有复用和分用的功能
##### 主要使用两种协议： 
###### 传输控制协议 TCP (Transmission Control Protocol)
- 提供面向连接的、可靠的数据传输服务。
- 数据传输的单位是报文段 (segment)
###### 用户数据报协议 UDP (User Datagram Protocol)
- 提供无连接的尽最大努力 (best-effort) 的数据传输服务（不保证数据传输的可靠性）
- 数据传输的单位是用户数据报
#### L3层----网络层----Network
为分组交换网上的不同主机提供通信服务
##### 两个具体任务
###### 路由选择
通过一定的算法，在互联网中的每一个路由器上，生成一个用来转发分组的转发表
###### 转发
每一个路由器在接收到一个分组时，要依据转发表中指明的路径把分组转发到下一个路由器

互联网使用的网络层协议是无连接的网际协议 IP  (Internet Protocol) 和许多种路由选择协议，因此互联网的网络层也叫做网际层或 IP 层

IP 协议分组也叫做 IP 数据报，或简称为数据报

#### L2层----数据链路层----Data Link
简称为链路层
##### 任务
实现两个相邻节点之间的可靠通信

在两个相邻节点间的链路上传送帧（frame）

如发现有差错，就简单地丢弃出错帧

如果需要改正出现的差错，就要采用可靠传输协议来纠正出现的差错。这种方法会使数据链路层协议复杂
#### L1层----物理层----Physical
##### 任务
实现比特（0 或 1）的传输

确定连接电缆的插头应当有多少根引脚，以及各引脚应如何连接

##### 注意
传递信息所利用的一些物理媒体，如双绞线、同轴电缆、光缆、无线信道等，并不在物理层协议之内，而是在物理层协议的下面

### OSI模型和TCP/IP模型比较
#### 相同点
- 都分层
- 都有应用层，尽管他们的服务不同
- 都有可比较的传输层和网络层
- 使用的分组交换而不是电路交换技术
#### 不同点
- TCP/IP将表示层和会话层包含到了应用层
- TCP/IP将OSI的数据链路层和物理层包括到了一层中
- TCP/IP更简洁，但OSI更易开发和排除故障
- TCP/IP在实践中产生

### 对等层与协议数据单元
- OSI 参考模型把对等层次之间传送的数据单位称为该层的协议数据单元 PDU (Protocol Data Unit)
- 任何两个同样的层次把 PDU （即数据单元加上控制信息）通过水平虚线直接传递给对方。这就是所谓的“对等层”之间的通信
- 各层协议实际上就是在各个对等层之间传递数据时的各项规定


## 实体、协议、服务和服务访问点
### 实体 (entity) 
表示任何可发送或接收信息的硬件或软件进程 
### 协议
控制两个对等实体进行通信的规则的集合


在协议的控制下，两个对等实体间的通信使得本层能够向上一层提供服务

要实现本层协议，还需要使用下层所提供的服务

## 协议与服务的区分
协议和服务在概念上是不一样的
### 协议
- 其实现保证了能够向上一层提供服务
- 对上面的服务用户是透明的
- 协议是“水平的”
### 服务
- 上层使用服务原语获得下层所提供的服务
- 上面的服务用户只能看见服务，无法看见下面的协议
- 服务是“垂直的”

## 服务访问点 SAP
- 在同一系统中相邻两层的实体进行交互（即交换信息） 的地方，通常称为服务访问点 SAP (Service Access Point)
- SAP 是一个抽象的概念，它实际上就是一个逻辑接口
- OSI 把层与层之间交换的数据的单位称为服务数据单元 SDU (Service Data Unit)
- SDU 可以与 PDU 不一样。
例如：可以是多个 SDU 合成为一个 PDU，也可以是一个 SDU 划分为几个 PDU

## TCP/IP 的体系结构


## 数据如何传输
### 数据传输的三要素
- 发送方
- 接收方
- 信道
### 发送方要做的工作
#### 封装/打包
将信息打包，从最高层--应用层开始逐渐下行到最底层--物理层
#### 协议数据单元（PDU）
- 信息（Information）
- 数据流（Data stream）
- 数据段（Segment）
- 分组（Packet）
- 帧（Frame）
- 比特流（Bits）
### 接收方要做的工作
- 解封装/解包
将信息解包，从最低层—物理层开始逐渐上行到最高层—应用层
- 任何一次通信，总是以发方的封装开始，以收方的解封装结束
- 数据从发方，穿过中间的网络云，流向收方，是一个“U”型流
- 发方和收方之间好像有一个“直接”的通道，PDU从发方流向接收方
### 对等通信/虚拟通信

### 谁来完成封装等本层功能
#### 实体（Entity）
每层中活动的元素
##### 对等实体（peer）

每一层都有一个实体，可能是硬件也可能是软件，它负责实现本层的功能

在参考模型上，每一层都为它的上一层提供服务
- 面向连接的服务
- 无连接的服务


# 物理层(Physical Layer)
物理层是参考模型的最底层，基础层，它没有下一层的支撑，它为数据链路层服务
## 物理层的基本概念
物理层考虑的是怎样才能在连接各种计算机的传输媒体上传输数据比特流，而不是指具体的传输媒体
### 作用
尽可能屏蔽掉不同传输媒体和通信手段的差异，为数据链路层提供一个统一的数据传输服务

用于物理层的协议也常称为物理层规程 (procedure)

## 物理层的功能
- 数据链路层将比特流传送给物理层
- 物理层将比特流按照传输媒体的需要进行编码
- 然后将信号通过传输媒体传输到下一个节点的物理层

**物理层提供透明的比特流传输。要特别注意两点：**
- 封装好的数据以“0、1”比特流的形式进行传递，从一个地方搬到另一个地方
- 物理层上的传输，从不关心比特流里面携带的信息，只关心比特流的正确搬运


## 物理层的主要任务
确定与传输媒体的接口有关的4大特性
物理层协议是DTE和DCE之间的约定，规定了标准化的DTE/DCE都具有的特性
### 机械特性 (mechanical characteristics)
指明接口所用接线器的形状和尺寸、引线数目和排列、固定和锁定装置等，如RJ45
### 电气特性 (electrical characteristics)
指明在接口电缆的各条线的电气连接及有关电路特性，例如电压范围、阻抗、传输速率等
### 功能特性 (functional characteristics)
指明某条线上出现的某一电平的电压的意义，定义接线器的每一引脚(Pin)的作用
### 规程特性 (procedural characteristics)
指明对于不同功能的各种可能事件的出现顺序
规程的概念类似协议
## 物理层设备
### 数据终端设备（DTE）
- 一种具有一定的数据处理和转发能力的设备
- 可以是数据的源点或终点
### 数据电路终结设备（DCE）
- 在DTE和传输线路之间提供信号
- 变换和编码的功能
- 负责建立、保持和释放数据链路

## 数据通信的基本概念
研究信号在通信信道上传输时的数学表示及其所受到的限制
### 傅立叶分析
- 在网络通信中，信息是以电磁信号（简称信号）的形式传输的
- 电磁信号是时间的函数（时域观），也可以表示成频率的函数（频域观）
- 对于理解数据传输来讲，信号的频域观比时域观更重要
### 时域观
从时间函数的角度来看，电磁信号分为模拟信号和数字信号
### 频域观
- 当一个信号的所有频率成分是某一个频率的整数倍时，该频率被称为基本频率
- 信号的周期等于基本频率的周期
## 数据通信的基础知识
### 数据通信系统的模型
三大部分：
- 源系统（或发送端、发送方）
- 传输系统（或传输网络）
- 目的系统（或接收端、接收方）
### 数据通信常用术语
通信是在源点与终点之间传递消息或信息，但信息和消息有着不同的概念
#### 消息(message)
消息指能向人们表达客观物质运动和主观思维活动的文字、符号、数据、语音和图像等
- 能被通信双方所理解
- 可以相互传递
#### 信息
信息是指包含在消息中对通信者有意义的那部分内容，消息是信息的载体
#### 数据 (data)
数据是对某一事实的不经解释并赋予一定含义的数字、字母、文字等符号及其组合和原始表达，是运送消息的实体，是有意义的符号序列。分为模拟数据和数字数据
#### 信号 (signal)
信号是消息的载体（比如电信号、光信号等），是数据的电气的或电磁的表现
在通信系统中，消息通过电信号来传递，电信号有模拟信号和数字信号
##### 模拟信号 (analogous signal)
代表消息的参数的取值是连续的
##### 数字信号 (digital signal)
代表消息的参数的取值是离散的 
#### 码元
在使用时间域（简称为时域）的波形表示数字信号时，代表不同离散数值的基本波形
- 使用二进制编码时，只有两种不同的码元：0 状态，1 状态
### 信道的几个基本概念
#### 信道
信号传输的通道（传输媒介），按照数据信号在信道上的传送方向与时间的关系，传输方式可分为三类
##### 单向通信（单工通信）
只能有一个方向的通信，没有反方向的交互
##### 双向交替通信（半双工通信）
通信的双方都可以发送信息，但双方不能同时发送（当然也就不能同时接收）
##### 双向同时通信（全双工通信）
通信的双方可以同时发送和接收信息
#### 基带信号（即基本频带信号）
- 信源发出的没有经过调制的原始信号（模拟的或数字的）
- 包含有较多的低频成分，甚至有直流成分
#### 调制
##### 基带调制
仅对基带信号的波形进行变换，把数字信号转换为另一种形式的数字信号，例如用不同电压表示0和1。把这种过程称为编码 (coding)
##### 带通调制
使用载波 (carrier)进行调制，把基带信号的频率范围搬移到较高的频段，并转换为模拟信号。经过载波调制后的信号称为带通信号（即仅在一段频率范围内能够通过信道）

**编码：数据---->数字信号**
**调制：数据---->模拟信号**

| 输入数据类型   | 处理设备         | 输出信号类型    | 处理过程 |
|----------------|------------------|-----------------|----------|
| 模拟数据       | 放大器调制器     | 模拟信号        | 调制     |
| 模拟数据       | PCM编码器        | 数字信号        | 编码     |
| 数字数据       | 调制器           | 模拟信号        | 调制     |
| 数字数据       | 数字发送器       | 数字信号        | 编码     |



### 数字信号编码方式
#### 非归零制（Non-Return-to-Zero，NRZ）
高电平表示“1”，低电平表示“0”，非常简单，但是很少使用，如果出现连续的“0”或连续的“1”，随着时间漂移的累计，可能接收方完全无法分辨出到底是几个“1”或“0”
#### 归零制（Return-to-Zero，RZ）
- 正脉冲代表 1，负脉冲代表 0
- 信号在每个位周期的中点返回到零电平。这意味着每个二进制位的表示都包括两个电平状态，一个高电平和一个低电平
##### 基本规则
- 逻辑0----信号的电平在位周期内保持不变，然后在中点向零电平返回
- 逻辑1----信号的电平在位周期内发生变化，通常是从低电平变为高电平，然后在中点向零电平返回
#### 逆转非归零制（Inverted Non-Return-to-Zero，NRZI）
是非归零制NRZ的一种变种，对非归零制NRZ做了改进，在比特时间中间做电压的跳变，表示“1”，无跳变，则表示“0”。连续1问题得到了解决，连续0问题仍然存在。在USB采用
#### 曼彻斯特编码（Manchester Encoding）
- 在比特时间中间，电压从高跳变到低，表示“1”，反之从低跳变到高，则表示“0”。解决了连续0和连续1的问题
- 在10Base以太网中采用。但因为在比特时间中跳变，编码效率只有50%
- 具有自同步能力
#### 差分曼彻斯特编码（Differential Manchester Encoding）
是曼彻斯特编码的一种变种。在差分曼彻斯特编码中，信号变化的方向表示二进制位的值，而不是具体的电平状态
##### 基本规则
- 在每个位周期的中点，如果信号的电平发生变化，表示逻辑1
- 如果在每个位周期的中点信号的电平保持不变，表示逻辑0

具体的规则可以概括为：逻辑0的起始和结束时刻都是电平相同的，而逻辑1的起始和结束时刻是电平相反的

##### 具有自同步能力

#### 双极编码（交替标记逆转AMI）
- 两级电压的交替出现表示“1”，不出现则表示“0”
- 实现了信号的平衡
#### 4B/5B
- 4比特数据被映射为1个5比特模式（抛开连续0的组合，解决了连续零问题）
- 相比曼彻斯特编码，编码效率提高到80%


### 基本的带通调制方法
- 基带信号往往包含有较多的低频成分，甚至有直流成分，而许多信道并不能传输这种低频分量或直流分量
- 必须对基带信号进行调制 (modulation)
#### 最基本的调制方法有以下几种
- 调幅(AM)：载波的振幅随基带数字信号而变化 
- 调频(FM)：载波的频率随基带数字信号而变化
- 调相(PM) ：载波的初始相位随基带数字信号而变化

### 正交振幅调制 QAM (Quadrature Amplitude Modulation)
一种多元制的振幅相位混合调制方法，以达到更高的信息传输速率

例如：
- 可供选择的相位有 12 种，而对于每一种相位有 1 或 2 种振幅可供选择。总共有 16 种组合，即 16 个码元
- 由于 4 bit 编码共有 16 种不同的组合，因此这 16 个点中的每个点可对应于一种 4 bit 的编码。数据传输率可提高 4 倍
### 码元（symbol）
在使用时域的波形表示数字信号时，代表不同离散数值的基本波形
- 码元是承载信息量的基本信号单位
- 在数字通信中常常用时间间隔相同的符号来表示一个二进制数字，这样的时间间隔内的信号称为(二进制）码元
- 使用二进制编码时，只有两种不同的码元：0状态和1状态
- 当码元的离散状态有M个时（M>2），此时码元称为M进制码元
- 1秒钟能够发送的码元的个数，叫做波特率，所以也叫码率
  - 每秒钟信号变化的次数

### 信道的极限容量
#### 数字信号通过实际的信道
任何实际的信道都不是理想的，都不可能以任意高的速率进行传送

在传输信号时会产生各种失真以及带来的多种干扰，失真的原因
- 信号传输的距离远
- 传输媒体质量差
- 噪声干扰
  - 环境干扰
  指大气干扰（如雷电、电离层闪烁等）、城区人为干扰（如工业、汽车干扰等）和非恶意邻道干扰等
  - 人为恶意干扰
  指带有恶意或敌意的人为干扰
- 码元传输的速率高（不可能以任意高的速率进行传送）

码元传输的速率越高，或信号传输的距离越远，或噪声干扰越大，或传输媒体质量越差，在接收端的波形的失真就越严重

限制码元在信道上的传输速率的两个因素：
- 信道能够通过的频率范围
- 信噪比

#### 信道能够通过的频率范围
具体的信道所能通过的频率范围总是有限的。信号中的许多高频分量往往不能通过信道

奈氏准则
- 在带宽为 W (Hz) 的低通信道中（无噪声、带宽受限）
- 码元传输的最高速率 = 2W(码元/秒)
- 传输速率超过此上限，就会出现严重的码间串扰的问题，使接收端对码元的判决（即识别）成为不可能

信道的频带越宽，也就是能够通过的信号高频分量越多，那么就可以用更高的速率传送码元而不出现码间串扰

码间串扰：接收端收到的信号波形失去了码元之间的清晰界限

奈氏准则给出了码元传输速率的限制，但是没有对信息传输速率给出限制

v进制码元情况下，理想低通信道下的极限数据传输率=2Wlog2 v (b/s)
#### 信噪比
噪声存在于所有电子设备和通信信道中，其影响是相对的

信噪比就是信号的平均功率和噪声的平均功率之比。常记为 S/N，并用分贝 (dB) 作为度量单位。即:
信噪比(dB) = 10 log10(S/N) (dB)

例如：当 S/N =10 时，信噪比为10dB，而当 S/N =1000 时，信噪比为30dB

##### 香农公式
1948年，香农(Shannon)用信息论的理论推导出了带宽受限且有高斯白噪声干扰的信道的极限、无差错的信息传输速率

信道的极限信息传输速率C可表达为

$$
C = W \log_2 \left( 1 + \frac{S}{M} \right) \quad \text{(bit/s)}
$$


其中
- W: 信道的带宽（Hz）
- S: 信道内所传信号的平均功率
- N: 信道内部的高斯噪声功率

香农公式表明：信道的带宽或信道中的信噪比越大，则信息的极限传输速率就越高

香农公式意义：只要信息传输速率低于信道的极限信息传输速率，就一定可以找到某种办法来实现无差错的传输

##### 奈氏准则和香农公式的意义不同
- 奈氏准则
激励工程人员不断探索更加先进的编码技术，使每一个码元携带更多比特的信息量
- 香农公式
告诫工程人员，在实际有噪声的信道上，不论采用多么复杂的编码技术，都不可能突破信息传输速率的绝对极限

## 物理层下面的传输媒体
### 导引型传输媒体
#### 双绞线
最古老但又最常用的传输媒体

把两根互相绝缘的铜导线并排放在一起，然后用规则的方法绞合 (twist) 起来就构成了双绞线

绞合度越高，可用的数据传输率越高

两大类
###### 无屏蔽双绞线 UTP(Unshielded Twisted Pair) 
- 无屏蔽层
- 价格较便宜
###### 屏蔽双绞线 STP(Shielded Twisted Pair)
- 带屏蔽层
- 都必须有接地线
- x/UTP：对整条双绞线电缆进行屏蔽
  - F/UTP (F=Foiled)：表明采用铝箔屏蔽层
  - S/UTP (S=braid Screen)：表明采用金属编织层进行屏蔽
  - SF/UTP：表明在铝箔屏蔽层外面再加上金属编织层的屏蔽
  - FTP 或 U/FTP：把电缆中的每一对双绞线都加上铝箔屏蔽层。U表明对整条电缆不另增加屏蔽层
  - F/FTP：在 FTP 基础上对整条电缆再加上铝箔屏蔽层
  - S/FTP：在 FTP 基础上对整条电缆再加上金属编织层的屏蔽
在抗干扰能力上，U/FTP 比 F/UTP 好，而 F/FTP 则是最好的

无论是哪种类别的双绞线，衰减都随频率的升高而增大

双绞线的最高速率还与数字信号的编码方法有很大的关系

#### 同轴电缆
由内导体铜质芯线（单股实心线或多股绞合线）、绝缘层、网状编织的外导体屏蔽层（也可以是单股的）以及保护塑料外层所组成

具有很好的抗干扰特性，被广泛用于传输较高速率的数据

已被双绞线和光纤取代

#### 光纤
光纤是光纤通信的传输媒体。通过传递光脉冲来进行通信。其传输带宽远远大于目前其他各种传输媒体的带宽

发送端：要有光源，在电脉冲的作用下能产生出光脉冲

光源：发光二极管，半导体激光器等

接收端：要有光检测器，利用光电二极管做成，在检测到光脉冲时还原出电脉冲

光波在纤芯中的传播
- 光纤通常由非常透明的石英玻璃拉成细丝，主要由纤芯和包层构成双层通信圆柱体。当光线从高折射率的媒体射向低折射率的媒体时，其折射角将大于入射角。如果入射角足够大，就会出现全反射，光也就沿着光纤传输下去
- 光线在纤芯中传输的方式是不断地全反射
##### 多模光纤 
- 可以存在多条不同角度入射的光线在一条光纤中传输
- 光脉冲在多模光纤中传输时会逐渐展宽，造成失真，只适合于近距离传输
##### 单模光纤
- 其直径减小到只有一个光的波长（几个微米），可使光线一直向前传播，而不会产生多次反射
- 制造成本较高，但衰耗较小
- 光源要使用昂贵的半导体激光器，不能使用较便宜的发光二极管

##### 光纤通信中使用的光波的波段
常用的三个波段的中心
- 850 nm
- 1300 nm
- 1550 nm

所有这三个波段都具有 25000~30000 GHz 的带宽，通信容量非常大
##### 光缆
必须将光纤做成很结实的光缆
- 数十至数百根光纤
- 加强芯和填充物
- 必要时还可放入远供电源线
- 最后加上包带层和外护套

使抗拉强度达到几公斤，完全可以满足工程施工的强度要求
##### 光纤优点
- 通信容量非常大
- 传输损耗小，中继距离长，对远距离传输特别经济
- 抗雷电和电磁干扰性能好
- 无串音干扰，保密性好，不易被窃听或截取数据
- 体积小，重量轻
现在已经非常广泛地应用在计算机网络、电信网络和有线电视网络的主干网络中
##### 光纤缺点
- 质地脆，机械强度差
- 连接困难
- 弯曲半径不能过小
- 分路、耦合不灵活
- 怕水

### 非导引型传输媒体
#### 概念
- 利用无线电波在自由空间的传播可较快地实现多种通信，因此将自由空间称为“非导引型传输媒体”
- 无线传输所使用的频段很广：LF ~ THF （30 kHz ~ 3000 GHz）
#### 无线电微波通信
占有特殊重要的地位

微波频率范围：
- 300 MHz-300 GHz（波长1 m - 1 mm）
- 主要使用：2 - 40 GHz
##### 在空间主要是直线传播
- 地球表面：传播距离受到限制，一般只有 50 km左右
- 100 m 高的天线塔：传播距离可增大到 100 km
##### 远距离微波通信：微波接力
微波接力：中继站把前一站送来的信号放大后再发送到下一站
#### 卫星通信
##### 同步卫星
- 通信容量大，通信距离远，通信比较稳定，通信费用与通信距离无关
- 但传播时延较大：在 250~300 ms之间
*注意：“卫星信道的传播时延较大”并不等于“用卫星信道传送数据的时延较大”*
- 保密性相对较差。造价较高
- 成功案例
  - 中国北斗卫星导航系统（BDS）
  - 美国全球定位系统（GPS）
  - 俄罗斯全球卫星导航系统（GLONASS）
  - 欧盟伽利略卫星导航系统（Galileo satellite navigation system）
##### 低轨道卫星
低轨道卫星通信系统（卫星高度在 2000 公里以下）已开始使用。目前，大功率、大容量、低轨道宽带卫星已开始在空间部署，并构成了空间高速链路
###### 应用案例
- 铱星系统（破产）
- 全球星系统
- 空中因特网系统
- 星联互联网系统
- 鸿雁全球卫星通信系统（在建）

## 信道复用技术
### 频分复用、时分复用和统计时分复用
#### 复用 (multiplexing) 
允许用户使用一个共享信道进行通信
#### 为什么要信道复用
- 信道资源是有限的，实际网络中，多对用户往往需要利用相同的信道资源传输信息
- 不同的信号同时在同一信道中传输会产生严重的互相干扰，导致传输失败
#### 什么是信道复用
- 多路复用技术
把多个信号组合在一条物理信道上进行运输，使得多个计算机或终端设备共享信道资源，提高信道利用率
- 允许用户使用一个共享信道进行通信，降低成本，提高利用率
- 将使用介质的每个设备与来自同一信道上的其他设备的通信隔离开，把时域和频域资源合理地分配给网络上的设备
#### 频分复用 FDM (Frequency Division Multiplexing) 
- 将整个带宽分为多份，用户在分配到一定的频带后，在通信过程中自始至终都占用这个频带
- 所有用户在同样的时间占用不同的带宽（即频带）资源
- 总频带宽度大于各子信道频率之和，各子信道传输的信号以并行方式工作。广播、有线电视等
- 充分利用带宽 ，效率高，易实现
- 可以让N个用户各使用一个频带，或者让更多的用户轮流使用这N个频带。这种方式称为频分多址接入FDMA（Frequency Division Multiple Access），简称频分多址
#### 时分复用 TDM (Time Division Multiplexing)
- 将时间划分为一段段等长的时分复用帧（TDM帧）
- 每一路信号在每一个 TDM 帧中占用固定序号的时隙
- 每一路信号所占用的时隙是周期性地出现（其周期就是TDM帧的长度）的
- TDM 信号也称为等时 (isochronous) 信号
- 所有用户在不同的时间占用同样的频带宽度
- 可以让N个用户各使用一个时隙，或者让更多的用户轮流使用这N个时隙。这种方式称为时分多址接入TDMA（Time Division Multiple Access），简称时分多址
- 由于计算机数据有突发性，时分复用会导致信道利用率不高
  - 当用户暂时无数据发送时，分配给该用户的时隙只能处于空闲状态
#### 统计时分复用 STDM  (Statistic TDM)
- 数据发往复用器，复用器按顺序扫描，把复用器中的数据放入STDM帧中，一个STDM帧满了就发出
- STDM 帧不是固定分配时隙，而是按需动态地分配时隙，因此可以提高线路的利用率

### 波分复用WDM (Wavelength Division Multiplexing)
波分复用就是光的频分复用。将两种或多种不同波长的光载波信号，在发送端经复用器把这些光载波信号汇合在一起使用一根光纤来同时传输多个光载波信号

### 码分复用CDM (Code Division Multiplexing) 
#### 概念
- 每一个用户可以在同样的时间使用同样的频带进行通信
- 各用户使用经过特殊挑选的不同码型，因此不会造成干扰
- 当码分复用 CDM (Code Division Multiplexing) 信道为多个不同地址的用户所共享时，就称为码分多址 CDMA (Code Division Multiple Access)
#### 码分多址 CDMA (Code Division Multiple Access)工作原理
- 将每一个比特时间划分为 m 个短的间隔，称为码片 (chip)
- 为每个站指派一个唯一的 m bit 码片序列
  - 发送比特 1：发送自己的 m bit 码片序列
  - 发送比特 0：发送该码片序列的二进制反码

例如：S 站的 8 bit 码片序列是 00011011
- 1------>00011011
- 0------>11100100
- 码片序列：(–1 –1 –1 +1 +1 –1 +1 +1) 

要发送的信息的数据率=b bit/s，实际发送的数据率=mb bit/s，同时，所占用频带宽度也提高到原来的m倍，码片序列实现了扩频

#### 码分多址CDMA 的重要特点
- 每个站分配的码片序列：各不相同，且必须互相正交 (orthogonal)
- 正交：向量 S 和 T 的规格化内积 (inner product) 等于 0 


$$
S \cdot T = \frac{1}{m} \sum_{i=1}^{m} S_i T_i = 0
$$


- 任何一个码片向量和该码片向量自己的规格化内积都是1


$$
S \cdot S = \frac{1}{m} \sum_{i=1}^{m} S_i S_i = \frac{1}{m} \sum_{i=1}^{m} S_i^2 = \frac{1}{m} \sum_{i=1}^{m} (\pm 1)^2 = 1
$$


- 一个码片向量和该码片反码的向量的规格化内积值是–1


$$
S \cdot S = -1
$$


## 使用广播信道的数据链路层
### 局域网的数据链路层
#### 局域网最主要的特点
- 网络为一个单位所拥有
- 地理范围和站点数目均有限
#### 局域网具有如下主要优点
- 具有广播功能，从一个站点可很方便地访问全网
- 便于系统的扩展和逐渐地演变，各设备的位置可灵活调整和改变
- 提高了系统的可靠性、可用性和生存性

#### 局域网拓扑结构
##### 星形网
现在的局域网基本都是星形网
##### 环形网
##### 总线网

#### 广播信道面临的问题
可能两个（或更多）站点同时请求占用信道
##### 解决办法
介质的多路访问控制，在多路访问信道上确定下一个使用者（信道分配）

#### 介质访问控制的方法
分配信道，媒体共享技术
##### 静态分配
##### 动态分配

#### 媒体共享技术
##### 静态划分信道
频分复用、时分复用、波分复用、码分复用
- 适用于通信量大且流量稳定的情况、用户数量少且用户数目固定的情况
- 代价高，不适合突发性业务，不适合局域网
##### 动态媒体接入控制（多点接入）
###### 随机接入
所有的用户可随机地发送信息（以太网）
###### 受控接入
用户必须服从一定的控制，如轮询（polling）

### 以太网（Ethernet）
#### 以太网的运用领域
- 企业/校园的数据中心
- 服务提供商（移动网/固网）
- 云服务提供商（超大规模数据中心）
- 自动化（建筑与工业）
- 汽车（车载网络）等

#### 以太网的两个标准
##### DIX Ethernet V2
世界上第一个局域网产品（以太网）的规约

##### IEEE 802.3
第一个 IEEE 的以太网标准。数据链路层分为2个子层
- 逻辑链路控制 LLC (Logical Link Control) 子层
与传输媒体无关
- 媒体接入控制 MAC (Medium Access Control) 子层
与传输媒体有关
##### 两个标准的区别
- 这两种标准的硬件实现可以在同一个局域网上互操作
- 这两个标准标准只有很小的差别，因此很多人也常把 802.3局域网简称为“以太网”
##### IEEE 802.3现状
- 现在802委员会制定的逻辑链路控制子层LLC（即802.2标准）的作用已经不大了
- 很多厂商生产的适配器（即电脑网卡）上就仅装有MAC协议，而没有LLC协议

#### 适配器的作用
##### 计算机通过适配器和局域网进行通信
- 计算机的CPU和存储器与适配器之间并行通信，生成发送的数据，处理收到的数据
- 计算机通过适配器和局域网进行串行通信，适配器把帧发送到局域网，从局域网接收帧
##### 适配器的重要功能
- 进行串行/并行转换
- 对数据进行缓存
- 在计算机的操作系统安装设备驱动程序
- 实现以太网协议

**现在的网卡，除非专门标明，否则都是以太网卡**

#### 以太网采取的2种重要措施
##### 采用较为灵活的无连接的工作方式
- 不必先建立连接就可以直接发送数据
- 对发送的数据帧不进行编号，也不要求对方发回确认
- 提供不可靠的、尽最大努力的交付服务
- 差错帧是否重传由高层决定（一般是运输层决定）
##### 发送的数据都使用曼彻斯特 (Manchester) 编码
- 曼彻斯特编码优点
便于同步
- 曼彻斯特编码缺点
所占的频带宽度比原始的基带信号增加了一倍

#### 总线型以太网的工作特点
##### 最早的以太网
将许多计算机都连接到一根总线上
##### 总线特点
易于实现广播通信，简单，可靠

为了在广播特性的总线上实现一对一通信，将接收站的硬件地址写入帧首部中的目的地址字段中。仅当数据帧中的目的地址与适配器硬件地址一致时，才能接收这个数据帧

##### 总线缺点
多个站点同时发送时，会产生发送碰撞或冲突（翻译不同，都是conflict），导致发送失败

要实现多个用户同时发送数据，需要在以太网上实现动态媒体接入控制

#### 信号在信道/传输介质上传输
- 信号在传输的过程中，可以看成由很多不同频率的分量的传输，因为高频分量的不等量衰减，接收方收到的信号是衰减和变形(失真)的
- 一般来说，从0-fc这一频段，振幅在传输过程不会明显衰减，fc称为截止频率。（单位：赫兹）

#### 物理带宽
传输过程中振幅不会明显衰减的频率范围
- 单位：赫兹
- 是一种物理特性，通常取决于介质材料的构成、厚度、长度等
#### 数字带宽
单位时间内流经的信息总量

#### 数字带宽和物理带宽之间的关系
##### 奈奎斯特定理----理想信道
描述了在无噪声信道中，当物理带宽为B Hz，信号离散等级为V级，那么该信道能提供的最大传输速率（数字带宽）可用这个公式表达：
最大传输速率 = 2Blog2V （bps）

其中： V为信号的离散等级
- 奈奎斯特证明，任意一个信号通过了一个物理带宽为B的低通滤波器，那么只要进行每秒2B次的采样，就可以完全重构出被滤掉的信号。任何高于2B次的采样都毫无意义
- 从上面的公式，可以看出，要想增加最大传输率即数字带宽，只有增加物理带宽或离散等级，但是物理带宽是物理特性，不可能随意增加；只能增加离散等级

##### 香农定理----有噪声的信道
在噪声信道中，如果物理带宽为 B Hz，信噪比为S/N，那么最大的传输速率（数字带宽）
最大传输速率=Blog2(1+S/N) （bps）
- 很多情况下噪声用分贝(dB) 表示
如：噪声为30dB（分贝），则信噪比为S/N=1000，分贝值跟S/N之间的换算关系用这个公式表示：
分贝值=10log10 S/N (db)

**香农定理说明，在信道一定的时候，物理带宽确定了，要想提高最大数据传输率（数字带宽），只能增加信噪比**

采用技术手段，是否可以无限制地提高一个信道的传输速率（数字带宽）呢？
- 答案：不能

### 引导性传输介质
物理层的功能是搬运比特，承载比特的就是传输介质
传输介质是多种多样的。按照是否有形，其分为引导性（有线）传输介质和非引导性（无线）
传输介质两大类
#### 引导性（有线）传输介质包括
- 铜线
  - 同轴电缆
  - 双绞线
- 光纤
#### 非引导性（无线）传输介质
无线电、卫星等

#### 同轴电缆
由中心导体、绝缘材料层、网状导体、外部绝缘料4层组成，主要有两类
##### 基带同轴电缆
50Ω，用于数字传输（屏蔽层为铜）
##### 宽带同轴电缆
75Ω，用于模拟传输（屏蔽层为铝）

根据同轴电缆的粗细，分为
##### 粗缆
- 最大传输距离为500米
- 两端安装终结器，以保证电缆屏蔽层接地
##### 细缆(0.35cm)：
- 最大传输距离为185米
- 两头安装BNC头，接在T型连接器两端

#### 双绞线（Twist Pair Cable）
- 铜线的一种
- 由两根具有绝缘层的铜导线按一定密度，逆时针方向绞合而成
  - 消除：近端串扰 Crosstalk
- 绞距（扭距）
一般地，绞距越紧（小），越均匀，则抵销效果越好，传输性能越好

双绞线主要分为两种
##### 非屏蔽双绞线（UTP：Unshielded Twisted Pair）
- 5类双绞线，提供10M、100M的数字带宽，使用了其中的两对线，分别用于收、发
- 1000M以太网中，用到了全部的4对线
- 最大传输距离100米，广泛用于局域网中
- 数字带宽： 10-100Mbps
- 成本：便宜
- 介质和连接器大小：小，轻便
- 最大传输距离:100米(短)

###### 优点
- 成本低
- 尺寸小
- 易于安装
###### 缺点
- 易受干扰
- 传输距离性能受到绞距影响
##### 屏蔽双绞线（STP：Shielded Twisted Pair）
- 相比UTP，STP加了两层屏蔽层，分别位于每对线之外和全部4对线之外
- 数字带宽：10-100Mbps
- 成本：比UTP贵
- 介质和连接器大小：中等偏大
- 最大传输距离：100米(短)

###### 优点
- 抗EMI/RFI干扰
###### 缺点
- 成本高
- 安装不易
##### 折中方案：网屏式双绞线（ScTP：Screened Twisted Pair）
- 主要技术参数不变，在成本和抗干扰之间做了折中
- 数字带宽： 10-100Mbps
- 成本：介于UTP和STP之间
- 介质和连接器尺寸：中等
- 最大传输距离：100米(short)


##### UTP的注意事项
- 在局域网中，使用最多的是UTP
- 只用了其中的12、36线对
- 线序：水晶头面向自己，从左到右数起，1、2、3...

##### 直通线 VS 交叉线
- 当用作直通线（比如，连接交换机和PC）时，线两头的线序一致，不一致时，则用作交叉线（比如，连接两台路由器）
- 现在直通线和交叉线不再重要，可以自适应

#### 光纤
##### 基本概念
- 光纤是光导纤维的简称
- 由极细的玻璃纤维构成，把光封闭在其中并沿轴向进行传播
- 一根光纤，由内而外，由极细的玻璃芯（微米级）、玻璃覆盖层和槊料封套构成。玻璃覆盖层的折射率比玻璃芯低，以保证光都被限制在玻璃芯内
##### 光纤工作原理
全反射：当光从光密物质射向光疏物质，入射角大于临界角时，光发生全反射，光全部被锁闭在光密物质中，全反射前行

光纤能否弯曲？
- 答案：可以，但是需遵循标准

##### 光纤的优点
- 重量轻
- 损耗低
- 不受电磁辐射干扰
- 传输频带宽、通信容量大
##### 光纤的缺点
昂贵、易断裂

光纤通常以光缆的形式存在

##### 光纤的分类
###### 单模
以单一模式传输，激光产生的单束光，纤心细、高带宽、长距离，运行波长为850nm或1300nm
###### 多模
以多个模式同时传输，LED产生的多束光，纤心粗、低带宽、短距离，运行波长为1310nm或1550nm
##### 光源
- 光传输系统组成：光源、传输介质（光纤）和探测器构成
- 有两种光源：LED和激光
##### 光纤的常用规格
###### 规格
- 单模：8.3/125μm
- 多模：62.5/125μm
###### 光纤接口
- SC：方形
- ST：圆形
###### 光缆常埋在地下管沟，或海底
##### 光纤连接方法
光纤断了怎么办
光纤连接方法
- 光纤连接器（光损失10%~20%）
- 机械拼接，特殊的套管夹紧（光损失10%）
- 熔合（几乎无损失）
##### 光纤相对铜线的特性
- 带宽高，距离远，损耗低
- 重量轻
- 无电磁干扰和射频干扰（EMI和RFI），防窃听
- 端口设备价格高

#### 怎样选择传输介质
- 传输速率
- 成本要求
- 周围环境
- 介质间的互操作性、相容性
- 最优的性价比

#### 光纤和UTP具有各自的特点
- 到用户桌面的线缆大量使用UTP（水平电缆）
- 干线上大量使用光纤（垂直电缆）

### 复用技术
#### 复用技术概念
- 复用技术是让多用户共享同一根信道（干线）
- 复用技术是用在干线上的技术，它要解决干线起点如何共用，干线终点如何分离的问题
#### 频分多路复用FDM（Frequency Division Multiplexing）
##### FDM原理
- 在干线起点，信道的频谱被分成若干段（子带），每个用户占据一段来传输自己的信号
- 到了干线的终点，每个子带的信号被单独分离出来给各个用户
- 相邻用户使用的频段（子带）之间，通常留有一定的带宽，以免混淆，这个频段被称作保护带

#### 正交FDM：Orthogonal FDM（简称OFDM）
- 是一种更好地利用带宽的FDM叫正交频分多路复用OFDM
- OFDM没有了保护带，且子带之间相互重叠；同样的干线可以承载更多的用户
- OFDM 已被广泛用于802.11、有线电视网络等

#### 波分多路复用WDM (Wavelength Division Multiplexing)
- WDM本质跟FDM一样，在光纤上复用信号
- 按照不同的波长，干线分成了若干份，承载了不同用户的光信号，到了终点，分离器分离出不同波长的光信号
- 当相邻波长间隔非常接近，子信道的数目非常大，WDM变成了DWDM（Dense，密集波分多路复用）
#### 时分多路复用TDM（Time Division Multiplexing）
- 在时间上共享信道：将时间划分为非常短的时间片，每个用户周期性地在自己的时间片内使用整个带宽
- 广泛用于 电话系统和蜂窝系统系统
- TDM要求时间上必须同步，为了适应时钟的微小变化，可能要求增加保护时间间隔
- 如果各用户需要的带宽不均衡，有的需要多，有的需要很少，而TDM用户时间片的使用却是一样的，将造成信道的浪费，不高效
#### 统计时分多路复用技术Statistic TDM（STDM）
- 统计时分多路复用技术是为了提高信道的利用率
- 动态分配信道，不使用信道的用户不分配，分给有需要的用户使用，利用率可提高2~4倍（按需分配）
- 实现技术较复杂，通常只在高速远程通信中使用，如ATM
- 用户平均使用信道的情况不适用

#### 码分多路复用技术CDMA （Code Division Multiple Access）
还有一种完全不同于FDM和TDM的复用技术叫码分多路复用技术，也是扩展频谱技术
##### 来历
- 1942年，明星海蒂拉玛和她的作曲家丈夫拉塞尔受钢琴启发，提出
- 二战后，被军方封存
- 直到1985年，高通公司以此为基础，开发了CDMA，广泛应用于3G

CDMA允许每个站利用整个频段发送信号，而且没有任何时间限制

打个比喻：许多人在两两交谈，TDM可以看成是许多人在大厅里按照顺序交谈；FDM可以看成是不同的人按照不同的语调同时进行交谈

而CDMA可以看成是每对交谈者使用不同的语言，有讲中文的、英文的、法语的，讲中文的只听见中文，其它语言对他来说就是噪声

CDMA的关键在于：能够提取出需要的信号，同时拒绝所有其它的信号，并把这些信号当作噪声

在CDMA中，每个比特时间被细分成m个更短的时间间隔，这更短的时间间隔被称为码片；通常地，每个比特被分为64或128

假如一个m=4的CDMA系统，每个工作站/用户分配一个唯一的码片序列（用双极符号表示），所有的码片序列两两正交，即归一化内积为零

当一个工作站要发送“1”时，就发送它的时间序列，当它要发送“0”时，就发送它时间序列的反码

为了知道某个站发送的是什么，接收方必须知道发送方的码片序列，，只要计算复用信号和发方码片序列的归一化内积

**码片序列是正交的，能够同时传输**
*广泛用于3G网通信*

### 调制技术
#### 数字调制
调制机制使用信号来传输比特
##### Baseband Transmission（基带传输）
信号的传输占据了传输介质从零到最大值之间的全部频率。这是有线传输介质普遍采用的一种方法，比如以太网
##### Passband Transmission（通带传输）
通过调节信号的振幅、相位或频率来传输比特
特点：信号占据了以载波信号频率为中心的一段频带
#### 基带传输
- 直接将数据比特转化为信号，比如用高电压表示1，低电压表示0
- 实际上，出于工程考虑，很少采用这样简单的方式，需要更复杂的表示方法
- 这就是Line codes（线路编码）：发送 symbols（样本、符号），一个样本可传送1个或多个比特

#### 通带传输
一般情况下，在一个信道上发送信息所使用的频率范围并不是从零开始的，而是在某个频段上通过调节信号的振幅、相位或频率来传输比特。这就是通带传输
- 单独采用上述调制方法，一个符号只有两种形式或两个级别，即一个符号只能传输一个比特
- 为了获得更高的数据传输速率，即数字带宽，可以把上述这些调制模式综合起来使用，以便让获得更多的信号模式，使每个符号传输更多的比特，即增加公式中的 n，从而增加传输速率。因为当物理带宽一定的时候，采样率也一定了，只能增加n


#### 信号星座
不同的基本调制方法的组合
- 可以用星图座来表示某种调制方式中 信号的呈现模式
- 例如：QAM-16，QAM是正交振幅调制的英文缩写，16代表这种调制方式中有16种不同振幅和相位的信号组合模式，也意味着一个符号可以传输4个比特
- 在正交相移键控QPSK中，使用了4个相位角度，每次采样（码元、样本）可表达的级别有4个，即每次码元可表示2比特
- QAM-64 (正交振幅调制，Quadratrue AmplitudeModulation-64) 允许 64 个不同的信号组合，即64个信号级别, 所以每个码元可传输6 bits


#### 波特率（Baud rate）
波特率即每秒钟信号变化的次数，也叫符号率、采样率
#### 比特率
比特率（位传输率、数据传输速率、数字带宽）与波特率的关系是：

$$
C = B \times \log_2 n
$$


其中:
- C：比特率
- B：波特率；
- n：信号呈现的个数，为2的整数倍（有例外）


#### 格子架编码调制（TCM）
- 为了追求高的数字带宽，总是想办法提高信号级别，即星号星座图上的星点密密分布，但是，这导致出错率的上升
- 为了降低高速调制错误，在每个样本中采用一些额外的位用作纠错，剩下的位才用来传输数据，这种机制叫格子架编码调制TCM (Trellis Coded Modulation)
- 例如，在 V.32调制标准中，波特率是2400，采用了QAM-32，每码元传输5个比特，但其中的1个比特用来做奇偶校验，所以，只有4个比特用于传输数据，那么根据公式，数据传输率只有2400*4=9600bps


# 数据链路层(Data Link Layer)
## 数据链路层概述
### 为什么需要数据链路层
物理层解决了相邻结点透明传输比特的问题

而数据链路层主要解决以下问题
- 如何在比特流中找到一组数据的开始和结束位置
- 线路上有多个设备的时候，比特流应由谁接收
- 比特传输错误怎么办

### 数据链路相关概念
#### 链路（Link）
链路（Link）是节点间的物理通道，无源的物理线路，中间无任何其他交换节点
#### 数据链路（Data Link）
数据链路（Data Link）是节点间的逻辑通道，是把实现控制数据传输的协议的硬件和软件加到链路上，即链路+协议
#### 数据链路层
数据链路层负责通过一条链路从一个节点向物理链路直接相连的相邻节点传送帧
#### 帧（frame）
数据链路层协议数据单元，封装网络层的数据报
### 从协议栈看数据链路层
- 数据链路层不必考虑物理层如何实现比特传输的细节
- 向下----利用物理层提供的位流服务
- 向上----向网络层提供明确的（well-defined）服务接口

### 数据链路层信道类型
#### 点对点信道
一对一的通信方式，主要在网络核心骨干节点使用
#### 广播信道
一对多的通信方式
链路中通信双方的信道使用形式不同，会相应有不同的控制协议


## 三个基本问题
### 封装成帧
#### 概念
##### 封装成帧 (framing)
在一段数据的前后分别添加首部和尾部，构成一个帧

首部和尾部的一个重要作用就是进行帧定界（即确定帧的界限）

将比特流划分成“帧”的主要目的是为了检测和纠正物理层在比特传输中可能出现的错误

IP数据报---->帧：帧首部---帧的数据部分（Payload）---帧尾部

数据链路层的帧长度=帧首部长度+帧的数据部分长度+帧尾部长度
#### 最大传送单元MTU(Maximum Transfer Unit)
规定了所能传送的帧的数据部分长度上限
#### 关键问题：如何标识一个帧的开始？
- 接收方必须能从物理层接收的比特流中明确区分出一帧的开始和结束，这个问题被称为帧同步或帧定界
- 关键：选择何种定界符，定界符出现在数据部分如何处理
#### 成帧（framing）的方式
##### 字节计数法（byte count）
有效负载以可变长度字符块的形式传输，前面有字符计数

只要有一个计数位出现错误，就会破坏帧的边界，导致一连串帧的错误

##### 带字节填充的定界符法/字节填充法（byte stuffing）
用控制字符作为帧定界符
- 控制字符 SOH (Start Of Header) 放在一帧的最前面，表示帧的首部开始
- 控制字符 EOT (End Of Transmission) 放在一帧的末尾，表示帧的结束
- 如果数据中的某个字节的二进制代码恰好和SOH或EOT一样，数据链路层就会错误地“找到帧的边界”，导致错误，解决方法见后面的透明传输
##### 带比特填充的定界符法/比特填充法（bit stuffing）
使用特殊比特序列作为帧的开始，遇到数据部分与比特填充定界符相同时，采用比特填充法实现透明传输
##### 物理层编码违例
使用特殊的定界符，保证在正常的编码中不太容易产生或不会产生相应的信号，例如以太网中的帧前导码、差分曼彻斯特编码的不正常跳变信号等
### 透明传输
#### 概念
##### 透明
指某一个实际存在的事物看起来却好像不存在一样
##### “在数据链路层透明传送数据”
表示：无论发送什么样的比特组合的数据，这些数据都能够按照原样没有差错地通过这个数据链路层
#### 用“字节填充”或“字符填充”法实现透明传输
- 发送方采用“字节填充”或“字符填充”法发送帧时，如果内容中有的数据与帧开始符或帧结束符相同时，在它的前面增加一个特殊的符号作为填充符，例如ESC
- 接收方逐个字节检查，遇到填充符则不会将后续字符认作帧首和帧尾，而是去掉填充符，继续接收数据
#### 用比特填充法实现透明传输
- 使用特殊位序列结束帧：01111110，即在末尾增加此结束帧
- 发送方：如果消息体中已经发送了连续五个1，则插入一个0
- 接收方：如果连续五个 1 到达，则查看下一位：
  - 如果下一位是 0----将0删除
  - 如果接下来的位是 10----找到帧结束标记
  - 如果接下来的位是 11----出现错误
### 差错控制（Error handling）
- 噪声会导致数据在传输过程中可能产生比特差错
- 在一段时间内，传输错误的比特占所传输比特总数的比率称为误码率 BER (Bit Error Rate)，与信噪比有关
- 为确保帧的正确传输，数据链路层需要进行差错检验
#### 纠错码（error-correcting code）
主要用于错误发生比较频繁的信道上，如无线链路
##### 海明码（Hamming code）
#### 检错码（error-detecting code）
主要用在高可靠、误码率较低的信道上，例如光纤链路
##### 奇偶性校验（Parity bit）
- 在数据最后增加一位比特，进行奇偶性校验
- 可以检测单个位的错误,但是无法检测出是哪一位出了错误
- 无法检测两位错误
- 机器可以通过对所有位进行异或来检查位序列中是否有偶数/奇数个 1：
偶数 = 0
奇数 = 1
**异或算法：0^0=1；0^1=1;1^0=1;1^1=0**

##### 校验和（Checksum）
- 校验和对数据帧内的一系列数字执行数学计算，并将结果记录在标头中
- 接收者将重复计算并将结果与传输的值进行比较
- 用于错误检测

#### 广泛应用的两种校验检错码算法
互联网校验和（IP 协议的一部分 - 网络层）（Internet checksum）

##### CRC（循环冗余校验——数据链路层）（Cyclic Redundant Check）
###### CRC原理
- 在发送端，先把数据划分为组。假定每组 k 个比特 
- CRC 运算在每组 M 后面再添加供差错检测用的 n 位冗余码，然后构成一个帧发送出去。一共发送 (k + n) 位
###### CRC 冗余码的计算
- 第1步：用二进制的模 2 运算进行 2^n 乘 M 的运算，这相当于在 M 后面添加 n 个 0
- 第2步：得到的 (k + n) 位的数除以事先选定好的长度为 (n + 1) 位的除数 P，得出商是 Q ，余数是 R，余数 R 比除数 P 少 1 位，即 R 是 n 位 
- 第3步：将余数 R 作为冗余码拼接在数据 M 后面，一起发送出去
###### 帧检验序列 FCS(Frame Check Sequence)
- 在数据后面添加上的冗余码称为帧检验序列 FCS (Frame Check Sequence)
- 循环冗余检验 CRC 和帧检验序列 FCS 并不等同
  - CRC 是一种常用的检错方法，而 FCS 是添加在数据后面的冗余码
  - FCS 可以用 CRC 这种方法得出，但 CRC 并非用来获得 FCS 的唯一方法
###### 广泛使用的生成多项式P(X)
- CRC-16 = X16 +X15 + X2 + 1
- CRC-CCITT = X16 +X12 + X5 + 1
- CRC-32 = X32 +X26 + X23 + X22 + X16 +X12 + X11 +X10 + X8 +X7+ X5 +X4 + X2 + X + 1

注意
- 仅用循环冗余检验 CRC 差错检测技术只能做到无差错接受 (accept)
- 即：“凡是接受的帧（即不包括丢弃的帧），我们都能以非常接近于 1 的概率认为这些帧在传输过程中没有产生差错”
- 即：“凡是接收端数据链路层接受的帧均无差错”

**注意：“无比特差错”与“无传输差错”是不同的
- 可靠传输：数据链路层的发送端发送什么，在接收端就收到什么
- 传输差错可分为两大类：
  - 比特差错
  - 传输差错：帧丢失、帧重复或帧失序等
- 在数据链路层使用 CRC 检验，能够实现无比特差错的传输，但这还不是可靠传输
- 要做到可靠传输，还必须再加上帧编号、确认和重传等机制

## 点对点协议 PPP
### PPP 协议的特点
- 对于点对点的链路，目前使用得最广泛的数据链路层协议是点对点协议 PPP (Point-to-Point Protocol)
- PPP 协议在 1994 年就已成为互联网的正式标准 [RFC 1661, STD51]
### PPP 协议应满足的需求
- 简单
首要要求
- 封装成帧
必须规定特殊的字符作为帧定界符
- 透明性
必须保证数据传输的透明性
- 多种网络层协议
能够在同一条物理链路上同时支持多种网络层协议
- 多种类型链路
能够在多种类型的链路上运行
- 差错检测
能够对接收端收到的帧进行检测，并立即丢弃有差错的帧
- 检测连接状态
能够及时自动检测出链路是否处于正常工作状态
- 最大传送单元
必须对每一种类型的点对点链路设置最大传送单元  MTU 的标准默认值，促进各种实现之间的互操作性
- 网络层地址协商
必须提供一种机制使通信的两个网络层实体能够通过协商知道或能够配置彼此的网络层地址
- 数据压缩协商
必须提供一种方法来协商使用数据压缩算法
### PPP 协议的组成
#### 三个组成部分
- 一个将 IP 数据报封装到串行链路的方法
- 一个链路控制协议 LCP (Link Control Protocol)
- 一套网络控制协议 NCP (Network Control Protocol)
### 透明传输问题 
- 当 PPP 用在异步传输时，使用字节填充法
- 当 PPP 用在同步传输链路时，采用比特填充法

## 使用广播信道的数据链路层
### 局域网的数据链路层
#### 局域网最主要的特点
- 网络为一个单位所拥有
- 地理范围和站点数目均有限 
#### 局域网具有如下主要优点
- 具有广播功能，从一个站点可很方便地访问全网。
- 便于系统的扩展和逐渐地演变，各设备的位置可灵活调整和改变
- 提高了系统的可靠性、可用性和生存性
#### 局域网拓扑结构
##### 星形网
现在绝大多数局域网都使用星形网
##### 总线网
##### 环形网
#### 广播信道面临的问题
可能两个（或更多）站点同时请求占用信道
##### 解决方法
介质的多路访问控制，在多路访问信道上确定下一个使用者（信道分配）
#### 媒体共享技术
##### 静态划分信道
- 频分复用
- 时分复用
- 波分复用
- 码分复用 
*静态划分信道适用于通信量大且流量稳定的情况、用户数量少且用户数目固定的情况*
*静态划分信道代价高，不适合突发性业务，不适合局域网*
##### 动态媒体接入控制（多点接入）
###### 随机接入
所有的用户可随机地发送信息（以太网）
###### 受控接入
用户必须服从一定的控制。如轮询(polling)
#### 以太网的适用领域
- 企业/校园的数据中心
- 服务提供商（移动网/固网）
- 云服务提供商（超大规模数据中心）
- 自动化（建筑与工业）
- 汽车（车载网络）等
#### 以太网的两个标准
##### DIX Ethernet V2
世界上第一个局域网产品（以太网）的规约
##### IEEE 802.3
第一个 IEEE 的以太网标准，数据链路层分为2个子层
- 逻辑链路控制 LLC (Logical Link Control) 子层：与传输媒体无关
- 媒体接入控制 MAC (Medium Access Control) 子层：与传输媒体有关
**现在802委员会制定的逻辑链路控制子层LIC（即802.2标准）的作用已经不大了**
**很多厂商生产的适配器（网卡）上就仅装有MAC协议，而没有LLC协议**

**这两种标准的硬件实现可以在同一个局域网上互操作**
**这两个标准标准只有很小的差别，因此很多人也常把 802.3局域网简称为“以太网”**
#### 适配器
##### 适配器的作用
计算机通过适配器和局域网进行通信
- CPU和存储器生成发送的数据和处理收到的数据，与适配器（网卡）之间是并行通信，CPU和存储器使用IP地址
- 适配器（网卡）把帧发送到局域网和从局域网接收帧，适配器与局域网之间是串行通信，适配器（网卡）使用MAC地址
##### 适配器的重要功能
- 进行串行/并行转换
- 对数据进行缓存
- 在计算机的操作系统安装设备驱动程序
- 实现以太网协议
#### 以太网采取的 2 种重要措施
##### 采用较为灵活的无连接的工作方式
- 不必先建立连接就可以直接发送数据
- 对发送的数据帧不进行编号，也不要求对方发回确认
- 提供不可靠的、尽最大努力的交付服务
- 差错帧是否重传由高层决定

发送的数据都使用曼彻斯特 (Manchester) 编码，便于同步
- 曼彻斯特编码缺点：所占的频带宽度比原始的基带信号增加了一倍
#### 总线型以太网的工作特点
- 最早的以太网：将许多计算机都连接到一根总线上
- 总线特点：易于实现广播通信，简单，可靠
- 为了在广播特性的总线上实现一对一通信，将接收站的硬件地址写入帧首部中的目的地址字段中。仅当数据帧中的目的地址与适配器硬件地址一致时，才能接收这个数据帧
##### 总线缺点
多个站点同时发送时，会产生发送碰撞或冲突（同一个英语单词collision），导致发送失败

需要在以太网实现动态媒体接入控制

### CSMA/CD 协议
#### CSMA/CD (Carrier Sense Multiple Access with Collision Detection)
载波监听多点接入 / 碰撞检测
##### 多点接入
说明这是总线型网络。许多计算机以多点接入的方式连接在一根总线上
##### 载波监听
即“边发送边监听”。不管在想要发送数据之前，还是在发送数据之中，每个站都必须不停地检测信道
##### 碰撞检测
适配器边发送数据，边检测信道上的信号电压的变化情况。电压摆动值超过一定的门限值时，就认为总线上至少有两个站同时在发送数据，表明产生了碰撞（或冲突）

#### 检测到碰撞后
- 适配器立即停止发送
- 等待一段随机时间后再次发送

Q1：既然发送前已经监听过信道，为什么还要进行碰撞检测？
A: 因为信号有传播时延，监听信道空闲，但信道可能并非真正空闲
- 传播时延记为τ
- B在A信号还差δ时间到达前发送数据
- B在τ时间检测到发生碰撞
- A在2τ-δ时间检测到发生碰撞

每一个站在自己发送数据未到达终点之前，都存在着遭遇碰撞的可能性

A从发送信号到下一次接收到信号，才能检测到与B的发送产生了冲突

Q2：A发送数据后，至少要在多少时间内收到数据才说明没有碰撞？
A: 以太网的端到端往返时延 2τ 称为争用期，或碰撞窗口
- 具体的争用期时间 = 51.2 μs
- 经过争用期这段时间还没有检测到碰撞，才能肯定这次发送不会发生碰撞
#### 碰撞后重传的时机
- 采用截断二进制指数退避 (truncated binary exponential backoff) 确定
- 发生碰撞的站停止发送数据后，要退避一个随机时间后再发送数据
  - 基本退避时间 = 2 
  - 从整数集合 [0, 1, … , (2k - 1)] 中随机地取出一个数，记为 r 。重传所需的时延 =  r ⅹ 基本退避时间
  - 参数 k = Min[重传次数, 10]
  - 当重传达 16 次仍不能成功时即丢弃该帧，并向高层报告
##### 例如：
第 1 次冲突重传时：
k = 1，r  为 {0，1} 集合中的任何一个数

第 2 次冲突重传时：
k = 2，r  为 {0，1，2，3} 集合中的任何一个数

第 3 次冲突重传时：
k = 3，r  为 {0，1，2，3，4，5，6，7} 集合中的任何一个数

若连续多次发生冲突，表明可能有较多的站参与争用信道

上述退避算法可使重传需要推迟的平均时间随重传次数而增大（称为动态退避），因而减小发生碰撞的概率，有利于整个系统的稳定

#### 10 Mbit/s 以太网争用期的长度
争用期的长度 = 51.2 s

对于 10 Mbit/s 以太网，在争用期内可发送 512 bit，即 64 字节
- 以太网在发送数据时，若前 64 字节没有发生冲突，则后续的数据就不会发生冲突
- 以太网规定了最短有效帧长为 64 字节。凡长度小于 64 字节的帧都是由于冲突而异常中止的无效帧，应当立即将其丢弃
- 理论上，以太网最大端到端单程时延必须小于争用期的一半 (即 25.6 μs)，相当于以太网的最大端到端长度约为 5 km

#### 强化碰撞：人为干扰信号
- 除AB外的其他用户，在AB发生碰撞时可能并不知情
- 强化碰撞：人为干扰信号
- 发送站检测到冲突后，立即停止发送数据帧，接着就发送 32 或 48 比特的人为干扰信号 (jamming signal)
- 以太网还规定了帧间最小间隔为 9.6 μs

#### CSMA/CD的重要特性
- 使用CSMA/CD协议的以太网不能进行全双工通信，而只能进行双向交替通信（半双工通信）
- 每个站在发送数据之后的一小段时间内，存在着遭遇碰撞的可能性
- 这种发送的不确定性使整个以太网的平均通信量远小于以太网的最高数据率

#### CSMA/CD协议特性归纳
- 先听后发
- 边听边发
- 冲突停止
- 延迟重发

### 使用集线器的星形拓扑
#### 传统以太网传输媒体
- 粗同轴电缆
- 细同轴电缆
- 双绞线
#### 采用双绞线的以太网采用星形拓扑
- 1990 年，IEEE 制定出采用双绞线的星形以太网 10BASE-T 的标准 802.3i
- 星形以太网10Base-T表示速率为10 Mbit/s，BASE表示基带，T表示双绞线

在星形的中心则增加了一种可靠性非常高的设备，叫做集线器 (hub)

#### 集线器的特点
- 使用集线器的以太网在逻辑上仍是一个总线网，只是使用电子器件来模拟实际电缆线的工作
- 使用集线器的以太网仍是共享信道，各工作站使用的还是 CSMA/CD 协议，并共享逻辑上的总线
- 很像一个多接口的转发器，工作在物理层
- 采用了专门芯片，进行自适应串音回波抵消，减少了近端串音

### 以太网的信道利用率
多个站在以太网上同时工作就可能会发生碰撞

当发生碰撞时，信道资源实际上是被浪费了。因此，当扣除碰撞所造成的信道损失后，以太网总的信道利用率并不能达到 100%

#### 发送效率计算
- 假设：单程端到端传播时延 = τ ，则争用期长度 = 2τ 。检测到碰撞后不发送干扰信号
- 设：帧长 = L (bit)，数据发送速率 = C (bit/s)，则帧的发送时间  T0 = L/C (s)
- 发送效率为 T0/(T0+τ)

**注意：成功发送一个帧需要占用信道的时间是 T0 + τ ，比帧的发送时间要多一个单程端到端时延 τ**

#### 参数 a 与利用率
τ/T0越小，信道利用率越高

在以太网中定义了参数 a=τ/T0

以太网的信道利用率 

$$
S_{\text{max}} = \frac{T_0}{T_0 + \tau} = \frac{1}{1 + a}
$$


a → 0，表示一发生碰撞就立即可以检测出来， 并立即停止发送，因而信道利用率很高

a 越大，表明争用期所占的比例增大，每发生一次碰撞就浪费许多信道资源，使得信道利用率明显降低
##### 对以太网参数 a 的要求
- 为提高利用率，以太网的参数 a 的值应当尽可能小些
- 以太网的帧长不能太短，否则 T0 的值会太小，使 a 值太大
- 当数据率一定时，以太网的连线的长度受到限制，否则τ的数值会太大
- 只有当参数 a远小于1 才能得到尽可能高的极限信道利用率
- 据统计，当以太网的利用率达到30%时就已经处于过载情况

### 以太网的 MAC 层
#### MAC 层的硬件地址
硬件地址又称为物理地址，或 MAC 地址。 

IEEE 802 标准为局域网规定了一种 48 位的全球地址（简称为地址）是指局域网上的每一台计算机中固化在适配器的 ROM 中的地址

每一个适配器有一个MAC地址，相当于它的标识符，与其所处的位置无关

局域网上的每一个接口都有一个MAC地址

*注意：如果连接在局域网上的主机或路由器安装有多个适配器，这样的主机或路由器就有多个“地址”。更准确些说，这种 48 位“地址”应当是某个接口的标识符*

#### 48 位的  MAC 地址
- IEEE 注册管理机构 RA 负责向厂家分配前 3 个字节 (即高 24 位)，称为组织唯一标识符 OUI (Organizationally Unique Identifier)
- 厂家自行指派后 3 个字节 (即低 24 位)，称为扩展标识符 (extended identifier)
- 必须保证生产出的适配器没有重复地址
- 地址被固化在适配器的 ROM 中
- windows中ipconfig/all可以查看MAC地址
- https://standards-oui.ieee.org/oui/oui.txt
可以查询生产厂商信息

#### MAC地址分类
IEEE 规定地址字段的第 1 字节的最低位为 I/G (Individual / Group) 位
- 单站地址：I/G 位 = 0
- 组地址：I/G 位 = 1。组地址用来进行多播，只能作为目的地址使用
- 广播地址：所有 48 位都为 1（全 1）。只能作为目的地址使用

#### 全球管理与本地管理
IEEE 把地址字段第 1 字节的最低第 2 位规定为 G/L (Global / Local) 位
- 全球管理：G/L 位 = 0。厂商向 IEEE 购买的 OUI 都属于全球管理
- 本地管理：G/L 位 = 1。 这时用户可任意分配网络上的地址

#### 适配器具有过滤功能
- 每收到一个 MAC 帧，先用硬件检查帧中的 MAC 地址
- 如果是发往本站的帧则收下，然后再进行其他的处理
- 否则就将此帧丢弃，不再进行其他的处理

“发往本站的帧”包括以下 3 种帧
- 单播 (unicast) 帧（一对一）
- 广播 (broadcast) 帧（一对全体）
- 多播 (multicast) 帧（一对多）

以混杂方式 (promiscuous mode) 工作的以太网适配器只要“听到”有帧在以太网上传输就都接收下来

#### MAC 帧的格式
##### 常用的以太网 MAC 帧格式有 2 种标准
- DIX Ethernet V2 标准
- IEEE 的 802.3 标准
##### 最常用的 MAC 帧是以太网 V2 的格式
以太网 V2 的格式为：
```
|目的地址(6Byte)|原地址(6Byte)|类型(2Byte)|数据(46-1500Byte)|FCS(4Byte)|
```
- 目的地址、原地址字段6字节
- 类型字段用来标志上一层使用的是什么协议，以便把收到的MAC帧的数据上交给上一层的这个协议
- 数据字段（MTU）长度为46-1500字节,64Byte-(6+6+2+4)Byte = 46Byte
- 帧的长度为64-1518字节
- 当数据字段的长度小于 46 字节时，应在数据字段的后面加入整数字节的填充字段，以保证以太网的 MAC 帧长不小于 64 字节
- 由硬件在帧的前面插入 8 字节。第一个字段共 7 个字节，是前同步码，用来迅速实现 MAC 帧的比特同步。第二个字段 1 个字节是帧开始定界符，表示后面的信息就是 MAC 帧
  - MAC帧共8字节
  - 前7字节同步码10101010....10101010
  - 最后1字节帧开始定界符10101011
- 为了达到比特同步，物理层在传输媒体上实际传送的要比 MAC 帧还多 8 个字节

##### 无效的 MAC 帧
- 数据字段的长度与长度字段的值不一致
- 帧的长度不是整数个字节
- 用收到的帧检验序列 FCS 查出有差错
- 数据字段的长度不在 46-1500 字节之间（有效的 MAC 帧长度为 64-1518 字节之间）
##### 无效的 MAC 帧的处理
- 对于检查出的无效 MAC 帧就简单地丢弃
- 以太网不负责重传丢弃的帧（不可靠，尽最大努力服务）


## 扩展的以太网
### 在物理层扩展以太网
网络层眼中，扩展后的以太网仍然是一个网络
#### 使用光纤扩展
主机使用光纤和一对光纤调制解调器连接到集线器
#### 使用集线器（Hub）扩展
用多个集线器连成更大的以太网
- 分别通过集线器扩展的三个独立的以太网是三个独立的碰撞域
- 把三个独立的以太网用主干集线器扩展成一个以太网会成为一个更大的碰撞域
##### 优点
- 使原来属于不同碰撞域（冲突域）的计算机能够跨碰撞域通信
- 扩大了以太网覆盖的地理范围
##### 缺点
- 碰撞域增大了，总的吞吐量未提高
- 如果使用不同的以太网技术（如数据率不同），那么就不能用集线器将它们互连起来
- 存在安全隐患
#### 碰撞域（collision domain）
碰撞域（collision domain）又称为冲突域，指网络中一个站点发出的帧会与其他站点发出的帧产生碰撞或冲突的那部分网络

碰撞域越大，发生碰撞的概率越高

### 在数据链路层扩展以太网
更为常用。早期使用网桥，现在使用以太网交换机
#### 网桥（Bridge）
- 工作在数据链路层
- 网桥中存在一个转发表
- 根据 MAC 帧的目的地址对收到的帧进行转发和过滤。或者转发，或者丢弃

#### 交换机（Switch）
- 工作在数据链路层
- 多端口的网桥
- 可明显地提高以太网的性能
- 以太网交换机的特点

实质上是一个多接口网桥
- 通常有十几个或更多的接口

每个接口都直接与一个单台主机或另一个以太网交换机相连，并且一般都工作在全双工方式

以太网交换机具有并行性
- 能同时连通多对接口，使多对主机能同时通信
- 相互通信的主机都独占传输媒体，无碰撞地传输数据
- 每一个端口和连接到端口的主机构成了一个碰撞域

以太网交换机的每个接口都是一个碰撞域

接口有存储器

即插即用。其内部的帧交换表（又称为地址表）是通过自学习算法自动地逐渐建立起来的。这种交换表就是一个内容可寻址存储器CAM (Content addressable Memory)

使用专用的交换结构芯片，用硬件转发，其转发速率要比使用软件转发的网桥快很多

##### 以太网交换机的优点
- 以太网交换机的性能远远超过普通的集线器，而且价格并不贵
- 每个接口用户独享带宽，增加了总容量
- 支持多种速率的接口
- 支持多类型的接口

##### 以太网交换机的交换方式
###### 存储转发方式
- 把整个数据帧先缓存，再进行处理
###### 直通 (cut-through) 方式
- 接收数据帧的同时立即按数据帧的目的 MAC 地址决定该帧的转发接口
- 缺点：不检查差错就直接将帧转发出去，有可能转发无效帧

##### 以太网交换机的自学习功能
###### 以太网交换机的自学习功能的具体流程
- 开始时，交换表是空的
- A 先向 B 发送一帧。该帧从接口 1 进入到交换机
- 交换机收到帧后，先查找交换表。没有查到应从哪个接口转发这个帧给 B
- 交换机把这个帧的源地址 A 和接口 1 写入交换表中
- 交换机向除接口 1 以外的所有的接口广播这个帧
- 由于与该帧的目的地址不相符，C 和 D 将丢弃该帧
- B 向 A 发送一帧。该帧从接口 3 进入到交换机
- 交换机收到帧后，先查找交换表。发现交换表中的 MAC 地址有 A，表明要发送给 A 的帧应从接口 1 转发出去。于是就把这个帧传送到接口 1 转发给 A
- 交换机把这个帧的源地址 B 和接口 3 写入交换表中

以太网交换机可以逆向学习源地址，并记录收到帧的时间，以确定该条信息的有效时间
- 考虑到可能有时要在交换机的接口更换主机，或者主机要更换其网络适配器，这就需要更改交换表中的项目。为此，在交换表中每个项目都设有一定的有效时间。过期的项目就自动被删除

这种自学习方法使得以太网交换机能够即插即用，不必人工进行配置

##### 2台以太网交换机互连
可能存在的问题：回路，回路会造成广播风暴，导致网络的性能急剧降低

##### 消除回路：使用生成树协议（SPT）
生成树协议 STP  (Spanning Tree Protocol) 
- 不改变网络的实际拓扑，但在逻辑上则切断某些链路，使得从一台主机到所有其他主机的路径是无环路的树状结构，从而消除了兜圈子现象

#### 从总线以太网到星形以太网
##### 早期
- 采用无源的总线结构
- 使用 CSMA/CD 协议，以半双工方式工作
##### 现在
- 以太网交换机为中心的星形结构
- 不使用共享总线，没有碰撞问题，不使用 CSMA/CD 协议，以全双工方式工作。但仍然采用以太网的帧结构

### 虚拟局域网
#### 以太网存在的主要问题
- 广播风暴
- 安全问题
- 管理困难等
#### 广播风暴
- 广播域（broadcast domain）
指这样一部分网络，其中任何一台设备发出的广播通信都能被该部分网络中的所有其他设备所接收
- 一个以太网是一个广播域
- 交换机之间的冗余链路形成广播风暴
- 广播风暴消耗大量资源，极大降低网络效率
#### 安全问题、管理问题
- 交换机每个接口都处于一个独立的碰撞域（或冲突域）中，但所有计算机都处于同一个广播域中
- 无法隔离不同部门的通信
- 连接在不同地理位置的同一部门的主机不易管理

#### 虚拟局域网 VLAN(Virtual LAN)
- 利用以太网交换机可以很方便地实现虚拟局域网 VLAN (Virtual LAN)

##### IEEE 802.1Q 对虚拟局域网 VLAN 的定义
虚拟局域网 VLAN 是由一些局域网网段构成的与物理位置无关的逻辑组，而这些网段具有某些共同的需求。每一个 VLAN 的帧都有一个明确的标识符，指明发送这个帧的计算机是属于哪一个 VLAN

虚拟局域网其实只是局域网给用户提供的一种服务，并不是一种新型局域网

VLAN是一个在物理网络上根据用途、工作组、应用等来逻辑划分的局域网络，与用户的物理位置没有关系

每个VLAN是一个广播域

#### 虚拟局域网（VLAN）技术的优点
- 便于网络管理，具有相似需求的用户共享同一个VLAN
- 增强网络的安全性，敏感用户与普通用户隔离
- 减少了不必要的网络流量
- 限制了广播报文的洪泛，抑制广播风暴
- 减少网络拓扑变更成本
- 降低计算机CPU的开销

#### 划分虚拟局域网的方法
- 基于交换机端口
- 基于计算机网卡的 MAC 地址
- 基于协议类型
- 基于 IP 子网地址
- 基于高层应用或服务

## 高速以太网
### 100BASE-T 以太网
#### 100BASE-T 以太网的概念
- 又称为快速以太网 (Fast Ethernet)
- 在双绞线上传送 100 Mbit/s 基带信号的星形拓扑以太网
- 仍使用 IEEE 802.3 的 CSMA/CD 协议
- 1995年定为正式标准：IEEE 802.3u
#### 100BASE-T 以太网的特点
- 可在全双工方式下工作而无冲突发生
- 在全双工方式下工作时，不使用 CSMA/CD 协议
- 使用 IEEE 802.3 协议规定的 MAC 帧格式
- 保持最短帧长不变，但将一个网段的最大电缆长度减小到 100 米
- 帧间时间间隔从原来的 9.6 μs 改为现在的 0.96 μs

#### 100 Mbit/s 以太网的 3 种不同的物理层标准
##### 100BASE-TX
媒体:铜缆，网段最大长度：100m，特点：2对UTP 5类线或屏蔽双绞线STP
##### 100BASE-T4
媒体:铜缆，网段最大长度：100m，特点：4对UTP 3类线或 5类线
##### 100BASE-FX
媒体:光缆，网段最大长度：2000m，特点：2 根光纤，发送和接收各用一根

### 吉比特以太网
#### 吉比特以太网特点
允许在 1 Gbit/s 下以全双工和半双工 2 种方式工作
- 使用 IEEE 802.3 协议规定的 MAC 帧格式
- 在半双工方式下使用 CSMA/CD 协议，而在全双工方式不使用 CSMA/CD 协议
- 与 10BASE-T 和 100BASE-T 技术向后兼容
#### 吉比特以太网的物理层
使用 2 种成熟的技术：一种来自现有的以太网，另一种则是美国国家标准协会 ANSI 制定的光纤通道 FC (Fiber Channel)
#### 半双工方式工作的吉比特以太网
- 半双工时采用 CSMA/CD，必须进行碰撞检测
- 为保持 64 字节最小帧长度，以及 100 米的网段的最大长度，增加了 2 个功能：
  - 载波延伸 (carrier extension)
  - 分组突发 (packet bursting)

**注意：全双工方式工作的吉比特以太网不使用载波延伸和分组突发**

#### 载波延伸
将争用时间增大为 512 字节。凡发送的 MAC 帧长不足 512 字节时，就用一些特殊字符填充在帧的后面
#### 分组突发
当很多短帧要发送时，第 1 个短帧采用载波延伸方法进行填充，随后的一些短帧则可一个接一个地发送，只需留有必要的帧间最小间隔即可。这样就形成可一串分组的突发，直到达到 1500 字节或稍多一些为止

### 10 吉比特以太网 (10GE) 和更快的以太网
#### 10 吉比特以太网（10GE）主要特点
- 万兆比特
- 与 10、100 Mbit/s 和 1 Gbit/s 以太网的帧格式完全相同
- 保留了 IEEE 802.3 标准规定的以太网最小和最大帧长
- 只使用光纤作为传输媒体
- 只工作在全双工方式，没有争用问题，不使用 CSMA/CD 协议

#### 端到端的以太网传输
以太网的工作范围已经扩大到城域网和广域网，实现了端到端的以太网传输
##### 好处
- 技术成熟
- 互操作性很好
- 在广域网中使用以太网时价格便宜
- 采用统一的以太网帧格式，简化了操作和管理

### 使用以太网进行宽带接入
IEEE 在 2001 年初成立了 802.3 EFM 工作组，专门研究高速以太网的宽带接入技术问题
#### 以太网宽带接入具有以下特点
- 可以提供双向的宽带通信
- 可以根据用户对带宽的需求灵活地进行带宽升级
- 可以实现端到端的以太网传输，中间不需要再进行帧格式的转换
- 但不支持用户身份鉴别

#### PPPoE
PPPoE (PPP over Ethernet) ：在以太网上运行 PPP
- 将 PPP 帧封装到以太网中来传输
- 现在的光纤宽带接入 FTTx 都要使用 PPPoE 的方式进行接入
- 利用 ADSL 进行宽带上网时，从用户个人电脑到家中的 ADSL 调制解调器之间的连接也使用 RJ-45 和 5 类线，也使用 PPPoE


# 网络层(Network Layer)
## 网络层的重要概念
### 为什么需要网络层
- 数据链路层解决了同一局域网计算机间帧的传输问题，但没有解决异构网络之间的连接和资源共享问题
- 异构网络互联，即跨局域网连接和资源共享
- 互联网络中主机标识问题
- 互联网中主机间路由选择问题（最佳路径）
- 互联网中数据转发的问题（分组转发）

数据链路层帧的校验没有解决可靠传输的问题，网络层需要解决可靠传输的问题吗？
- 网络层应该向运输层提供怎样的服务？面向连接还是无连接？
- 在计算机通信中，可靠交付应当由谁来负责？是网络还是端系统？
### 两种观点
- 面向连接的可靠交付
- 无连接的、尽最大努力交付的数据报服务，不提供服务质量的承诺
#### 第一种观点：让网络负责可靠交付==>虚电路服务(Virtual Circuit)
- 计算机网络模仿电信网络，使用面向连接的通信方式
- 通信之前先建立虚电路 VC (Virtual Circuit) (即连接)，以保证双方通信所需的一切网络资源
- 如果再使用可靠传输的网络协议，可使所发送的分组无差错按序到达终点，不丢失、不重复
- 缺点：
链路中的任何一个组成环节仍有可能失效，而这种失效是严重的，可能导致所有数据丢失

*虚电路服务：虚电路只是一条逻辑上的连接，分组都沿着这条逻辑连接按照存储转发方式传送，并不是真正建立了一条物理连接*

#### 另一种观点：网络提供数据报服务==>数据报服务(Datagram network)
网络层要设计得尽量简单，向其上层只提供简单灵活的、无连接的、尽最大努力交付的数据报服务
- 网络在发送分组时不需要先建立连接
- 每一个分组（即 IP 数据报）独立发送，与其前后的分组无关（不进行编号）
- 网络层不提供服务质量的承诺。即所传送的分组可能出错、丢失、重复和失序（不按序到达终点），也不保证分组传送的时限

由主机中的运输层负责可靠的通信

#### 虚电路服务与数据报服务的对比
##### 虚电路服务
###### 思路
可靠通信应当由网络来保证
连接的建立必须有
- 终点地址
仅在连接建立阶段使用，每个分组使用短的虚电路号
- 分组的转发
属于同一条虚电路的分组均按照同一路由进行转发
- 当结点出故障时
所有通过出故障的结点的虚电路均不能工作
- 分组的顺序
总是按发送顺序到达终点
- 端到端的差错处理和流量控制
可以由网络负责，也可以由用户主机负责
##### 数据报服务
###### 思路
可靠通信应当由用户主机来保证
- 连接的建立
不需要
- 终点地址
每个分组都有终点的完整地址
- 分组的转发
每个分组独立选择路由进行转发
- 当结点出故障时
出故障的结点可能会丢失分组，一些路由可能会发生变化
- 分组的顺序
到达终点时不一定按发送顺序
- 端到端的差错处理和流量控制
由用户主机负责

##### 虚电路和数据报：哪种方法更好？
- 70-80年代：分组交换
  - X.25，帧中继
- 80年代末-90年代：电路交换更好
  - 认为语音/电视直播将成为互联网终极应用
- 分组交换成为互联网的实际服务方式
  - 人们重新编写应用程序以适应网络（应用程序并不需要保证带宽）
  - Email和Web广泛应用（突发流量）
- 虚电路仍有使用（MPLS，租用专线等）
  - 企业分支结构之间使用，费用昂贵

## 网际协议 IP
### 虚拟互连网络
使用中间设备，可以满足不同需求
各层的中间设备
- 运输层及以上----网关（gateway）
连接不兼容的系统，进行高层协议转换
- 网络层----------路由器（router）
连接不同的网络
- 数据链路层------网桥或桥接器（bridge），交换机（switch）
  - 使用网桥不称为网络互连，网桥或交换机仅把一个网络扩大了，仍然是一个网络
  - 网络互连使用路由器
- 物理层----------转发器（repeater）
使用转发器不称为网络互连，转发器仅把一个网络扩大了，仍然是一个网络

### 网际协议 IP（Internet Protocol）
网际协议IP（Internet Protocol）是TCP/IP体系中最重要的两个协议之一，也是最重要的互联网标准协议之一，推出网际协议IP的是Vint Cerf和Robert Kahn，2004年获得图灵奖，被誉为互联网之父
#### IP 网的意义
- 当互联网上的主机进行通信时，就好像在一个网络上通信一样，看不见互连的各具体的网络异构细节
- 如果在这种覆盖全球的 IP 网的上层使用 TCP 协议，那么就是现在的互联网 (Internet)
#### 与网际协议 IPv4 配套的 3 个协议
- 地址解析协议 ARP (Address Resolution Protocol)
- 网际控制报文协议 ICMP (Internet Control Message Protocol)
- 网际组管理协议 IGMP (Internet Group Management Protocol)

#### TCP/IP层次体系
##### 应用层
各种应用层协议（HTTP,FTP,SMTP等）
##### 运输层
TCP,UDP
##### 网络层（网际层）
- ICMP,IGMP,OSPF,RIP等，与运输层联系
- IP，网络层最重要的协议
- ARP，与网络接口层联系
##### 网络接口层
与各种网络接口
##### 物理硬件
#### 互联网可以由多种异构网络互连组成
- 目标主机前的最后一个路由传输数据是直接交付，其他的传输数据都是间接交付
- 数据经过一个路由器称为一跳


### IP数据报的格式
#### IP数据报
##### IP数据报由首部和数据两部分组成
##### IP数据报首部由固定部分和可变部分组成，固定部分长度为20B

| 位数 | 0-3 | 4-7 | 8-15 | 16-18 | 19-31 |
|:-----|:----|:----|:-----|:------|:------|
| **首部** | 固定 | 版本 | 首部长度 | 区分服务 | 总长度 |
|         | 标识 | 标志 | 片偏移 | - | - |
|         | 生存时间 | 协议 | 首部检验和 | - | - |
|         | 源地址 | 源地址 | 源地址 | 源地址 | - |
|         | 目的地址 | 目的地址 | 目的地址 | 目的地址 | - |
| **可变部分** | 可选字段（长度可变） | 填充 | - | - | - |
| **数据部分** | 数据部分 | - | - | - | - |


##### 报头--版本
- IPv4数据报报头版本，版本字段值(0100)=4
- IPv6数据报报头版本，版本字段值(0110)=6
##### 报头--首部长度
- 1比特表示4字节数据长度
- 首部长度4比特最大可表示为1111（十进制15），即首部最大长度为15*4=60字节
##### 报头--区分服务
- 区分服务占 8 位，用来获得更好的服务
- 只有在使用区分服务（DiffServ）时，这个字段才起作用
- 在一般的情况下都不使用这个字段 
##### 报头--总长度
- 总长度占 16 位，指首部和数据之和的长度
- 单位为字节，因此数据报（首部+数据部分）的最大长度为 2^16-1=65535 字节
- 总长度必须不超过最大传送单元 MTU，MTU限制IP数据报总长度
- IPv4分组在传输途中可以多次分片，IPv4分片只在目的IP对应的目的端系统进行重组
##### 报头--标识 (identification)
- 标识 (identification)占 16 位
- 它是一个计数器，用来产生 IP 数据报的标识
##### 报头--标志(flag)
- 标志(flag)占 3 位，目前只有前两位有意义
- 标志字段的最低位是 MF (More Fragment)
  - MF=1 表示后面还有分片，MF=0 表示最后一个分片
- 标志字段中间的一位是 DF (Don't Fragment) 
  - 只有当 DF=0 时才允许分片
##### 报头--片偏移
- 片偏移占 13 位，指出：较长的分组在分片后
- 某片在原分组中的相对位置
- 片偏移以 8 个字节为偏移单位
- 例如：一个数据报分片数据部分从1400开始，那么它的片偏移值为1400/8=175
##### 报头--生存时间
- 生存时间占 8 位，记为 TTL (Time To Live)
- 指示数据报在网络中可通过的路由器数的最大值
- 不同操作系统生存时间值不同，可以通过生存时间判断发送端的操作系统
##### 报头--协议
- 协议占 8 位，指出此数据报携带的数据使用何种协议，以便目的主机的 IP 层将数据部分上交给那个处理过程
- 协议字段指出应将数据部分交给哪一个进程
- 常用的一些协议和相应的协议字段值

| 协议         | 协议字段值 |
|:--------------|:------------|
| ICMP          | 1            |
| IGMP          | 2            |
| IP            | 4            |
| TCP           | 6            |
| EGP           | 8            |
| IGP           | 9            |
| UDP           | 17           |
| IPv6          | 41           |
| ESP           | 50           |
| AH            | 51           |
| ICMP-IPv6     | 58           |
| OSPF          | 89           |

##### 报头--首部检验和
- 首部检验和占16位，只检验数据报的首部，不检验数据部分。这里不采用 CRC 检验码而采用简单的计算方法
- 数据报每经过一个路由器，路由器都要重新计算一下首部检验和
- 数据部分不参与检验和的计算
- 接收方检验和计算结果为0，则保留，否则，丢弃该数据报
##### 报头--源地址和目的地址
- 源地址和目的地址都各占 32 位
- 32位的二进制地址，标识各个接口，用于网络层寻址

##### 报头--可选字段
- IP首部的可变部分就是一个选项字段，用来支持排错、测量以及安全等措施，内容很丰富
- 长度可变：从 1 个字节到 40 个字节不等，取决于所选择的项目
- 增加了 IP 数据报的功能，但这同时也使得 IP 数据报的首部长度成为可变的，增加了每一个路由器处理数据报的开销
- 实际上这些选项很少被使用

#### IP协议功能即报头字段总结
##### 网络层基本功能
- 支持多跳寻路将IP数据报送达目的端：目的IP地址
- 表明发送端身份：源IP地址
- 根据IP头部协议类型，提交给不同上层协议处理：协议
##### 其他相关问题
- 数据报长度大于传输链路的MTU的问题，通过分片机制解决：标识、标志、片偏移
- 防止循环转发浪费网络资源（路由错误、设备故障等）。通过跳数限制解决：生存时间TTL
- IP报头错误导致无效传输，通过头部机校验解决：首部校验和

### IP地址
IP地址就是给每个连接在互联网上的主机或路由器的每一个接口分配的全球唯一的标识符

IP地址是32位的二进制地址，理论上其地址空间共有2^32个地址

#### ICANN
ICANN(The Internet Corporation for Assigned Names and Numbers),负责全球Internet上的IP地址进行编号分配的机构

地区级的互联网注册机构RIR(Regional Internet Registry),负责该地区的登记注册服务
- 北美地区ARIN
- 亚太地区APNIC
- 非洲地区AfriNIC
- 拉美地区LACNIC
- 欧洲地区RIPE
##### 国家互联网络注册机构NIR
- 中国互联网信息中心CNNIC
  - ISP----网络服务提供商
#### IP地址采用2级结构
IP地址::={<网络号>,<主机号>}

|<-------- 32位 ------------>|
|  网络号   |     主机号     |
| (net-id)  |   (host-id)    |
|<---n位--->|<---(32-n)位--->|


IP地址在整个互联网范围内是唯一的，IP地址指明了连接到某个网络上的一个主机
#### 分级地址结构的好处
- IP地址管理机构负责分配网络号，单位负责分配主机号，方便IP地址的管理
- 路由器根据网络号将分组转发到对应网络，大大减小路由表项目数，减少存储空间占用，提高效率
#### IPv4地址的记录方法
##### 32位二进制地址
##### 点分十进制记法
将每8位的二进制数转换为十进制数，中间用点隔开
- 点分十进制记法仅仅为了方便读写，没有实际意义。与IP地址相关的理解、计算等，都要在二进制下考虑和进行
#### 分类的IP地址
##### A类地址
单播地址
以0开头
net-id有8位（可用7位）
- 有 2^7 个不同网络
- 网络号 00000000 表示本网络
- 网络号 01111111 用于本地软件环回测试
- 共有 2^7-2 个可用网络
- 第1个网络号是 1
- 最后一个网络号是 126
host-id有24位
- 每个网络有 2^24 个主机号
- 主机号全0 表示该主机所在的网络地址
- 主机号全1 表示该网络的所有主机（广播）
- 共 2^24-2 个可分配地址
##### B类地址
单播地址
以10开头
net-id有16位（可用14位）
- 第1个网络号是 128.0
- 最后一个网络号是 191.255
host-id有16位
##### C类地址
单播地址
以110开头
net-id有24位（可用21位）
- 第1个网络号是 192.0.0
- 最后一个网络号是 223.255.255
host-id有8位
##### D类地址
多播地址，以1110开头
- 第1个网络号是 224.0.0.0
- 最后一个网络号是 239.255.255.255
常用于特殊用途，不分配给一般的主机
##### E类地址
保留为今后使用，以1111开头
- 第1个网络号是 240.0.0.0
- 最后一个网络号是 255.255.255.255
常用于特殊用途，不分配给一般的主机
#### 一般不用于分配的特殊IP地址
##### 网络号全0的地址
系统启动时用于启动时临时通信，本网络上的某主机
##### 127.0.0.0
指本地节点（一般为127.0.0.1），用于测试网卡及TCP/IP软件
##### 主机号全0的地址
用于指定网络本身，称之为网络地址或者网络号
##### 主机号全1的地址
用于广播，也称定向广播，需要指定目标网络
##### 0.0.0.0
本网络上的本主机
##### 255.255.255.255
受限广播地址
#### 不同类别网络的大小问题
- 一个A类网络有2^24台主机
- 一个C类网络有2^8台主机
- 一个A类网络相当于2^16个C类网络的大小
#### 子网划分（subnetting）
|<-------------- 32位 ------------------>|
|  网络号   |  子网号   |     主机号     |
| (net-id)  |(subnet-id)|   (host-id)    |
|<---n位--->|<---m位--->|<--(32-n-m)位-->|
##### 可变长子网掩码VLSM(Variable Length Subnet Mask)
- 划分子网是单位内部的事情
在网络内部将一个网络块进行划分以供多个内部网络使用，对外仍是一个网络

例如：将C类网络200.1.1.0划分为8个子网

该网络的二进制表示：11001000 00000001 00000001 00000000

###### 第1个子网
- 第1个可用地址最后8位   000 00001
- 最后1个可用地址最后8位 000 11110
###### 第2个子网
- 第1个可用地址最后8位   001 00001
- 最后1个可用地址最后8位 001 11110
###### 第3个子网
- 第1个可用地址最后8位   010 00001
- 最后1个可用地址最后8位 010 11110
###### 第8个子网
- 第1个可用地址最后8位   111 00001
- 最后1个可用地址最后8位 111 11110

不应该使用全0全1子网这个规定是源于RFC950标准，但是后来RFC950在RFC1878中被废止了

#### 子网掩码（subnet mask）
与IP地址一一对应，是32位的二进制数，置1的位表示网络位，置0的位表示主机位
##### 子网的网络地址
子网的网络地址= IP地址 与 子网掩码 进行逐位“与”运算
##### 判断多个IP地址是否在同一网络
- 第1步：判断子网掩码是否相同
- 第2步：判断IP地址与子网掩码的“与”运算结果，即子网的网络地址是否相同

#### 分类的IP地址的优缺点
##### 优点
- 管理简单
- 使用方便
- 转发分组迅速
- 划分子网，灵活地使用
##### 缺点
- 设计上不合理
- 大地址块，浪费地址资源
- 即使采用划分子网的方法，也无法解决IP地址枯竭的问题

#### 无分类编制方法CIDR（Classless Inter-Domain Routing）
|<-------- 32位 ------------>|
| 网络前缀  |     主机号     |
| (net-id)  |   (host-id)    |
|<---n位--->|<---(32-n)位--->|

网络前缀长度可变

CIDR方法消除了传统的A类、B类和C类地址以及划分子网的概念，可以更加有效地分配IPv4的地址空间

CIDR用掩码表示网络前缀长度

斜线记法（slash notation）：IP地址/n
即 IP地址 和 掩码 ，表示该地址的网络前缀

CIDR如何表示一个任意大小的地址块
- 1个CIDR地址块 200.1.0.0/20 相当于16个C类网络200.1.0.1/24
- 每一个CIDR地址块中的地址数一定是2的整数次幂
##### 常用的CIDR地址块
###### 网络前缀长度----/13
- 点分十进制----255.248.0.0
- 包含的地址数----2^19=512K
- 相当于包含分类的网络数----8个B类或2048个C类
###### 网络前缀长度----/14
- 点分十进制----255.252.0.0
- 包含的地址数----2^18=256K
- 相当于包含分类的网络数----4个B类或1024个C类
###### 网络前缀长度----/15
- 点分十进制----255.254.0.0
- 包含的地址数----2^17=128K
- 相当于包含分类的网络数----2个B类或512个C类
###### 网络前缀长度----/16
- 点分十进制----255.255.0.0
- 包含的地址数----2^16=64K
- 相当于包含分类的网络数----1个B类或256个C类
###### 网络前缀长度----/17
- 点分十进制----255.255.128.0
- 包含的地址数----2^15=32K
- 相当于包含分类的网络数----128个C类
###### 网络前缀长度----/18
- 点分十进制----255.255.192.0
- 包含的地址数----2^14=16K
- 相当于包含分类的网络数----64个C类
###### 网络前缀长度----/19
- 点分十进制----255.255.224.0
- 包含的地址数----2^13=8K
- 相当于包含分类的网络数----32个C类
###### 网络前缀长度----/20
- 点分十进制----255.255.240.0
- 包含的地址数----2^12=4K
- 相当于包含分类的网络数----16个C类
###### 网络前缀长度----/21
- 点分十进制----255.255.248.0
- 包含的地址数----2^11=2K
- 相当于包含分类的网络数----8个C类
###### 网络前缀长度----/22
- 点分十进制----255.255.252.0
- 包含的地址数----2^10=1K
- 相当于包含分类的网络数----4个C类
###### 网络前缀长度----/23
- 点分十进制----255.255.254.0
- 包含的地址数----512
- 相当于包含分类的网络数----2个C类
###### 网络前缀长度----/24
- 点分十进制----255.255.255.0
- 包含的地址数----256
- 相当于包含分类的网络数----1个C类
###### 网络前缀长度----/25
- 点分十进制----255.255.255.128
- 包含的地址数----128
- 相当于包含分类的网络数----1/2个C类
###### 网络前缀长度----/26
- 点分十进制----255.255.255.192
- 包含的地址数----64
- 相当于包含分类的网络数----1/4个C类
###### 网络前缀长度----/27
- 点分十进制----255.255.255.224
- 包含的地址数----32
- 相当于包含分类的网络数----1/8个C类
##### 3个特殊的CIDR地址块
###### 网络前缀长度----/32
- 点分十进制----255.255.255.255
- 说明----就是一个IP地址，这个特殊地址用于主机路由
###### 网络前缀长度----/31
- 点分十进制----255.255.255.254
- 说明----只有两个IP地址，其主机号分别为0和1，这个地址块用于点对点链路
###### 网络前缀长度----/0
- 点分十进制----0.0.0.0
- 说明----同时IP地址也全是0，即0.0.0.0/0，用于默认路由

##### 路由聚合
一个CIDR地址块可以表示很多地址，多个较小地址块也能构成一个更大地址块，称为构成超网（supernet），又称路由聚合（route aggregation）

路由聚合（route aggregation）可以减少路由条目，但CIDR无法解决地址空间不足的问题

###### 聚合前
- 16个C类地址
- 地址掩码=255.255.255.0
- 路由表中需要16个路由项目
###### 聚合后
- 聚合为1个地址
- 地址掩码=255.255.240.0
- 路由表中只需要1个路由项目

#### IP地址的特点
每个IP地址都由网络前缀和主机号两部分组成

IP地址是一种分等级的地址结构
- 方便了IP地址的分配和管理
- 实现路由聚合，减小了转发表所占的存储空间，以及查找转发表的时间

IP地址是标志一台主机（或路由器）和一条链路的接口
- 当一台主机同时连接到两个网络上时，该主机就必须同时具有两个相应的IP地址，其网络号必须是不同的。这种主机称为多归属主机（multihomed host）
- 一个路由器至少应当连接到两个网络，因此一个路由器至少应当有两个不同的IP地址

转发器或交换机连接起来的若干个局域网仍为一个网络
- 一个网络（或子网）是指具有相同网络前缀的主机的集合
- 转发器或交换机连接起来的若干个局域网都具有同样的网络号，它们仍为一个网络
- 具有不同网络号的局域网必须使用路由器进行互连
- 同一网络主机接口必须具有同样的网络号

在IP地址中，所有分配到网络前缀的网络都是平等的
- 互联网同等对待每一个IP地址，不管是范围很小的局域网，还是可能覆盖很大地理范围的广域网上


## IP分组的转发
### 基于终点的转发
#### 概念
- 分组在互联网中是逐跳转发的
- 基于终点的转发：基于分组首部中的目的地址传送和转发

为了压缩转发表的大小，转发表中最主要的路由是（目的网络地址，下一跳地址） ，而不是（目的地址，下一跳地址）

查找转发表的过程就是逐行寻找前缀匹配

不同网络的两个主机H1到H2的分组是如何通过查表转发的？
- 找到目标地址所在网络：IP地址和掩码进行与运算，得到地址所在的网络
- 与路由表中列出的网络地址逐行进行匹配：目标网络和路由表列出的网络地址是同一个
- 找到正确的条目，进行下一跳转发（找不到则丢弃）
### 最长前缀匹配（longest-prefix matching）
使用CIDR时，在查找转发表时可能会得到不止一个匹配结果

最长前缀匹配（longest-prefix matching）原则：选择前缀最长的一个作为匹配的前缀

网络前缀越长，其地址块越小，因而路由就越具体

把前缀最长的排在转发表的第1行

转发表中2种特殊的路由
#### 主机路由（host route）
- 又叫特定主机路由
- 是对特定目的主机的IP地址专门指明的一个路由
- 网络前缀就是a.b.c.d/32
- 放在转发表的最前面
#### 默认路由（default route）
- 不管分组的最终目的网络在哪里，都由指定的路由器R来处理
- 用特殊前缀0.0.0.0/0表示
- 放在转发表的最后面
#### 路由器分组转发算法
- 第1步：提取目的地址IP地址D
- 第2步：查找转发表
- 第3步：查找D的特定主机路由，找到则转发分组到下一跳路由器，未找到则进行下一步
- 第4步：查找D的最长前缀匹配，找到则转发分组到下一跳路由器，未找到则进行下一步
- 第5步：查找默认路由，找到则转发分组到下一跳路由器，未找到则丢弃分组
#### 使用二叉线索查找转发表
- 二叉线索 (binary trie)：一种特殊结构的树，可以快速在转发表中找到匹配的叶节点
- 从二叉线索的根节点自顶向下的深度最多有 32 层，每一层对应于 IP 地址中的一位
- 为简化二叉线索的结构，可以用唯一前缀 (unique prefix) 来构造二叉线索
- 为了提高二叉线索的查找速度，广泛使用了各种压缩技术
#### 唯一前缀构成的二叉线索
规则：先检查IP地址左边的第1位，如果为0，则第1层的节点就在根节点的左下方；如果为1，则在右下方。然后再检查地址的第2位，构造出第2层的节点。以此类推，直到唯一前缀的最后1位。每个叶节点代表一个唯一前缀

为检查网络前缀是否匹配，必须使二叉线索中的每一个叶节点包含所对应的网络前缀和子网掩码

### IP地址与MAC地址
#### 概念
- TCP报文----首部|应用层数据
- IP数据报---首部（IP地址）|TCP报文
- MAC帧------首部（MAC地址）|IP数据报|尾部
#### IP地址
- 虚拟地址、软件地址、逻辑地址
- 网络层和以上各层使用
- 放在IP数据报的首部
- IP地址（非保留IP地址），与“物理位置”相关
#### MAC地址
- 固化在网卡上的ROM中
- 硬件地址、物理地址
- 数据链路层使用
- 放在MAC帧的首部
- 硬件地址与物理位置无关
#### 从协议栈的层次上看IP地址和MAC地址
- 在IP层抽象的互联网上只能看到IP数据报
- 尽管互连在一起的网络的MAC地址体系各不相同，但IP层抽象的互联网却屏蔽了下层这些很复杂的细节
- 只要在网络层上讨论问题，就能够使用统一的、抽象的IP地址研究主机和主机或路由器之间的通信
### 地址解析协议ARP（Address Resolution Prorocol）
实现IP通信时使用了2个地址
- IP地址（网络层地址）
- MAC地址（数据链路层地址）
#### 地址解析协议ARP的作用
ARP（Address Resolution Prorocol）的作用：已知主机或路由器的IP地址，解析出其相应的MAC地址
#### ARP高速缓存（ARP Cathe）
- 存放IP地址到MAC地址的映射表
- 映射表动态更新（新增或超时删除）
#### ARP高速缓存（ARP Cathe）的作用
- 存放最近获得的IP地址到MAC地址的绑定
- 减少ARP广播的通信量
- 为进一步减少ARP通信量，主机A在发送其ARP请求分组时，就将自己的IP地址到MAC地址的映射写入ARP请求分组
- 当主机B收到A的ARP请求分组时，就将主机A的IP地址及其对应的MAC地址映射写入主机B自己的ARP高速缓存中，不必再发送ARP请求

使用ARP高速缓存后，当主机A要向本局域网上的某个主机B发送IP数据报时的工作流程
- 第1步：在其ARP高速缓存查找主机B的IP地址，找到执行第2步，未找到自动运行ARP，找出主机B的MAC地址，更新ARP高速缓存之后直接进行第3步
- 第2步：取出MAC地址
- 第3步：将该MAC地址写入MAC帧的目的地址
- 第4步：发送该MAC帧

ARP 用于解决同一个局域网上的主机或路由器的 IP 地址和 MAC 地址的映射问题

#### 使用 ARP 的四种典型情况
- 发送方是主机，要把 IP 数据报发送到本网络上的另一个主机。这时用 ARP 找到目的主机的硬件地址
- 发送方是主机，要把 IP 数据报发送到另一个网络上的一个主机。这时用 ARP 找到本网络上的一个路由器的硬件地址。剩下的工作由这个路由器来完成
- 发送方是路由器，要把 IP 数据报转发到本网络上的一个主机。这时用 ARP 找到目的主机的硬件地址
- 发送方是路由器，要把 IP 数据报转发到另一个网络上的一个主机。这时用 ARP 找到本网络上另一个路由器的硬件地址。剩下的工作由这个路由器来完成
#### 为什么要使用两种地址：IP 地址和 MAC 地址
- 不同使用不同的 MAC 地址。MAC 地址之间的转换非常复杂
- 对以太网 MAC 地址进行寻址也是极其困难的，MAC地址不适合跨网络寻址使用
- IP 编址把这个复杂问题解决了
  - 连接到互联网的主机只需各自拥有一个唯一的 IP 地址，它们之间的通信就像连接在同一个网络上那样简单方便，即使必须多次调用 ARP 来找到 MAC 地址，但这个过程都是由计算机软件自动进行的，对用户来说是看不见的
  - 因此，在虚拟的 IP 网络上用 IP 地址进行通信非常方便
  - 虚拟互联网使用IP，各局域网使用MAC

## 网际控制报文协议ICMP
### 概念
- ICMP (Internet Control Message Protocol) 允许主机或路由器报告差错情况和提供有关异常情况的报告
- ICMP 是互联网的标准协议
- 但 ICMP 不是高层协议，而是 IP 层的协议
### ICMP 报文的格式
0        8        16              31
|  类型  |  代码  |     检验和    | （前4个字节是统一格式）
|（这4个字节取决于ICMP报文的类型）|
| ICMP的数据部分（长度取决于类型）|

ICMP报文位于IP数据报的数据部分

### ICMP 报文的种类
ICMP 报文有2 种：差错报告报文，询问报文
#### 差错报告报文
##### 类型3-----终点不可达
| 代码 | 含义               |
|:------|:--------------------|
| 0    | 目标网络不可达       |
| 1    | 目标主机不可达       |
| 2    | 目标协议不可达       |
| 3    | 目标端口不可达       |
| 6    | 目标网络未知         |
| 7    | 目标主机未知         |

##### 类型11----时间超过
| 代码 | 含义     |
|:------|:----------|
| 0    | TTL 过期 |

##### 类型12----参数问题
| 代码 | 含义         |
|:------|:--------------|
| 0    | 坏的 IP 首部 |
##### 类型5-----改变路由（Redirect）
#### 询问报文
##### 类型8或0------回送（Echo）请求或回答
###### 类型0
| 代码 | 含义             |
|:------|:----------------|
| 0    | 回送应答（ping） |

###### 类型8
| 代码 | 含义             |
|:------|:----------------|
| 0    | 回送请求（ping） |

##### 类型13或14----时间戳（Timestamp）请求或回答
**根据RFC 6633规定，已不再使用类型值为4、10或9/15或16/17或18的报文**
#### ICMP 差错报告报文
##### ICMP 差错报告报文的数据字段的内容
###### 收到的IP数据报
|IP数据报首部|IP数据报的数据字段|
###### ICMP差错报告报文
|ICMP的前8字节|IP数据报首部|IP数据报的数据字段的前8字节|
###### 装入 ICMP 报文的 IP 数据报
|首部|ICMP差错报告报文|

##### 不应发送 ICMP 差错报告报文的几种情况
- 对 ICMP 差错报告报文不再发送 ICMP 差错报告报文
- 对第一个分片的数据报片的所有后续数据报片都不发送 ICMP 差错报告报文
- 对具有多播地址的数据报都不发送 ICMP 差错报告报文
- 对具有特殊地址（如127.0.0.0 或 0.0.0.0）的数据报不发送 ICMP 差错报告报文

#### ICMP 询问报文
回送请求和回答
- 由主机或路由器向一个特定的目的主机发出的询问
- 收到此报文的主机必须给源主机或路由器发送 ICMP 回送回答报文
- 这种询问报文用来测试目的站是否可达，以及了解其有关状态

时间戳请求和回答
- 请某台主机或路由器回答当前的日期和时间
- 时间戳回答报文中有一个 32 位的字段，其中写入的整数代表从1900 年 1 月 1 日起到当前时刻一共有多少秒
- 时间戳请求与回答可用于时钟同步和时间测量

### ICMP 的应用
#### PING (Packet InterNet Groper) 
- 用来测试两个主机之间的连通性
- 使用了 ICMP 回送请求与回送回答报文
- 是应用层直接使用网络层 ICMP 的例子，没有通过运输层的 TCP 或 UDP
- PING命令返回的TTL值（报文剩余跳数）可以判断对方主机操作系统的类型

###### Linux
- 版本 Red Hat 9
- 协议 ICMP和TCP
- TTL 64
###### Windows
- 版本 Server 2008
- 协议 ICMP/TCP/UDP
- TTL 128
###### Windows
- 版本 10
- 协议 ICMP/TCP/UDP
- TTL 128

**在服务器之前的路由器设定接收到的PING命令的包全部丢弃，可以防止服务器被DDOS攻击**

#### Traceroute和teacert
- UNIX操作系统中使用Traceroute。在 Windows 操作系统中使用 tracert
- 用来跟踪一个分组从源点到终点的路径
- 它利用 IP 数据报中的 TTL 字段、ICMP 时间超过差错报告报文和ICMP 终点不可达差错报告报文实现对从源点到终点的路径的跟踪
- 源向目的地发送一系列UDP段（不可能的端口号），第一个TTL=1，第二个TTL=2 ...，每次发送3个

##### 当第n个数据报到达第n个路由器时：
- 路由器丢弃数据报
- 并向源发送3个ICMP报文（类型11，编码0）
- 报文的源IP地址就是该路由器的IP地址

## IPv6
### 基本概念
- IP 是互联网的核心协议
- IPv4 地址耗尽问题

IPv4地址只有2^32个（43亿左右），到 2011 年 2 月，IANA IPv4 的 32 位地址已经耗尽
- 各地区互联网地址分配机构也相继宣布地址耗尽
- 我国在 2014 – 2015 年也逐步停止了向新用户和应用分配 IPv4 地址
- 分类不合理（扁平化、边界无法聚合），VLSM、CIDR没有增加地址

NAT解决了IPv4不够的问题，但破坏了端到端通信的完整性

广播机制、ARP的依赖带来的不少安全问题

对移动性的支持不够理想

根本解决措施：采用具有更大地址空间的新版本的 IP，即 IPv6

### IPv6协议概述
- IPv6 仍支持无连接的传送
- 将协议数据单元 PDU 称为分组 (packet)
#### IPv6主要变化
- 更大的地址空间。 将地址从 IPv4 的 32 位 增大到了 128 位，全局可达，聚合性更高
- 扩展的地址层次结构。可以划分为更多的层次
- 灵活的首部格式。定义了许多可选的扩展首部
- 改进的选项。允许数据报包含有选项的控制信息，其选项放在有效载荷中
- 允许协议继续扩充。更好地适应新的应用
- 支持即插即用（即自动配置）。不需要使用 DHCP
- 支持资源的预分配。支持实时视像等要求保证一定的带宽和时延的应用
- IPv6 首部改为 8 字节对齐。首部长度必须是 8 字节的整数倍
- 更小的路由表。IPv4分配不连续。分配时考虑了聚类问题，相同区域默认分配相同前缀IP地址
- 分段处理。主机进行分片处理（默认最小MTU为1280字节），IPv6分组不能在传输途中分片，只在源端进行分片（不需要路由器分片），路由器如果发现需要分片，丢弃并向源端报错
- 传输安全性。强制使用IPSec安全加密传输
### IPv6 数据报的一般形式
#### 由两大部分组成
##### 基本首部 (base header)
##### 有效载荷 (payload)

有效载荷也称为净负荷。有效载荷允许有零个或多个扩展首部 (extension header)，再后面是数据部分

|<------------- IPv6数据报 -------------->|
|基本首部|         有  效  载  荷         |
  40字节 |         不超过65535字节        |
         |扩展首部1|...|扩展首部N|数据部分|
         |<-------- 选项 ------->|
         |（扩展首部不属于首部） |

#### IPv6 数据报的基本首部
##### 首部长度
固定的 40 字节，称为基本首部。
##### 首部字段数
只有 8 个
##### 40 字节长的 IPv6 基本首部
      位0    4        12   16         24       31
IPv6的
基本首部|版本|通信量类|       流 标 号         |
（40 B）|   有效载荷长度   |下一个首部|跳数限制|  
        |            源    地    址            | 
        |               （128位）              |
        |            目  的  地  址            |
IPv6的  |               （128位）              |
有效载荷|       有效荷载（扩展首部/数据）      |
(至64KB)|                                      |

##### 版本（version）
4位，指明了协议的版本，IPv6字段是6（0110）
##### 通信量类（traffic class）
8位，这是为了区分不同的IPv6数据报的类别或优先级
##### 流标号（flow label）
20位，“流”是互联网络上从特定源点到特定终点的一系列数据报，所有属于同一个流的数据报都具有同样的流标号。资源预分配时使用，对实时音频/视频数据的传送特别有用
##### 有效荷载长度（payload length）
16位。它指明IPv6数据报除基本首部以外的字节数（扩展首部+数据）
##### 下一个首部（next header）
8位。相当于IPv4的协议字段或可选字段。可能是TCP/UDP/TCMP等，也可能是扩展头
##### 跳数限制（hop limit）
8位。相当于IPv4的TTL，最大值255，为0时丢弃
##### IPv6 对首部的主要更改
- 取消了首部长度字段
- 取消了服务类型字段
- 取消了总长度字段，改用有效载荷长度字段
- 把 TTL 字段改称为跳数限制字段
- 取消了协议字段，改用下一个首部字段
- 取消了检验和字段
- 取消了选项字段，而用扩展首部来实现选项功能

IPv6的首部格式改变提升转发处理速度

#### IPv6 数据报的扩展首部
IPv6的选项的功能都放在扩展首部中，由两端的源点和终点的主机来处理，路由器不处理（逐跳选项扩展首部除外）

每个扩展首部都包含“下一个首部”字段（IPv6首部固定字段也有）
- 可指向下一个扩展首部类型
- 最后一个扩展首部指明上层协议：TCP/UDP/ICMP...       

如有多个扩展首部，需按规定顺序出现
- 逐跳选项
- 路由选择
- 分片
- 鉴别
- 封装安全有效载荷
- 目的站选项

### IPv6的地址
在IPv6中，每个地址占128位，地址空间大于3.4*10^38
#### 3种基本类型
##### 单播 (unicast)
传统的点对点通信
##### 多播 (multicast)
一点对多点的通信
##### 任播 (anycast)
IPv6 增加的一种类型。任播的终点是一组计算机，但数据报在交付时只交付其中的一个。通常是按照路由算法得出的距离最近的一个
#### IPv6地址的记法
冒号十六进制记法(colon hexadecimal notation, 简写为 colon hex)

16 位的值用十六进制值表示，各值之间用冒号分隔

###### 零压缩(zero compression)
一串连续的零可以用一对冒号取代
**注意：在任一地址中，只能使用一次零压缩**
###### 点分十进制记法的后缀
- 结合使用点分十进制记法的后缀在 IPv4 向 IPv6 的转换阶段特别有用
- 例如：0:0:0:0:0:0:128.10.2.1可记为::128.10.2.1
- CIDR 的斜线表示法仍然可用，但取消了子网掩码
- 例如：60 位的前缀 12AB00000000CD3 可记为：
  - 12AB:0000:0000:CD30:0000:0000:0000:0000/60
  - 或 12AB::CD30:0:0:0:0/60 （零压缩）
  - 或 12AB:0:0:CD30::/60 （零压缩）
###### CIDR 记法地址
2001:0DB8:0:CD30:123:4567:89AB:CDEF/60
表示：
- IPv6 的地址是：2001:0DB8:0:CD30:123:4567:89AB:CDEF
- 其子网号是：2001:0DB8:0:CD30::/60

#### IPv6 地址分类
##### 未指明地址
- 二进制前缀---- 00...0（128位），仅此一个
- IPv6记法---- ::/128
##### 环回地址
- 二进制前缀---- 00...1（128位），仅此一个
- IPv6记法---- ::1/128
##### 多播地址
- 二进制前缀---- 11111111（8位），功能和IPv4的一样
- IPv6记法---- FF00::/8
##### 本地链路单播地址
- 二进制前缀---- 1111111010（10位），未连接到互联网，不能和互联网上的其他主机通信
- IPv6记法---- FE80::/10
##### 全球单播地址
除上述4种外，所有其他的二进制前缀

#### IPv6 地址配置方式
##### 手动配置
##### DHCPv6（IPv6动态主机配置协议）
无状态地址自动配置，基于邻居发现协议（ND）的路由器请求报文（RS）的IPv6前缀信息，结合自己的链路层地址生成IPv6地址

### 从 IPv4 向 IPv6 过渡
#### IPv4协议和IPv6协议并不兼容，迁移可能经历很长时间
涉及：互联网用户、互联网服务提供商（ISP）、互联网内容提供商（ICP）、网络设备厂家
#### 方法：逐步演进，向后兼容
向后兼容：IPv6 系统必须能够接收和转发 IPv4 分组，并且能够为 IPv4 分组选择路由
#### 两种过渡策略
##### 使用双协议栈
由域名系统DNS查询结果决定使用哪一套系统
##### 使用隧道技术
在IPv4协议外加IPv4报头，将IPv6的报头也看作是IPv4数据报的数据进行传输
### ICMPv6
IPv6 也需要使用 ICMP 来反馈一些差错信息。新的版本称为 ICMPv6
ICMPv6 包含了 ARP 和 IGMP 协议的功能

ICMPv6是面向报文的协议，用来报告差错，获取信息，探测邻站或管理多播通信

比ICMPv4要复杂

ARP协议和IGMP协议的功能合并到ICMPv6中

增加了对移动IPv6的支持
#### ICMPv6报文的分类
- 差错报文
- 信息报文
- 邻站发现报文
ND协议（ND:Neighbor-Discovery）----邻站发现
- 组成员关系报文
MLD(Multicast Listener Delivery)----多播听众交付

## 互连网的路由选择协议
### 路由选择协议的几个基本概念
#### 理想的路由算法
- 算法必须是正确的和完整的
- 算法在计算上应简单
- 算法应能适应通信量和网络拓扑的变化，要有自适应性
- 算法应具有稳定性
- 算法应是公平的
- 算法应是最佳的
  - 不存在一种绝对的最佳路由算法
  - 所谓“最佳”只能是相对于某一种特定要求下得出的较为合理的选择而已
#### 路由选择非常复杂
- 需要许多路由器协同动作
- 环境不断变化，而这种变化有时无法事先知道
- 当网络发生拥塞时，很难获得所需的路由选择信息
#### 路由算法分类
根据路由算法是否随网络的通信量或拓扑自适应可以划分为两类
##### 静态路由选择策略
- 非自适应路由选择
- 不能及时适应网络状态的变化
- 简单，开销较小
##### 动态路由选择策略
- 自适应路由选择
- 能较好地适应网络状态的变化
- 实现较为复杂，开销较大
#### 分层次的路由选择协议
- 互联网采用自适应的（即动态的）、分布式路由选择协议
- 把整个互联网划分为许多较小的自治系统 AS，采用分层次的路由选择协议
##### 分为 2 个层次
- 自治系统之间的路由选择 或 域间路由选择 (interdomain routing)；
- 自治系统内部的路由选择 或 域内路由选择 (intradomain routing)

为提高路由表查表速度，减少路由表存储空间，需要缩减路由条目
##### 现实情况
- 互联网规模非常大
- 地址分配往往是随机的，难以进行高效的地址聚合，导致路由表爆炸，通信链路饱和
- 每个网络的网络管理员有自己的管理方法和思路，并不希望每个路由器都干涉本网络内部的地址分配等问题

分层次的路由可以解决
- 网络扩展性问题
当网络扩大时，控制路由表条目和路由表存储空间的增长
- 管理的自治问题
网络管理员可以控制和管理自己网络的路由

互联网由大量不同的网络互连，每个管理机构控制的网络是自治的

#### 自治系统 AS (Autonomous System)
- 是在单一技术管理下的许多网络、IP地址以及路由器
- 这些路由器使用一种自治系统内部的路由选择协议和共同的度量（跳数、带宽、时延等）
- 每一个 AS 对其他 AS 表现出的是一个单一的和一致的路由选择策略
- 不同的AS可以使用不同的路由算法/路由协议
- 每个AS有一个全球唯一的ID号：AS ID
- 自治系统内还可以进一步划分层次：私有自治系统或区域
#### 两大类路由选择协议
- 自治系统内部使用的内部网关路由协议IGP（Interior Gateway Protocols）
  - 每个自治系统域内路由算法可以不同
  - 典型的IGP协议：OSPF,RIP,IS-IS,IGRP,EIGRP...
- 自治系统之间使的外部网关路由协议EGP（Exterior Gateway Protocols）
  - 各自治系统域之间的路由需统一
  - 典型的EGP协议：BGP


### 内部网关协议 RIP
#### RIP协议的工作原理
路由信息协议 RIP (Routing Information Protocol) 是一种分布式的、基于距离向量的路由选择协议
##### 互联网的标准协议
##### 最大优点：简单
要求网络中的每个路由器都要维护从它自己到其他每一个目的网络的距离记录
#### RIP“距离”的定义
- 路由器到直接连接的网络的距离 = 1
- 路由器到非直接连接的网络的距离 = 所经过的路由器数 + 1
- RIP 协议中的“距离”也称为“跳数”(hop count)，每经过一个路由器，跳数就加 1
- 好路由 = “距离短”的路由。最佳路由 = “距离最短”的路由
- 一条路径最多只能包含 15 个路由器
- “距离”的最大值为 16 时即相当于不可达
- RIP 不能在两个网络之间同时使用多条路由，只选择距离最短”的路由
#### RIP 协议的三个特点
- 仅和相邻路由器交换信息
- 交换的信息是当前本路由器所知道的全部信息，即自己的路由表
- 按固定时间间隔交换路由信息，例如，每隔 30 秒。当网络拓扑发生变化时，路由器也及时向相邻路由器通告拓扑变化后的路由信息
#### 路由表的建立
- 路由器在刚刚开始工作时，路由表是空的
- 然后，得到直接连接的网络的距离（此距离定义为 1）
- 之后，每一个路由器也只和数目非常有限的相邻路由器交换并更新路由信息
- 经过若干次更新后，所有的路由器最终都会知道到达本自治系统中任何一个网络的最短距离和下一跳路由器的地址
- RIP 协议的收敛 (convergence) 过程较快。“收敛”就是在自治系统中所有的结点都得到正确的路由选择信息的过程
#### 路由表更新规则
使用距离向量算法找出到达每个目的网络的最短距离
#### 距离向量算法
##### 算法基础
Bellman-Ford算法或 Ford-Fulkerson算法
##### 算法要点
- 设X是结点A到B的最短路径上的一个结点
- 若把路径A->B拆成两段路径A->X和X->B，则每一段路径A->X和X->B也都分别是结点A到X和结点X到B的最短路径
##### 路由表的距离向量算法
对每个相邻路由器（假设其地址为 X）发送过来的 RIP 报文，路由器做以下操作
- 修改 RIP 报文中的所有项目（即路由）：把“下一跳”字段中的地址都改为 X，并把所有的“距离”字段的值加 1
- 对修改后的 RIP 报文中的每一个项目，重复以下步骤：
  - 若路由表中没有目的网络N，则把该项目添加到路由表中。否则
    - 若路由表中网络 N 的下一跳路由器为 X，则用收到的项目替换原路由表中的项目。否则
      - 若收到项目中的距离小于路由表中的距离，则用收到项目更新原路由表中的项目。否则
        - 什么也不做

若 3 分钟还未收到相邻路由器的更新路由表，则把此相邻路由器记为不可达路由器，即将距离置为 16（表示不可达）

返回

#### RIP2 报文
RIP2 支持无分类域间路由选择 CIDR，提供简单的鉴别，支持多播

RIP2 的报文用使用 UDP 传送（使用 UDP 端口 520）
##### 组成
首部和路由 2 个部分
##### 路由部分
由若干个路由信息组成。每个路由信息共 20 个字节
- 地址族标识符（又称为地址类别）字段用来标志所使用的地址协议
- 路由标记填入自治系统的号码
- 后面为具体路由，指出某个网络地址、该网络的子网掩码、下一跳路由器地址以及到此网络的距离。

一个 RIP 报文最多可包括 25 个路由，因而 RIP 报文的最大长度是 4+20 x25=504 字节。如超过，必须再用一个 RIP 报文来传送

RIP2 具有简单的鉴别功能
#### RIP协议的优缺点
##### 优点
实现简单，开销较小
##### 缺点
- 网络规模有限。最大距离为15（16表示不可达）
- 交换的路由信息为完整路由表，开销较大
- 坏消息传播的慢，收敛时间过长

### 内部网关协议 OSPF
#### 基本概念
- 开放最短路径优先 OSPF (Open Shortest Path First)是为克服 RIP 的缺点在 1989 年开发出来的
- 原理很简单，但实现很复杂
- 使用了 Dijkstra 提出的最短路径算法 SPF
- 采用分布式的链路状态协议 (link state protocol)
- 现在使用 OSPFv2
#### OSPF特点
- 采用洪泛法 (flooding)，向本自治系统中所有路由器发送信息
- 发送的信息就是与本路由器相邻的所有路由器的链路状态
- 只有当链路状态发生变化时，路由器才用洪泛法发送此消息
#### 链路状态数据库 (link-state database) 
链路状态指的是说明本路由器都和哪些路由器相邻，以及该链路的“度量”(metric)
- OSPF度量值一般包括费用、距离、时延、带宽等
- 由于各路由器之间频繁地交换链路状态信息，因此所有的路由器最终都能建立一个链路状态数据库LSDB
- 这个数据库实际上就是区域内的拓扑结构图，它在区域内的一致的（这称为链路状态数据库的同步）
- 指定的路由器DR（designated router）代表该局域网上所有的链路向连接到该网络上的各路由器发送状态信息

OSPF适用于更大的网络，为加快收敛、便于管理，使用层次结构的区域划分，以缩小LSDB规模，减少网络流量
#### OSPF 根据接口将自治系统划分为两种不同的区域 (area)
- 主干区域 (backbone area) 
- 自治系统 AS
#### OSPF中的路由器划分
- 区域边界路由器 ABR (area border router)
- 主干路由器 BR (backbone router)
- 自治系统边界路由器 ASBR (AS border router)
#### 划分区域优点和缺点
##### 优点
- 减少了整个网络上的通信量
- 减少了需要维护的状态数量
##### 缺点
- 交换信息的种类增多了
- 使 OSPF 协议更加复杂了
#### OSPF 的五种分组类型
- 问候 (Hello) 分组
- 数据库描述 (Database Description) 分组
- 链路状态请求 (Link State Request) 分组
- 链路状态更新 (Link State Update) 分组
- 链路状态确认 (Link State Acknowledgment)分组
#### OSPF-邻居状态机
- 邻居
  - 端口连接到同一个网段
  - 由hello报文维护
- 完全邻接
  - 为了交换路由信息而形成的关系
  - 并非所有的邻居关系都可以称为邻接关系
#### OSPF工作过程
##### 发现邻居
- 相邻路由器每隔10秒要交换一次问候分组。超过40秒认为不可达
##### 同步链路状态数据库，建立完全邻接关系
- 同步----指不同路由器的链路状态数据库的内容是一样的
##### 更新链路状态
- 只要链路状态发生变化，路由器就使用链路状态更新分组，采用可靠的洪泛法向全网更新链路状态
- 每隔一段时间也会更新一次链路状态

**OSPF 链路状态只涉及相邻路由器，与整个互联网的规模并无直接关系，因此当互联网规模很大时，OSPF 协议要比距离向量协议 RIP 好得多**

**OSPF 没有“坏消息传播得慢”的问题，收敛数度快**

#### OSPF 使用可靠的洪泛法发送更新分组
### 外部网关协议 BGP
#### 概念
BGP 是不同自治系统的路由器之间交换路由信息的协议

BGP 较新版本是 2006 年 1 月发表的 BGP-4（BGP 第 4 个版本），即 RFC 4271 ~ 4278

可以将 BGP-4 简写为 BGP
#### 协议 BGP 的主要特点
用于自治系统 AS 之间的路由选择

只能是力求选择出一条能够跨越AS到达目的网络且比较好的路由（不能兜圈子），而并非要计算出一条最佳路由
- 互联网的规模太大，使得自治系统AS之间路由选择非常困难
自治系统AS之间的路由选择必须考虑有关策略

采用了路径向量 (path vector) 路由选择协议
#### BGP 发言者 (BGP speaker)
对等 BGP 发言者（边界路由器）在 AS 之间交换信息
#### eBGP 连接和 iBGP 连接（使用TCP连接）
##### eBGP(external BGP)连接
运行eBGP协议，在不同AS之间交换路由信息
##### iBGP(internal BGP)连接
运行iBGP协议，在AS内部的路由器之间交换BGP路由信息。AS内部路由器之间同时还要交换内部网关路由协议信息，例如RIP、OSPF
#### BGP路由信息
BGP 路由 = [ 前缀, BGP属性 ] = [ 前缀, AS-PATH, NEXT-HOP ]

前缀：指明到哪一个子网（用 CIDR 记法表示）

BGP 属性：最重要的两个属性是
- 自治系统路径 AS-PATH 
- 下一跳 NEXT-HOP

**在属性 AS-PATH 中，不允许出现相同的 AS 号，这样避免了兜圈子路由**

#### BGP 的路由选择
- 本地偏好 (local preference) 值最高的路由 （默认值=100）
- AS 跳数最小的路由（最短AS PATH）
- 最近的下一跳路由器（分组在 AS 内的转发次数最少）
- 路由器 BGP ID 数值最小的路由。具有多个接口的路由器有多个 IP 地址，BGP ID 就使用该路由器的 IP 地址中数值最大的一个

### 路由器的构成
#### 路由器工作原理
- 路由器工作在网络层，用于在不同网络之间转发分组

##### 在路由器之间传送的信息有以下2大类
- 主机之间需要传送的数据
- 路由信息（为数据传送服务）
**第二类信息的传送是为第一类信息服务的
##### 路由器包含2个核心功能
###### 控制层面
运行各种路由协议（BGP、OSPF、RIP等），学习去往不同目的的转发路径（路由表）
###### 数据层面
根据上述路由表，将收到的IP分组转发到正确的下一跳链路

#### 转发层面
- 路由器根据本地路由器生成的转发表，把收到的分组从查找到的对应接口转发出去
- 独立工作
- 采用硬件转发，纳秒级
#### 路由层面
- 根据路由选择协议所用的路由算法计算路由创建出本路由器的路由表
- 许多路由器协同动作
- 采用软件计算，秒级
#### 路由器的结构
##### 控制层面
- 路由器可同时运行多个路由协议，也可以只使用静态路由和直连路由
- 路由管理根据路由优先级，选择最佳路由，形成核心路由表
- 优先级数值越小，优先级越高
##### 数据层面
控制层将核心路由表下发到数据层，形成转发表（FIB）
###### 输入端口
- 链路层解封装
- 收到路由分组，交给路由管理处理
- 收到数据分组，由交换结构处理，通过交换结构将报文排队发往目的接口卡
###### 输出端口
- 从交换结构接收报文
- 链路层封装
- 从输出接口发送报文

#### 路由器中IP报文转发核心功能
- 链路层解封装，IP头部校验
- 获取报文目的IP地址
- 用目的IP地址，基于最长前缀匹配规则查询转发表
- 查询失败，丢弃报文
- 查询成功
  - 获取转发出接口和下一跳IP地址
  - IP头部“TTL”字段值减1，重新计算IP头部“校验和”
  - 重新进行链路层封装，发送报文

#### 三种典型的交换结构
##### 共享内存
##### 共享总线
##### 纵横式Crossbar
应用于高性能分布式路由器

#### 家用路由器与典型的网络路由器差异较大
- 家用路由器要求便捷，安全性要求不高
- 商用路由器安全性要求很高，因此功能都需要手动操作，配置复杂


## 多播
### 基本概念
#### 多播（multicast）
源主机给网络中的一部分目标用户发送数据包
#### 目的
更好地支持一对多通信
#### 一对多通信
一个源点发送到许多个终点
### 多播的应用
- 音频/视频会议
- 共享电子白板
- 数据分发
- 实时数据组播
音频视频点播、网络收看体育比赛直播、炒股等
- 游戏与仿真
同时有大量参与者的网络游戏
### 多播实现的两个步骤
#### 确定多播组成员
边缘路由器通过与主机交互，了解到从它的某个端口可以到达哪些组的成员--主机与路由器之间的组成员关系协议
#### 多播路由
### 网际组管理协议 IGMP（Internet Group Management Protocol）
#### 概念
让连接在本地局域网上的多播路由器知道本局域网上是否有主机参加或退出了某个多播组，即让路由器获悉该网段的组播组成员
#### IGMP 工作可分为两个阶段
- 第一阶段：加入多播组
- 第二阶段：探询组成员变化情况
#### IGMP标准
- 1989 年公布的 RFC 1112（IGMPv1）已成为了互联网的标准协议。
- 1997 年公布的 RFC 2236（IGMPv2，建议标准）对 IGMPv1 进行了更新。
- 2002 年 10 月公布了 RFC 3376（IGMPv3，建议标准）
### 多播IP地址
- 在IP多播数据报的目的地址使用IP地址中的D类地址（多播地址）标识组成员。每一个D类地址标志一个多播组
##### 地址范围
224.0.0.0-239.255.255.255
##### 常用地址
224.0.0.0/24
#### 局域网多播地址（一跳子网内使用）

| IP 地址        | 作用               |
|:----------------|:--------------------|
| 224.0.0.1      | LAN 上所有设备      |
| 224.0.0.2      | LAN 上所有路由器    |
| 224.0.0.5      | LAN 上所有 OSPF 路由器 |
| 224.0.0.251    | LAN 上所有 DNS 服务器 |

#### 多播硬件地址
##### TCP/IP协议使用的以太网地址多播地址的范围是
- 从 00-00-5E-00-00-00 开始
- 到 00-00-5E-FF-FF-FF 结束

所有通信都使用IP多播。只要有可能，都用硬件多播来传送，以减小网络开销

收到多播数据报的主机，在IP层对IP地址进行过滤，把不是本主机要接收的数据报丢弃

#### 多播路由
多播路由选择协议使多播路由器协同工作，把多播数据报用最小代价传送给多播组的所有成员
- 实际上就是要找出以源主机为根节点的多播转发树（生成树）
- 不同的多播组对应于不同的多播转发树
- 数据包沿生成树发送

转发多播数据报时使用三种方法
- 洪泛与剪除
  - 适合于较小的多播组，所有组成员接入的局域网也是相邻接的
  - 为避免兜圈子，采用反向路径广播RPB（Reverse Path Broadcasting）的策略，即受控制的洪泛
- 剪枝
  - 如果在多播转发树上的某个路由器发现它的下游数枝（即叶节点方向）已没有该多播组的成员，就把它和下游的数枝一起剪除
- 嫁接
  - 当某个数枝有新增加的组成员时，可以再接入到多播转发树上

生成树（spanning tree）
- 源节点向所有属于该生成树的特定链路发送分组
- 改进了逆向路径转发
- 没有环路
- 最佳使用带宽
- 最少副本，消除了冗余分组
- 一个路由器可以不必知道整棵树，只需要知道在一个数中的邻居即可
###### 隧道技术（tunneling）
可以使多播数据穿越不支持多播的网络
###### 基于核心的发现技术
最佳生成树的使用取决于组的密度分布
- 密集分布
接受者遍布在网络的大部分区域（基于源点树source-based trees）
  - 链路状态路由算法
  每个路由器针对组内的每个发送者构造一棵独立树
  - 距离向量路由算法
  逆向路径转发，修剪没有组成员的路由器
- 稀疏分布
大部分网络区域都不属于组播组（基于核心树core-based tree）
  - 多个组播源共享树


## 虚拟专用网 VPN 和网络地址转换 NAT
### 虚拟专用网 VPN（Virtual Private Network）
#### 使用虚拟专用网VPN的原因
- 由于 IP 地址的紧缺，一个机构无法使所有主机都拥有公网IP
- 考虑到互联网并不很安全，一个机构内也并不需要把所有的主机接入到外部的互联网
- 使用专用链路------铺设、租用（费用高，不灵活）
#### 虚拟专用网VPN（Virtual Private Network）定义
- VPN指利用公用网络架设专用网络的远程访问技术
- 专用网络的经济、可靠、灵活的解决方案
- 利用安全隧道技术将专用网络在公共网络上扩展
- VPN通过隧道技术在公共网络上模拟出一条点到点的逻辑专线，从而达到安全数据传输的目的
#### VPN的设计原则
- 安全性
- 隧道与加密
- 数据验证
- 用户验证
- 防火墙与攻击检测
#### 专用网络IP地址块（本地地址）
##### 10.0.0.0/8
A类，从10.0.0.0到10.255.255.255,1个
##### 172.16.0.0/12
B类，从172.16.0.0到172.31.255.255，连续16个
##### 192.168.0.0/16
C类，从192.168.0.0到192.168.255.255，连续256个
### 网络地址转换 NAT（Network Address Translation）
#### NAT概念
- 所有使用本地地址的主机在和外界通信时，都要在NAT路由器上将其本地IP地址转换成全球IP地址，才能和互联网连接
- 当 NAT 路由器具有 n 个全球 IP 地址时，专用网内最多可以同时有 n 台主机接入到互联网
- 可以使专用网内较多数量的主机轮流使用 NAT 路由器有限数量的全球 IP 地址
- NAT并不能节省IP地址
#### 网络地址与端口号转换 NAPT
- 使用运输层端口号的 NAT 叫做网络地址与端口号转换 NAPT (Network Address and Port Translation)
- NAPT 可以使多台拥有本地地址的主机，共用一个全球IP地址，同时和互联网上的不同主机进行通信
- NAPT 把专用网内不同的源 IP 地址都转换为相同的全球 IP 地址，将 TCP 源端口号转换为不同的新的 TCP 端口号
- 收到从互联网发来的应答时，从 IP 数据报的数据部分找出运输层端口号，从 NAPT 转换表中找到正确的目的主机
#### NAT的优势
- 节省合法地址，减少地址冲突
- 灵活连接Internet
- 保护局域网的私密性
#### NAT的问题和缺点
- 违反了IP的结构模型，路由器处理传输层协议
- 违反了端到端的原则
- 违反了最基本的协议分层规则
- 不能处理IP报头加密
- 新型网络应用的设计者必须要考虑NAT场景，如P2P应用程序

## 多协议标签交换 MPLS
### 要解决的问题
- 当网络很大时，查找路由表要花费很多时间
- 在出现突发通信时，缓存会溢出，引起分组丢失、传输时延增大和服务质量下降
### MPLS（MultiProtocol Label Switching）
互联网建设标准
#### 多协议
在MPLS的上层可以采用多种协议
#### 标签
MPLS利用面向连接技术，使每个分组携带一个叫做标签（label）的小整数。标签交换路由器用标签值检索转发表，实现分组的快速转发
### MPLS报文结构
- MPLS 不要求下层的网络都使用面向连接的技术
- MPLS 采用封装技术：在把 IP 数据报封装成以太网帧之前，先要插入一个 MPLS 首部
- 从层次的角度看，MPLS 首部处在第二层和第三层之间

## 软件定义网络 SDN
### 概念
- 软件定义网络 SDN（Software Defined Network）由斯坦福大学N. McKeown 于 2009 年首先提出
- 谷歌于 2010-2012 年的数据中心网络 B4 进行了运行验证

#### 优点
- 提高网络带宽利用率
- 网络运行更加稳定
- 管理更加高效简化
- 运行费用明显降低
### SDN与协议OpenFlow
#### SDN
- 是一个体系结构，是一种设计、构建和管理网络的新方法或新概念
- 把控制层面和数据层面分离，而让控制层面利用软件控制数据层面中的许多设备
#### OpenFlow
- SDN 体系结构中控制层面和数据层面之间的通信接口
- 使控制层面的控制器可以对数据层面中的物理或虚拟设备进行直接访问和操纵
- 在逻辑上是集中式的、基于流的

**注意**
- SDN 不是 OpenFlow
- SDN 未规定必须使用 OpenFlow
#### OpenFlow 数据层面：流表
##### 流表 (flow table)
规定“匹配 + 动作”
##### 流
穿过网络的一种分组序列，而在此序列中的分组都共享分组首部某些字段的值

数据层面的分组交换机或 OpenFlow 交换机完成“匹配 + 动作”，称为广义转发

SDN 远程控制器通过一个安全信道，使用 OpenFlow 协议来管理 OpenFlow 交换机中的流表

### SDN 体系结构
#### SDN 体系结构的四个关键特征
- 基于流的转发。流表规定转发规则
- 数据层面与控制层面分离。两者不在同一个设备中
- 网络控制功能位于数据层面交换机之外，用软件实现
- 可编程的网络
#### SDN 与传统网络的差别
##### SDN
- 功能分散。交换机、SDN 控制器、网络控制应用程序都是可以分开的实体
- 可以由不同的厂商和机构来提供
##### 传统网络
- 控制层面、数据层面、协议的实现都垂直集成在一个机器里
- 由单独的厂商提供

# 运输层（Transport Layer）
## 运输层概述
### 为什么需要运输层
- 网络层实现了异构网络之间的通信，尽最大努力在主机之间交付数据
- 但仍然遗留了一些问题
  - 参与通信的主机中，到底谁在发送和接收应用程序的数据
  - 如果出现了分组的重复、丢失、失序等不可靠传输的问题，如何处理
### 运输层的地位
- 运输层是面向通信部分的最高层
- 同时，运输层是用户功能中的最低层
### 进程之间的通信
- 主机之间的通信，实际上是两台主机中的应用进程之间的通信，并且往往是一台主机上的多个进程同时和另一台主机上的多个进程之间的通信
- 发送方不同的应用进程可以使用同一个运输层的协议传输数据
- 接收方的运输层在收到报文后能正确交付给目的应用进程
### 运输层提供的服务
因特网的网络层提供“尽力而为”的服务
- 网络层尽最大努力在终端间交付分组，但不提供任何承诺
- 具体来说，不保证交付，不保证按序交付，不保证数据完整，不保证延迟，不保证带宽等

传输层依赖并扩展网络层的服务，有所为，有所不为
- 传输层可以通过差错恢复，重排序等手段提供可靠、按序的交付服务
- 但传输层无法提供延迟保证、带宽保证等服务

传输层提供的最低限度的传输服务之一------进程到进程的数据交付
- 运输层提供应用进程之间的逻辑通信，在两个运输层实体之间建立端到端的逻辑通信信道
- 运输层向高层用户屏蔽了下面网络核心的细节

运输层提供的最低限度的传输服务之二------差错检测
- 运输层的差错检测将对运输层报文及其他信息进行检测
- 网络层的IP首部校验和仅检测IP首部而不检测数据部分
- 数据链路层校验用于检测收到的帧是否存在比特传输的错误
#### 运输层提供的增强服务
- 可靠传输
- 流量控制
- 拥塞控制等
### 运输层的两个主要协议
#### 互联网的正式标准
- 用户数据报协议 UDP (User Datagram Protocol)
- 传输控制协议 TCP (Transmission Control Protocol)
#### 可靠信道与不可靠信道
- 全双工可靠信道------使用面向连接的协议，如TCP
- 不可靠信道------使用无连接的协议，如UDP
#### 运输协议数据单元
- 两个对等运输实体在通信时传送的数据单位叫作运输协议数据单元 TPDU (Transport Protocol Data Unit)
- TCP 传送的数据单位协议是 TCP 报文段 (segment)
- UDP 传送的数据单位协议是 UDP 报文或用户数据报
#### UDP 与 TCP 的区别
##### UDP
- 传送数据之前不需要先建立连接
- 收到 UDP 报后，不需要给出任何确认
- 不提供可靠交付，但是一种最有效的工作方式
##### TCP
- 提供可靠的、面向连接的运输服务
- 不提供广播或多播服务
- 开销较多
#### 使用 UDP 和 TCP 的典型应用和应用层协议
##### UDP
| 应用层协议       | 应用                   |
|:----------------|:----------------------|
| DNS              | 域名解析服务           |
| DHCP             | 动态主机配置           |
| RIP              | 路由选择               |
| TFTP             | 文件传输               |
| 专用协议         | 流式多媒体通信         |

##### TCP
| 应用层协议 | 应用             |
|:------------|:----------------|
| HTTP         | 万维网 WWW      |
| SMTP         | 电子邮件        |
| FTP          | 文件传送        |
| TELNET       | 远程终端接入    |

#### 运输层的端口
##### 复用
应用进程都可以通过运输层再传送到 IP 层（网络层）
##### 分用
运输层从 IP 层收到发送给应用进程的数据后，必须分别交付给指明的各应用进程
##### 可能存在的问题
- 进程的创建和撤销都是动态的，因此发送方几乎无法识别其他机器上的进程
- 用户往往需要利用目的主机提供的功能来识别终点，而不需要知道具体实现这个功能的进程是哪一个
- 有时用户会改换接收报文的进程，但并不需要通知所有的发送方
- 不同操作系统的进程标识符不同

##### 端口号 (protocol port number)
- 在运输层使用协议端口号 (protocol port number)，或通常简称为端口 (port)
- 端口是通信的抽象终点
- 在一台主机中准确的找到某个进程
- 不受操作系统的限制
- 实现异构系统之间的通信
- 运输层协议把数据交给指定的端口，而不关心接口所代表的功能
- 操作系统只要让正确的进程对应正确的端口，那交付就不会出错

#### 软件端口与硬件端口
##### 软件端口
- 协议栈层间的抽象的协议端口
- 是应用层的各种协议进程与运输实体进行层间交互的地点
- 不同系统实现端口的方法可以不同
##### 硬件端口
不同硬件设备进行交互的接口

#### TCP/IP 运输层端口的标志
- 端口用一个 16 位端口号进行标志，允许有 65,535 个不同的端口号
- 端口号只具有本地意义，只是为了标志本计算机应用层中的各进程
- 在互联网中，不同计算机的相同端口号没有联系

#### 两大类、三种类型的端口
##### 服务器端使用的端口号
###### 熟知端口（系统端口号）
数值一般为0-1023，由公共域协议使用
###### 登记端口号
数值为1024-49151，为没有熟知端口号的应用程序使用的，需要在IANA登记
##### 客户端使用的端口号
###### 短暂端口号
数值为49152-65535，留给客户进程选择暂时使用
###### 通信结束后，释放端口

#### 通信需要同时知道对方的IP地址和端口号
- 通过IP地址寻找主机
- 通过端口号寻找进程

#### 套接字 socket=(IP地址:端口号)
##### UDP的套接字
- UDP的套接字使用 ```<IP地址,端口号>``` 二元组进行标识
- ```<目标IP地址,目标端口号>``` 相同的UDP报文被交付给同一个套接字，与 ```<源IP地址,源端口号>``` 无关
##### TCP的套接字
TCP连接套接字需要使用<源IP地址,目的IP地址,源端口号,目的端口号>四元组进行标识

一个TCP服务器为了同时服务很多个用户，使用监听套接字和连接套接字

每个连接套接字只与一个客户通信，即只接收具有以下四元组的报文段
- 源IP地址 = 客户IP地址，源端口号 = 客户套接字端口号
- 目的IP地址 = 服务器IP地址，目的端口号 = 服务器监听套接字的端口号


## 用户数据报协议UDP
### UDP概述
#### 网络层提供的服务（best-effort service）
- 尽最大努力将数据报交付到目的主机
- 不保证投递的可靠性和顺序
- 不保证带宽及延迟要求

#### UDP只在IP的数据报服务之上增加了一些功能
- 复用和分用
- 差错检测

#### UDP的主要特点
- 无连接。发送数据之前不需要建立连接
- 使用尽最大努力交付。即不保证可靠交付
- 面向报文。UDP一次传送和交付一个完整的报文
#### UDP是面向报文的
- 发送方UDP对应用层交下来的报文，既不合并，也不拆分，按原样发送
- 接收方UDP对IP层交上来的UDP用户数据报，去除首部后原封不动地交付上层的应用进程，一次交付一个完整的报文
- 应用程序必须选择合适大小的报文
  - 若报文太长，IP层在传送时可能要进行分片，降低IP层的效率
  - 若报文太短，会使IP数据报的首部相对长度太大，降低IP层的效率
#### UDP 的主要特点
- 无连接。发送数据之前不需要建立连接
- 使用尽最大努力交付。即不保证可靠交付
- 面向报文。UDP 一次传送和交付一个完整的报文。
- 没有拥塞控制。网络出现的拥塞不会使源主机的发送速率降低。很适合多媒体通信的要求
- 支持一对一、一对多、多对一、多对多等交互通信
- 首部开销小，只有 8 个字节

#### 为什么需要UDP
- 应用可以尽可能快地发送报文
  - 无建立连接的延迟
  - 不限制发送速率（不进行拥塞控制和流量控制）
- 报头开销小
- 协议处理简单

#### UDP适合哪些应用
##### 容忍丢包但对延迟敏感的应用
- IP电话
- 视频会议
- 多媒体应用等
##### 以单次请求/响应为主的应用
- 如DNS、RIP、DHCP等
##### 若应用要求基于UDP进行可靠传输
- 由应用层实现可靠性

### UDP的首部
#### 首部----8个字节，4个字段
      |源端口|目的端口| 长度 |检验和|
字节  |<- 2->|<-- 2 ->|<- 2->|<- 2->|  

端口用于实现UDP的复用和分用功能
###### 源端口
在需要对方回信时选用，不需要时可用全0
###### 目的端口
- 终点交付报文时必须使用
- 如果接收方UDP发现收到的报文中的目的端口号不正确（即不存在对应于该端口号的应用进程），就丢弃该报文，并由ICMP发送“端口不可达”差错报文给发送方
##### 长度和校验和用于实现差错检测

UDP用户数据报的长度，其最小值是8（仅有首部）

###### 检验和
- 检测UDP用户数据报在传输中是否有错。首部和数据部分一起参加计算，有错就丢弃

#### UDP用户数据报----2个字段：首部和数据
|首部|数据|
#### UDP用户数据报属于IP数据报的数据部分

## 传输控制协议 TCP
### TCP概述
TCP 是面向连接的运输层协议，在无连接的、不可靠的 IP 网络服务基础之上提供可靠交付的服务。为此，在 IP 的数据报服务基础之上，增加了保证可靠性的一系列措施
#### TCP主要特点
- TCP 是面向连接的运输层协议
- 每一条 TCP 连接只能有两个端点 (endpoint)，每一条 TCP 连接只能是点对点的（一对一）
- TCP在无连接、不可靠的IP之上，提供面向连接的可靠交付服务
  - 流水线式发送，报文段检错，丢失重传等
- TCP 提供全双工通信，发送方和接收方可以同时与对方收发数据
- 面向字节流
  - TCP 中的“流”(stream) 指的是流入或流出进程的字节序列
  - 面向字节流：可靠、有序的字节流，不保留报文边界
- 不同层保证传输可靠的方式
  - 面向连接的电路交换（物理层保证可靠）
通信双方之间必须有一条物理连接的通路（直接相连），且被通信双方独享，数据按序发送并按序接收
  - 面向连接的虚电路（网络层保证可靠）
通信双方采用复用技术，逐段占用物理通路，每段物理通路可被多对通信使用，分组按序发送并按序接收
  - 面向连接TCP（运输层协议保证可靠）
采用协议的方法（确认、序号、重传），确保通信双方有一条全双工的、可靠的逻辑信道（事实上，提供服务的IP数据报是不可靠的），字节按序发送并按序接收（但网络层IP数据报不一定按序到达）

#### TCP 面向流的概念
接收方应用程序收到的字节流必须和发送方应用程序发出的字节流完全一样

不保留报文边界

### TCP首部
#### TCP报文特点
- TCP传送的数据单元却是报文段
- 一个 TCP 报文段分为首部和数据两部分，而 TCP 的全部功能都体现在它首部中各字段的作用
- TCP 报文段首部的前 20 个字节是固定的，后面有 4n 字节是根据需要而增加的选项 (n 是整数)。因此 TCP 首部的最小长度是 20 字节

#### TCP首部格式
```
     0       8             16     24     31
     |   源端口            |   目的端口  |-----
     |              序  号               |
     |              确认号               | 20
TCP  |数据|    |U|A|P|R|S|F|             |字节
首部 |    |保留|R|C|S|S|Y|I|    窗口     |固定
     |偏移|    |G|K|H|T|N|N|             |首部
     |       检 验 和      |   紧急指针  |_____
     |        选  项（长度可变）  | 填充 | 
```
##### 源端口和目的端口
各占2字节，是运输层与应用层的服务接口
##### 序号
占4字节，TCP连接中传送的数据流中的每一个字节都有一个序号。序号字段的值则指的是本报文段所发送的数据的每一个字节的序号
##### 确认号
占4字节，是期望收到对方的下一个报文段的数据的第一个字节的序号

**若确认号 = N，则表明：到序号 N – 1 为止的所有数据都已正确收到**
##### 数据偏移（即首部长度）
占4位，指出 TCP 报文段的数据起始处距离 TCP 报文段的起始处有多远。即TCP头部长度，单位是 32 位字（以 4 字节为计算单位）
##### 保留
占6位，保留为今后使用，但目前应置为0
##### 紧急URG
控制位。当 URG = 1 时，表明紧急指针字段有效，告诉系统此报文段中有紧急数据，应尽快传送 (相当于高优先级的数据)
##### 确认ACK
控制位。只有当 ACK =1 时，确认号字段才有效。当 ACK =0 时，确认号无效
##### 推送 PSH (PuSH)
控制位。接收 TCP 收到 PSH = 1 的报文段后，就尽快（即“推送”向前）交付接收应用进程，而不再等到整个缓存都填满后再交付
##### 复位 RST (ReSeT)
控制位。当 RST=1 时，表明 TCP 连接中出现严重差错（如主机崩溃或其他原因），必须释放连接，然后再重新建立运输连接
##### 同步 SYN (SYNchronization) 
控制位。同步 SYN = 1 表示这是一个连接请求或连接接受报文。
- 当 SYN = 1，ACK = 0 时，表明这是一个连接请求报文段
- 当 SYN = 1，ACK = 1 时，表明这是一个连接接受报文段
##### 终止 FIN (FINish)
控制位。用来释放一个连接。FIN=1 表明此报文段的发送端的数据已发送完毕，并要求释放运输连接
##### 窗口
占 2 字节。窗口值告诉对方：从本报文段首部中的确认号算起，接收方目前允许对方发送的数据量（以字节为单位）

**窗口字段明确指出了现在允许对方发送的数据量。窗口值经常在动态变化**

##### 检验和
- 占 2 字节。检验和字段检验的范围包括首部和数据这两部分
- 在计算检验和时，要在 TCP 报文段的前面加上 12 字节的伪首部
- 在计算检验和时，临时把 12 字节的“伪首部”和 TCP 报文段连接在一起。伪首部仅仅是为了计算检验和
##### 紧急指针
占 2 字节。在 URG = 1时，指出本报文段中的紧急数据的字节数（紧急数据结束后就是普通数据），指出了紧急数据的末尾在报文段中的位置
##### 选项
长度可变，最长可达 40 字节
##### 填充
使整个 TCP 首部长度是 4 字节的整数倍

#### 选项----最大报文长度MSS(Maximum Segment Size)
MSS (Maximum Segment Size)是 TCP 报文段中的数据字段的最大长度。与接收窗口值没有关系
- 建立连接时，每个主机可声明自己能够接受的MSS，缺省为536字节

##### MSS与TCP报文段、数据字段的关系
- 数据字段长度不能超过MSS
- TCP 报文段长度 = 数据字段长度 + TCP 首部长度
- 数据字段长度 = TCP 报文段长度 – TCP 首部长度
- IP数据报长度 = MTU = IP首部长度 + TCP报文段长度

##### 最大报文段长度 MSS的要求
###### 不能太小
- 网络利用率降低
- 例如：仅 1 个字节。利用率就不会超过1/41
###### 不能太大
- 开销增大
- IP 层传输时要分片，终点要装配
- 分片传输出错时，要整个分组
###### 应尽可能大
- 只要在 IP 层传输时不再分片
- 默认值= 536 字节
  - 报文段长度 = 536 + 20 = 556 字节
  - IP 数据报长度 = 576 字节

#### 选项----窗口扩大（window scale）
建立连接时，双方可以协商一个窗口比例因子，实际接收窗口大小 = window size * 2^window scale
#### 选项----时间戳（timestamp）
占 10 字节。最主要的 2 个字段
- 时间戳值字段（4字节）
- 时间戳回送回答字段（4字节）
2 个主要功能

计算往返时间 RTT

防止序号绕回 PAWS (Protect Against Wrapped Sequence numbers)：2^32的序号空间对于高带宽很容易消耗完。序号重复时，为了使接收方能够把新报文段和迟到很久的旧报文段区分开，可以在报文段中加上时间戳

#### 选项----选择确认（SACK）
最初的TCP协议只使用累计确认，改进的TCP协议引入选择确认，允许接收端指出缺失的数据字节

### 可靠传输工作原理
TCP在不可靠的IP服务上建立可靠的数据传输
#### 理想传输条件的特点
- 传输信道不产生差错（不纠错）
- 不管发送方以多快的速度发送数据，接收方总是来得及处理收到的数据（不进行流量控制）
- 在乌托邦式的理想传输条件下，不需要采取任何措施就能够实现可靠传输，接近于无确认无连接服务
- 但实际网络都不具备理想传输条件。必须使用一些可靠传输协议，在不可靠的传输信道实现可靠传输
#### 停止等待协议
##### 协议概述
每发送完一个分组就停止发送，等待对方的确认。在收到确认后再发送下一个分组。确认的内容不重要

全双工通信的双方既是发送方也是接收方
##### 协议过程
无差错情况
- 发送方A发送消息M1，发送结束后发送方A停止发送，等待ACK
- 接收方B确认M1，发送ACK1
- 发送方A收到ACK1，继续发送M2
- 发送方A在M2发送结束后停止发送，等待ACK
- 接收方B确认M2
###### 出现差错
两种可能的差错情况，B不会发出确认
- 分组错误
B接收M1时检测出了差错，就丢弃M1，其他什么也不做
- 分组丢失
M1在传输过程中丢失了，B不知道，什么都不会做
##### 解决方法----超时重传
- A为每一个已发送的分组设置一个超时计时器
- A只要在超时之前收到确认，就撤销该超时计时器，继续发送下一个分组M2
- 若A在超时计时器规定时间内没有收到B的确认，就认为分组错误或丢失，就重发该分组
##### 确认丢失和确认迟到
###### 确认丢失
- B正确接收M1，但对M1的确认丢失，那么A在设定的超时重传时间内将不会收到确认，不能确定B已经收到M1，因此A在超时计时器到期后重传M1
- 假定B正确收到了A重传的分组M1，则
  - 丢弃这个重复的分组M1，不向上层交付
  - 向A发送确认
###### 确认迟到
- B对分组M1的确认迟到了，A在超时计时器到期前，未收到对M1的确认，A误认为M1的发送有差错，因此A在计时器到期后重传M1
- B会收到重复的M1,丢弃重复的M1，并再次确认分组
- A会丢弃重复收到的确认
##### 停止等待协议要点
- 停止等待。发送方每次只发送一个分组。在收到确认后再发送下一个分组
- 暂存：在发送完一个分组后，发送方必须暂存已发送的分组的副本，以备重发
- 编号：对发送的每个分组和确认都进行编号
- 超时重传：发送方为发送的每个分组设置一个超时计时器。若超时计时器超时位收到确认，发送方会自动超时重传分组
- 超时计时器的重传时间应当比数据在分组传输的平均往返时间更长一些，防止不必要的重传
- 自动重传请求ARQ(Automatic Repeat reQuest)：重传的请求是发送方自动进行的
- 简单，但信道利用率太低，因为停止-等待机制降低了信道利用率
  - 信道利用率U = TD / (TD + RTT + TA)
  - 当往返时间RTT远大于分组发送时间TD时，信道的利用率会非常低

信道利用率太低的解决方法：通过流水线传输提高效率

流水线传输：在收到确认之前，发送方连续发出多个分组

由于信道上一直有数据不间断地传送，流水线传输可获得很高的信道利用率

连续 ARQ 协议和滑动窗口协议采用流水线传输方式
#### 连续ARQ协议
##### 概念
###### 发送窗口
发送方维持一个发送窗口，位于发送窗口内的分组都可被连续发送出去，而不需要等待对方的确认。即发送方一次可以发送多个分组
###### 发送窗口滑动
发送方每收到一个确认，就把发送窗口向前滑动一个分组的位置。控制发送方和接收方所能发送和接收的分组的数量和编号
###### 累积确认
接收方对按序到达的最后一个分组发送确认，表示到这个分组为止的所有分组都已正确收到了
##### 连续ARQ的原理
- 发送方维持发送窗口
- 收到一个确认后，发送窗口向前滑动
##### 累积确认
累计确认是对按序到达的最后一个分组发送确认
###### 优点
容易实现，即使确认丢失也不必重传
###### 缺点
不能向发送方反映出接收方已经正确收到的所有分组的信息
##### Go-back-N
- 连续 ARQ 协议采用 Go-back-N（回退N）
- Go-back-N（回退N）表示需要再退回来重传已发送过的 N 个分组
###### 基本原理
当发送方发送了N个帧后，若发现该N帧的前一个帧在计时器超时后仍未返回其确认信息，则该帧被判为出错或丢失，此时发送方就重新发送出错帧及其后的N帧

当通信线路质量不好时，连续 ARQ 协议会带来负面的影响

#### 连续ARQ协议与停止等待协议对比
| 项目             | 连续 ARQ 协议         | 停止等待协议     |
|:----------------|:---------------------|:----------------|
| 发送的分组数量   | 一次多个              | 一次一个         |
| 传输控制         | 滑动窗口              | 停止、等待       |
| 确认             | 单独确认，累计确认    | 单独确认         |
| 超时计时器       | 每个分组              | 每个分组         |
| 序号             | 每个分组              | 每个分组         |
| 重传             | 回退 N                | 一个分组         |


## TCP 可靠传输的实现
### 以字节为单位的滑动窗口
#### 相关概念
- TCP 使用流水线传输和滑动窗口协议实现高效、可靠的传输
- TCP 的滑动窗口是以字节为单位的
- 发送方 A 和接收方 B 分别维持一个发送窗口和一个接收窗口
- 发送窗口
在没有收到确认的情况下，发送方可以连续把窗口内的数据全部发送出去。凡是已经发送过的数据，在未收到确认之前都必须暂时保留，以便在超时重传时使用
- 接收窗口
只允许接收落入窗口内的数据
#### 发送窗口
- A 根据 B 给出的窗口值，构造出自己的发送窗口
- 发送窗口里面的序号表示允许发送的序号
- 窗口越大，发送方就可以在收到对方确认之前连续发送更多的数据，因而可能获得更高的传输效率
- A 的发送窗口未收到确认前位置不变
- P1 = 后沿，P2 = 当前，P3 = 前沿
- P3 – P1 = A 的发送窗口（又称为通知窗口）
- P2 – P1 = 已发送但尚未收到确认的字节数
- P3 – P2 = 允许发送但尚未发送的字节数（又称为可用窗口）
- P1之前的是已发送并收到确认的字节数
- P3之后的是待发送，但当前不允许发送的字节数
#### 接收窗口
- B 收到了序号为 32 和 33 的数据，但未收到序号为 31 的数据
- 因此，因此发送的确认报文段中的确认号是 31（即期望收到的序号）
#### 窗口的滑动
- A会保留B未确认收到的序号，B会从第一个未收到的序号开始要求A发送
- A按B的要求发送，B连续收到后，前移窗口
- B前移窗口后，继续要求A从B未收到的第一个序号开始发送
- A收到B的确认后，前移窗口，可用窗口增大
- A持续发送直到可用窗口为0
- A在收到B的确认前，不能再发送任何数据
- 当B对A做出更高序号确认后，重复上述过程

#### 发送缓存
- 发送方的应用进程把字节流写入 TCP 发送缓存
- 缓存中的字节数 = 发送应用程序最后写入缓存的字节 - 最后被确认的字节
- 发送窗口是发送缓存的一部分，用于暂时存放
  - 发送应用程序传送给发送方 TCP 准备发送的数据
  - TCP 已发送出但尚未收到确认的数据
#### 接收缓存
- 发接收方应用进程从TCP接收缓存中读取尚未被读取的字节
- 及时读取，窗口可增大；反之窗口减小，窗口=0则不能再接收
- 接收窗口是接收缓存的一部分，用于暂时存放
  - 按序到达的、但尚未被接收应用程序读取的数据
  - 未按序到达的数据

#### 需要注意的问题
- 发送窗口是根据接收窗口设置的，但在同一时刻，发送窗口并不总是和接收窗口一样大
  - 因为有一定的时间滞后
- TCP 标准没有规定对不按序到达的数据应如何处理
  - 通常是先临时存放在接收窗口中，等到字节流中所缺少的字节收到后，再按序交付上层的应用进程
- TCP 要求接收方必须有累积确认的功能，以减小传输开销。接收方可以在合适的时候发送确认，也可以在自己有数据要发送时把确认信息顺便捎带上（捎带确认实际上并不经常发生）
  - 但接收方不应过分推迟发送确认，否则会导致发送方不必要的重传

### 超时重传时间的选择
TCP 发送方在规定的时间内没有收到确认就要重传已发送的报文段

但重传时间的选择是 TCP 最复杂的问题之一

互联网环境复杂，IP 数据报所选择的路由变化很大，导致运输层的往返时间 (RTT) 的变化也很大，重传时间难以测定
- 重传时间太短会引起很多报文段的不必要重传，使网络负荷增大
- 重传时间过长会使网络的空闲时间增大，降低了传输效率

TCP 采用了一种自适应算法，它记录一个报文段发出的时间，以及收到相应确认的时间。这两个时间之差就是报文段的往返时间 RTT

#### 加权平均往返时间 RTTS 
加权平均往返时间 RTTS 又称为平滑的往返时间

新的 RTTS = (1 - α) * (旧的RTTS) + α * (新的 RTT 样本)

- 其中，0≤α<1
- 若α→0，表示 RTT 值更新较慢
- 若α→1，表示 RTT 值更新较快
- RFC 6298 推荐的α值为 1/8，即 0.125

#### 超时重传时间 RTO
RTO (Retransmission Time-Out) 应略大于加权平均往返时间 RTTS

RFC 6298 建议 RTO
RTO = RTTS + 4 * RTTD
- 其中，RTTD是RTT偏差的加权平均值

##### RFC 6298 建议 RTTD 
新的 RTTD = (1 - β) * (旧的 RTTD) + β |RTTS - 新的RTT样本|

其中，β是个小于1的系数，其推荐值是1/4，即0.25

#### Karn 算法
TCP确认存在二义性，使得测量到的RTT不准确
- 重传的TCP报文段使用与原报文段相同的序号
- 发送方收到确认后，无法得知是对那个报文段进行的确认
##### 解决方法
在计算平均往返时间 RTT 时，只要报文段重传了，就不采用其往返时间样本
##### 新问题
当报文段的时延突然增大很多时，在原来得出的重传时间内，不会收到确认报文段，于是就重传报文段。但根据 Karn 算法，不考虑重传的报文段的往返时间样本。这样，超时重传时间就无法更新，造成很多不必要的重传

#### 修正的 Karn 算法
##### 解决方法
每次出现计时器超时，就把超时时间RTO增大（网络可能不佳，后续确认可能会到达的比较慢）

新的 RTO = γ * (旧的 RTO) 

系数γ的典型值 = 2

当不再发生报文段的重传时，才根据报文段的往返时延更新平均往返时延 RTT 和超时重传时间 RTO 的数值

### 选择确认 SACK
##### 问题
若收到的报文段无差错，只是未按序号，中间还缺少一些序号的数据，那么能否设法只传送缺少的数据而不重传已经正确到达接收方的数据？
##### 解决方法
使用选择确认SACK(Selective ACK) ，RFC2018规定，在TCP首部中都增加了 可选字段 SACK 选项，以便报告收到的不连续的字节块的边界

## TCP的流量控制
### 为什么要进行流量控制
通过确认和重传机制，可以让发送方确认接收方已正确收到数据

接收方收不到数据，则无法做出确认

大量的丢包和重传，显然不是一种高效的工作方式
### 利用滑动窗口实现流量控制
#### 概念
- 流量控制 (flow control) 
让发送方的发送速率不要太快，使接收方来得及接收
- 利用滑动窗口机制可以很方便地在 TCP 连接上实现对发送方的流量控制

使用滑动窗口实现流量控制这一过程与TCP首部中的序号、确认号、窗口3个字段有关

发送窗口随着实际接收窗口值大小变化

#### 持续计时器(persistence timer)
持续计时器(persistence timer)：收到对方的零窗口通知即启动

若持续计时器设置的时间到期，就发送一个零窗口探测报文段（仅携带1字节的数据），对方在确认这个探测报文段时给出当前窗口值
- 若窗口仍然是零，收到这个报文段的一方就重新设置持续计时器
- 若窗口不是零，则死锁的僵局就可以打破了

### TCP的传输效率
#### 控制TCP发送报文段的时机：三种机制
- TCP 维持一个变量，它等于最大报文段长度 MSS。只要缓存中存放的数据达到 MSS 字节时，就组装成一个 TCP 报文段发送出去
- 由发送方的应用进程指明要求发送报文段，即 TCP 支持的推送 (push) 操作
- 发送方的一个计时器期限到了，这时就把当前已有的缓存数据装入报文段（但长度不能超过 MSS）发送出去
- 如何控制 TCP 发送报文段的时机仍然是一个较为复杂的问题

#### 糊涂窗口综合症
##### 糊涂窗口综合症定义
每次仅发送一个字节或很少几个字节的数据时，有效数据传输效率变得很低的现象
##### 发送方糊涂窗口综合症
- 发送方 TCP 每次接收到一字节的数据后就发送
- 发送一个字节需要形成 41 字节长的 IP 数据报。效率很低
###### 解决方法
使用 Nagle 算法（发送方会等待多一点数据再发送）
##### 接收方糊涂窗口综合症
接收方应用进程消耗数据太慢，导致接收缓存被占满
###### 解决方法
让接收方等待一段时间，使得或者接收缓存已有足够空间容纳一个最长的报文段，或者等到接收缓存已有一半空闲的空间。只要出现这两种情况之一，接收方就发出确认报文，并向发送方通知当前的窗口大小

## TCP 的拥塞控制
### 拥塞控制的一般原理
在某段时间，若网络中有许多资源同时产生拥堵的情况，网络的性能就要明显变坏，整个网络的吞吐量将随输入负荷的增大而下降。这种现象称为拥塞 (congestion)
#### 表现
分组延迟增大，网络吞吐量下降，甚至降为0（系统崩溃）
#### 拥塞产生的原因
- 节点缓存容量太小
- 链路容量不足
- 处理机处理速率太慢
- 拥塞本身会进一步加剧拥塞
#### 出现网络拥塞的原因可以总结为
∑对资源需求 > 可用资源

单纯靠增加某个拥堵点设备的资源，在许多情况下，不但不能解决网络堵塞问题，而且还可能使网络的性能更坏

例如
- 增大缓存，但未提高输出链路的容量和处理机的速度，排队等待时间将会大大增加，引起大量超时重传，解决不了网络拥塞
- 提高处理机处理的速率会将瓶颈转移到其他地方
- 拥塞引起的重传并不会缓解网络的拥塞，反而会加剧网络的拥塞
#### 增加全局资源，也不能解决网络堵塞
- 拥塞是一个全局问题，网络整体资源的增加肯定是有用的
- 但完全依赖增加资源不能解决拥塞，用户对网络资源的需求是无限的，但网络资源不是无限的
#### 拥塞控制
- 解决拥塞的办法：增加资源（较少资源需求） + 控制发送量（拥塞控制）
- 拥塞控制就是防止过多的数据注入到网络中，避免网络中的路由器或链路过载
- 拥塞控制的前提：网络能够承受现有的网络负荷
- 网络拥塞是一个非常复杂的动态的问题，拥塞控制是否合理，直接影响网络性能和效率（控制位置、控制不够、控制过头）
- 在许多情况下，甚至正是拥塞控制本身成为引起网络性能恶化，甚至发生死锁的原因
#### 拥塞控制的一般原理
##### 开环控制
- 在设计网络时，事先考虑周全，力求工作时不发生拥塞
- 思路：力争避免发生拥塞
- 但一旦整个系统运行起来，就不再中途进行改正了
##### 闭环控制
- 基于反馈环路的概念
- 根据网络当前运行状态采取相应控制措施
- 思路：监测网络发生拥塞的位置和时机，并采取措施进行控制，消除拥塞

#### 闭环控制的一般思路
##### 发现拥塞
可以判断拥塞增长的指标有
- 分组丢弃增加
- 平均队列长度增加
- 超时重传的分组数增加
- 平均分组时延增加
- 分组时延的标准差增加
- ......

**分组的丢失是网络发生拥塞的征兆，而不是原因**

##### 控制拥塞
采取的策略
- 发送“通知拥塞发生”的分组给源站
- 在分组中保留表示拥塞状态的字段
- 周期性地发出探测分组等
- 选择合适的时机调整网络状态

### TCP 的拥塞控制方法
TCP 采用基于滑动窗口的方法进行拥塞控制，属于闭环控制方法

TCP 发送方维持一个拥塞窗口 cwnd (Congestion Window)，控制发送速率

- 拥塞窗口的大小取决于网络的拥塞程度，并且是动态变化的
- 发送端利用拥塞窗口根据网络的拥塞情况调整发送速率
rate = cwnd / RTT Bytes/sec
- 发送窗口大小不仅取决于接收方窗口，还取决于网络的拥塞状况
#### 控制拥塞窗口变化的原则
- 只要网络没有出现拥塞，拥塞窗口就可以再增大一些，以便把更多的分组发送出去，提高网络的利用率
- 但只要网络出现拥塞或有可能出现拥塞，就必须把拥塞窗口减小一些，以减少注入到网络中的分组数，缓解网络出现的拥塞
#### 发送方判断拥塞的方法：隐式反馈
- 超时重传计时器超时
网络已经出现了拥塞
- 收到 3 个重复的确认
预示网络可能会出现拥塞
- 因传输出差错而丢弃分组的概率很小（远小于1 %）
- 因此，发送方在超时重传计时器启动时，就判断网络出现了拥塞

#### TCP的4种拥塞控制算法（RFC 5681）
假定接收方接受能力无限大
##### 慢开始 (slow-start)
###### 目的
探测网络的负载能力或拥塞程度
###### 算法
由小到大逐渐增大注入到网络中的数据字节，即：由小到大逐渐增大拥塞窗口数值
###### 慢开始的基本思想
- 在新建连接上指数增大cwnd，直至检测到丢包（此时终止慢启动）
- 希望迅速增大cwnd至可用的发送速度
###### 慢开始门限（Slow Start Threshold）
防止拥塞窗口cwnd增长过大引起网络堵塞
- 用法
  - 当 cwnd < ssthresh 时，使用慢开始算法
  - 当 cwnd > ssthresh 时，停止使用慢开始算法，改用拥塞避免算法
  - 当 cwnd = ssthresh 时，既可使用慢开始算法，也可使用拥塞避免算法
###### 拥塞窗口 cwnd 增大
在每收到一个对新的报文段的确认（经过一个RTT），就把拥塞窗口增加最多一个发送方的最大报文段 SMSS  (Sender Maximum Segment Size) 的数值。即发送方每收到一个新报文段的确认（重传的不算在内）就使cwnd加1
##### 拥塞避免 (congestion avoidance)
###### 目的
- 让拥塞窗口cwnd缓慢地增大，避免出现拥塞

使拥塞窗口cwnd按线性规律缓慢增长

拥塞避免并非完全避免拥塞，而是让拥塞窗口增长的缓慢些，使网络拥塞来的晚一些

###### 拥塞窗口cwnd增大
每经过一个往返时间RTT（不管在此期间收到了多少确认），发送方的拥塞窗口cwnd = cwnd + 1

当网络出现拥塞时，发送方重传定时器超时
- ssthresh = max (cwnd/2,2)
- cwnd = 1
- 执行慢开始算法
###### 目的
迅速减少主机发送到网络中的分组数，使得发生拥塞的路由器有足够时间把队列中积压的分组处理完毕
##### 快重传 (fast retransmit)
快重传 FR (Fast Retransmission) 算法
###### 目的
让发送方尽早知道发生了个别报文段的丢失

发送方只要连续收到三个重复的确认，就立即进行重传（即“快重传”），这样就不会出现超时

使用快重传可以使整个网络的吞吐量提高约 20%

快重传算法要求接收方立即发送确认，即使收到了失序的报文段，也要立即发出对已收到的报文段的重复确认

**注意**
快重传并非取消重传计时器，而是在某些情况下可以更早地（更快地）重传丢失的报文段
##### 快恢复 (fast recovery)
快恢复 FR (Fast Recovery)算法

当发送端收到连续三个重复的确认时，不执行慢开始算法，而是执行快恢复算法 FR (Fast Recovery) 算法：
- 慢开始门限 ssthresh = 当前拥塞窗口 cwnd / 2 
- 乘法减小 MD (Multiplicative Decrease) 拥塞窗口
- 新拥塞窗口 cwnd = 慢开始门限 ssthresh
- 执行拥塞避免算法，使拥塞窗口缓慢地线性增大（加法增大 AI）
###### 目的
减少一些主机发送到网络中的分组数，避免进一步加剧拥塞，但又不至于使网络性能下降太多

###### 加法增大，乘法减小（AIMD算法）
- 在拥塞避免阶段，拥塞窗口是按照线性规律增大的，这常称为“加法增大”（AI,Additive Increase）
- 当出现超时或3个重复的确认时，就要把门限值设置为当前拥塞窗口值的一半，并大大减小拥塞窗口的数值。这常称为“乘法减小”MD（Multiplicative Decrease）

### TCP拥塞控制与流量控制的区别
#### 作用范围
##### 流量控制
端到端的问题
##### 拥塞控制
全局性的过程
#### 基本控制策略
##### 流量控制
抑制发送端发送数据的速率，以便使接收端来得及接收
##### 拥塞控制
防止过多的数据注入到网络中，使网络中的路由器或链路不致过载
#### 主动方
##### 流量控制
接收方接收能力
##### 拥塞控制
发送方自己判断网络拥塞情况
### 发送窗口的上限值
#### 发送窗口到底由什么决定
发送窗口的上限值 = Min[rwnd,cwnd]
- 当 rwnd < cwnd 时，是接收方的接受能力限制发送窗口的最大值
- 当 cwnd < rwnd 时，是网络拥塞限制发送窗口的最大值

## 主动队列管理AQM
### 概念
#### TCP拥塞控制和网络层采取的策略有密切联系
例如
- 若路由器对某些分组的处理时间特别长，就可能引起发送方TCP超时，对这些报文段进行重传
- 重传会使TCP连接的发送端认为在网络中发生了拥塞，但实际上网络并没有发生堵塞
### 路由器分组管理策略
#### 先进先出FIFO（First In First Out）处理规则
##### 尾部丢弃策略 (tail-drop policy)
当队列已满时，以后到达的所有分组（如果能够继续排队，这些分组都将排在队列的尾部）将都被丢弃

对TCP拥塞控制影响最大的就是路由器的分组丢弃策略

路由器的尾部丢弃往往会导致一连串分组的丢失，这就使发送方出现超时重传，使TCP进入拥塞控制的慢开始状态
- 队列满时，TCP重传定时器超时，重新开始慢启动，减少数据率
- 分组离开队列，之后执行慢启动增大数据传输率
- 队列又满时，TCP重传定时器超时，重新再次开始慢启动，减少数据率

#### 严重问题----全局同步
尾部丢弃策略可能导致多个发送方的数据被丢弃，并出现超时重传，使多个TCP连接同时进入慢开始状态，发生全局同步（global syncronization）
#### 主动队列管理 AQM
- 主动：不要等到路由器的队列长度已经达到最大值时才不得不丢弃后面到达的分组，而是在队列长度达到某个值得警惕的数值时（即当网络拥塞有了某些拥塞征兆时），就主动丢弃到达的分组，避免全局同步
- AQM 可以有不同实现方法，其中曾流行多年的就是随机早期检测 RED (Random Early Detection)
- 多年的实践证明，RED 的使用效果并不太理想
- 但对路由器进行主动队列管理 AQM 仍是必要的。AQM 实际上就是对路由器中的分组排队进行智能管理，而不是简单地把队列的尾部丢弃

## TCP的运输连接管理
### 运输连接的三个阶段
#### TCP是面向连接的协议
#### TCP连接有三个阶段
##### 连接建立
##### 数据传送
##### 连接释放

TCP的连接管理就是使TCP连接的建立和释放都能正常地进行

### TCP的连接建立
#### TCP 连接建立过程中要解决的三个问题
- 要使每一方能够确知对方的存在
- 要允许双方协商一些参数（如最大窗口值、是否使用窗口扩大选项和时间戳选项以及服务质量等）
- 能够对运输实体资源（如缓存大小、连接表中的项目等）进行分配

#### TCP 连接的建立采用客户服务器方式
- 主动发起连接建立的应用进程叫做客户 (client)
- 被动等待连接建立的应用进程叫做服务器 (server)

#### TCP 建立连接的过程叫做握手

采用三报文握手：在客户和服务器之间交换三个 TCP 报文段，以防止已失效的连接请求报文段突然又传送到了，因而产生 TCP 连接建立错误
- 服务器B 的 TCP 服务器进程先创建传输控制块 TCB，准备接受客户进程的连接请求

客户A 的 TCP 向 B 主动发出连接请求报文段
- 其首部中的同步位 SYN = 1，并选择序号 seq = x，表明传送数据时的第一个数据字节的序号是 x
- TCP规定，SYN报文段（即SYN=1的报文段）不能携带数据，但要消耗掉一个序号

服务器B 的 TCP 收到连接请求报文段后，如同意，则发回确认
- B 在确认报文段中应使 SYN = 1，使 ACK = 1，其确认号 ack = x + 1，自己选择的序号 seq = y
- 这个报文段也不能携带数据，但同样要消耗掉一个序号

客户A 收到此报文段后向 B 给出确认，其 ACK = 1，确认号 ack = y + 1
- A 的 TCP 通知上层应用进程，连接已经建立
- TCP 标准规定：ACK 报文段可以携带数据。但如果不携带数据，则不消耗序号。下一个数据报文段的序号仍是 seq = x + 1

服务器B 的 TCP 收到主机 A 的确认后，也通知其上层应用进程：TCP 连接已经建立。双方可以开始数据传送

#### 采用三报文握手建立 TCP 连接的各个状态 
- SYN-SENT------同步已发送
- SYN-RCVD------同步收到
- ESTAB-LISHED--已建立连接

### TCP的连接释放
#### TCP 连接释放过程比较复杂
#### 数据传输结束后，通信的双方都可释放连接
#### TCP 连接释放过程是四报文握手
假设客户A 的应用进程先向其 TCP 发出连接释放报文段，并停止再发送数据，主动关闭 TCP 连接
- A 把连接释放报文段首部的 FIN = 1，其序号seq = u，等待 B 的确认
- TCP规定：FIN 报文段即使不携带数据，也消耗掉一个序号

服务器B 发出确认，ACK=1，确认号 ack = u+1，这个报文段的序号 seq = v
- TCP 服务器进程通知高层应用进程。从 A 到 B 这个方向的连接就释放了，TCP 连接处于半关闭 (half-close) 状态。A不再向B发送数据。但是B 若发送数据，A 仍要接收

若服务器B 已经没有要向 A 发送的数据，其应用进程就通知 TCP 释放连接 
- FIN=1，ACK=1，确认号 ack = u+1

收到连接释放报文段后，必须发出确认
- ACK=1，确认号 ack=w+1，自己的序号 seq = u + 1

**特别注意：此时 TCP 连接还没有释放掉。必须经过时间等待计时器 (TIME-WAIT timer) 设置的时间 2MSL 后，A 才释放 TCP 连接**

### TCP四个计时器
#### 超时重传计时器
#### 持续计时器（0窗口报文探测计时器）
#### 时间等待计时器
- 保证发送的最后一个 ACK 报文段能够到达 B。TCP协议的全双工连接能够可靠关闭
- 以保证本次连接的所有数据都从网络中消失，防止“已失效的连接请求报文段”出现在新连接中
#### 保活计时器
- 用来防止在 TCP 连接出现长时期空闲
- 通常设置为 2 小时，若服务器过了 2 小时还没有收到客户的信息，它就发送探测报文段
- 若发送了 10 个探测报文段（每一个相隔 75 秒）还没有响应，就假定客户出了故障，因而就终止该连接

### TCP 的有限状态机


# 应用层（application Layer）
## 应用层协议
### 定义
精确定义不同主机中的多个应用进程之间的通信规则
### 包括
- 应用进程交换的报文类型，如请求报文和响应报文
- 各种报文类型的语法，如报文中的各个字段及其详细描述
- 字段的语义，即包含在字段中的信息的含义
- 进程何时、如何发送报文，以及对报文进行响应的规则
### 特点
- 每个应用层协议都是为了解决某一类应用问题，而问题的解决又往往是通过位于不同主机中的多个应用进程之间的通信和协同工作来完成的。应用层的具体内容就是规定应用进程在通信时所遵循的协议
- 应用层的许多协议都是基于客户服务器方式。客户（client）和服务器（server）都是指通信中所涉及的两个应用进程。客户服务器方式所描述的是进程之间服务和被服务的关系。客户是服务请求方，服务器是服务提供方

## 域名系统DNS(Domain Name System)
### 域名系统概述
#### 域名系统 DNS (Domain Name System)
- 互联网使用的命名系统
- 用来把人们使用的机器名字（域名）转换为 IP 地址
- 为互联网的各种网络应用提供了核心服务

许多应用层软件经常直接使用域名系统DNS（Domain Name System），但计算机的用户只是间接而不是直接使用域名系统

互联网采用层次结构的命名树作为主机的名字，并使用分布式的域名系统DNS

名字到IP地址的解析是由若干个域名服务器程序完成的。域名服务器程序在专设的节点上运行，运行该程序的机器称为域名服务器

### 互联网的域名结构
#### 互联网采用层次树状结构的命名方法

任何一个连接在互联网上的主机或路由器，都有一个惟一的层次结构的名字，即域名
#### 域名的结构由标号序列组成，各标号之间用点隔开
...三级域名.二级域名.顶级域名

#### 各标号分别代表不同级别的域名
#### 域名只是一个逻辑概念

域名只是一个逻辑概念，并不代表计算机所在的物理地点

变长的域名和使用有助记忆的字符串，是为了便于人来使用。而IP地址是定长的32位二进制数字则非常便于机器进行处理

域名中的“点”和点分十进制IP地址中的“点”并无一一对应的关系。点分十进制IP地址中一定是包含3个“点”，但每一个域名中“点”的数目则不一定正好是3个

#### 顶级域名TLD(Top Level Domain)
##### 国家顶级域名nTLD

| 域名后缀 | 国家 |
|:----------|:------|
| .cn       | 中国  |
| .us       | 美国  |
| .uk       | 英国  |

##### 通用顶级域名gTLD
最早的顶级域名

| 域名后缀 | 适用对象               |
|:----------|:---------------------|
| .com       | 公司和企业             |
| .net       | 网络服务机构           |
| .org       | 非营利性组织           |
| .edu       | 美国专用的教育机构       |
| .gov       | 美国专用的政府部门       |
| .mil       | 美国专用的军事部门       |
| .int       | 国际组织               |

新增的通用顶级域名

| 域名后缀   | 适用对象                                |
|:------------|:------------------------------------------|
| .aero        | 航空运输企业                              |
| .biz         | 公司和企业                                |
| .cat         | 加泰罗尼亚人的语言和文化团体                  |
| .coop        | 合作团体                                  |
| .info        | 各种情况                                  |
| .jobs        | 人力资源管理者                              |
| .mobi        | 移动产品与服务的用户和提供者                    |
| .museum      | 博物馆                                    |
| .name        | 个人                                      |
| .pro         | 有证书的专业人员                              |
| .travel      | 旅游业                                    |

#### 互联网的域名空间结构
根没有名字

域名树的树叶就是计算机的名字，它不能再继续往下划分子域了

**注意：互联网的名字空间是按照机构的组织来划分的，与物理的网络无关，与 IP 地址中的“子网”也没有关系**

### 域名服务器
- 实现域名系统使用分布在各地的域名服务器（DNS 服务器）
- 一个服务器所负责管辖的（或有权限的）范围叫做区 (zone)
- 各单位根据具体情况来划分自己管辖范围的区。但在一个区中的所有节点必须是能够连通的
- 每一个区设置相应的权限域名服务器，用来保存该区中的所有主机的域名到 IP 地址的映射
- DNS服务器的管辖范围不是以“域”为单位，而是以“区”为单位

#### 树状结构的 DNS 域名
##### 根域名服务器
##### 顶级域名服务器
- org域名服务器
- com域名服务器
- edu域名服务器
- 其他域名服务器
##### 权限域名服务器
- 例如abc公司有2个权限域名服务器
  - abc.com域名服务器
  - y.abc.com域名服务器

**每个域名服务器都只对域名体系中的一部分进行管辖**

#### 域名服务器类型
根据所起的作用，分为四种类型：
##### 根域名服务器
- 根域名服务器是最高层次的域名服务器，也是最为重要的域名服务器
- 所有根域名服务器都知道所有的顶级域名服务器的域名和 IP 地址
- 不管是哪一个本地域名服务器，若要对互联网上任何一个域名进行解析，只要自己无法解析，就首先求助于根域名服务器
- 若所有的根域名服务器都瘫痪了，整个互联网中的 DNS 系统就无法工作了
- 在互联网上共有13个不同IP地址的根域名服务器，它们的名字是用一个英文字母命名，从a一直到m（前13个字母）
  - 根域名服务器共有 13 套装置，构成 13 组根域名服务器
  - 根域名服务器总共只有 13 个不同 IP 地址的域名，但并非仅由13台机器所组成
  - 这些根域名服务器相应的域名分别是
    - a.rootservers.net
    - b.rootservers.net
    - ...
    - m.rootservers.net
  - 到2016年2月，全世界已经在588个地点安装了根域名服务器，使世界上大部分DNS域名服务器都能就近找到一个根域名服务器

**注意：
根域名服务器并不直接把域名转换成 IP 地址（根域名服务器也没有存放这种信息），而是告诉本地域名服务器下一步应当找哪一个顶级域名服务器进行查询**

##### 顶级域名服务器
- 顶级域名服务器（即 TLD 服务器）负责管理在该顶级域名服务器注册的所有二级域名
- 当收到 DNS 查询请求时，就给出相应的回答（可能是最后的结果，也可能是下一步应当找的域名服务器的 IP 地址）
##### 权限域名服务器
- 负责一个区（zone）的域名服务器
- 当一个权限域名服务器还不能给出最后的查询回答时，就会告诉发出查询请求的 DNS 客户，下一步应当找哪一个权限域名服务器
##### 本地域名服务器 
- 本地域名服务器对域名系统非常重要
- 当一个主机发出 DNS 查询请求时，该查询请求报文就发送给本地域名服务器
- 每一个互联网服务提供者 ISP 或一个大学，都可以拥有一个本地域名服务器
- 当所要查询的主机也属于同一个本地 ISP 时，该本地域名服务器立即就能将所查询的主机名转换为它的 IP 地址，而不需要再去询问其他的域名服务器
- 本地域名服务器有时也称为默认域名服务器

#### 域名的解析过程
##### 递归查询
主机向本地域名服务器的查询一般都是采用递归查询。如果主机所询问的本地域名服务器不知道被查询域名的IP地址，那么本地域名服务器就以DNS客户的身份，向其他根域名服务器继续发出查询请求报文
##### 迭代查询
本地域名服务器向根域名服务器的查询通常是采用迭代查询。当根域名服务器收到本地域名服务器的迭代查询请求报文时，要么给出要查询的IP地址，要么告诉本地域名服务器“你下一步应当向哪一个域名服务器进行查询”。然后让本地域名服务器进行后续的查询

#### 高速缓存
- 也称为高速缓存域名服务器。每个域名服务器都维护一个高速缓存
- 存放最近用过的名字以及从何处获得名字映射信息的记录
- 作用：大大减轻根域名服务器的负荷，使 DNS 查询请求和回答报文的数量大为减少 
- 为保持高速缓存中的内容正确，域名服务器应为每项内容设置计时器，并处理超过合理时间的项（例如，每个项目只存放两天）
- 当权限域名服务器回答一个查询请求时，在响应中都指明绑定有效存在的时间值。增加此时间值可减少网络开销，而减少此时间值可提高域名转换的准确性

## 文件传送协议FTP
### FTP 概述
- 文件传送协议 FTP (File Transfer Protocol) 是互联网上使用得最广泛的文件传送协议
- FTP提供交互式的访问，允许客户指明文件的类型与格式，并允许文件具有存取权限
- FTP屏蔽了各计算机系统的细节，因而适合于在异构网络中任意计算机之间传送文件
- 是文件共享协议的一个大类
- RFC 959很早就成为了互联网的正式标准
### FTP的基本工作原理
- 网络环境下复制文件的复杂性
  - 计算机存储数据的格式不同
  - 文件的目录结构和文件命名的规定不同
  - 对于相同的文件存取功能，操作系统使用的命令不同
  - 访问控制方法不同

#### FTP特点
- 文件传送协议FTP只提供文件传送的一些基本服务，它使用 TCP 可靠的运输服务
- FTP的主要功能是减少或消除在不同操作系统下处理文件的不兼容性
##### FTP使用客户服务器方式
- 一个 FTP 服务器进程可同时为多个客户进程提供服务
- FTP 的服务器进程由两大部分组成
  - 一个主进程，负责接受新的请求
  - 若干个从属进程，负责处理单个请求

#### FTP 主进程的工作步骤
- 打开熟知端口（端口号为 21），使客户进程能够连接上
- 等待客户进程发出连接请求
- 启动从属进程来处理客户进程发来的请求。从属进程对客户进程的请求处理完毕后即终止，但从属进程在运行期间根据需要还可能创建其他一些子进程
- 回到等待状态，继续接受其他客户进程发来的请求。主进程与从属进程的处理是并发地进行

FTP 客户和服务器之间的两个从属进程和两个 TCP 连接
- 控制连接在整个会话期间一直保持打开，FTP客户发出的传送请求通过控制连接发送给服务器端的控制进程，但控制连接不用来传送文件
- 实际用于传输文件的是“数据连接”。服务器端的控制进程在接收到FTP客户发送来的文件传输请求后就创建“数据传送进程”和“数据连接”，用来连接客户端和服务器端的数据传送进程
- 数据传送进程实际完成文件的传送，在传送完毕后关闭“数据传送连接”并结束运行

#### FTP 使用两个不同的端口号
- 当客户进程向服务器进程发出建立连接请求时，要寻找连接服务器进程的熟知端口（21），同时还要告诉服务器进程自己的另一个端口号码，用于建立数据传送连接
- 接着，服务器进程用自己传送数据的熟知端口（20）与客户进程所提供的端口号码建立数据传送连接
- 由于FTP使用了两个不同的端口号，所以数据连接与控制连接不会发生混乱
##### 优点
- 使协议更加简单和更容易实现
- 在传输文件时还可以利用控制连接（例如，客户发送请求终止传输）

#### NFS采用另一种思路
- FTP 并非对所有的数据传输都是最佳的：仅能访问副本
- NFS 允许应用进程打开一个远地文件，并能在该文件的某一个特定的位置上开始读写数据
- NFS 可使用户只复制一个大文件中的一个很小的片段，而不需要复制整个大文件
- NFS 在网络上传送的只是少量的修改数据
- 例如，计算机A的NFS客户软件，把要添加的数据和在文件后面写数据的请求一起发送到远地的计算机B的NFS服务器。NFS服务器更新文件后返回应答信息

## 简单文件传送协议 TFTP
### 概述
- TFTP (Trivial File Transfer Protocol) 是一个很小且易于实现的文件传送协议
- TFTP使用客户服务器方式和使用 UDP 数据报，因此 TFTP 需要有自己的差错改正措施
- TFTP只支持文件传输，不支持交互
- TFTP没有庞大的命令集，没有列目录的功能，也不能对用户进行身份鉴别
### TFTP优点
- 可用于 UDP 环境
- 代码所占的内存较小
### TFTP 的主要特点
- 每次传送的数据报文PDU中有 512 字节的数据，但最后一次可不足 512 字节
- 数据PDU也称为文件块（block），每个块按序编号，从 1 开始
- 支持 ASCII 码或二进制传送
- 可对文件进行读或写
- 使用很简单的首部

### TFTP 的工作很像停止等待协议
- 发送完一个文件块后就等待对方的确认，确认时应指明所确认的块编号
- 发完数据后在规定时间内收不到确认就要重发数据 PDU
- 发送确认 PDU 的一方若在规定时间内未收到下一个文件块，需重发确认 PDU，保证文件的传送不致因某一个数据报的丢失而告失败

### TFTP 的工作过程
- 开始工作时，TFTP 客户进程发送一个读请求或写请求报文给 TFTP 服务器进程，其 UDP 熟知端口号码为 69
- TFTP 服务器进程选择一个新的端口和 TFTP 客户进程进行通信
- 若文件长度恰好为 512 字节的整数倍，则在文件传送完毕后，还必须在最后发送一个只含首部而无数据的数据报文
- 若文件长度不是 512 字节的整数倍，则最后传送数据报文的数据字段一定不满 512 字节，作为文件结束的标志

## 远程终端协议TELNET
### 协议概述
- TELNET是一个简单的远程终端协议，是互联网的正式标准
- 允许用户用 TELNET 在其所在地通过 TCP 连接注册（即登录）到远地的另一个主机上（使用主机名或 IP 地址）
- TELNET 能将用户的击键传到远地主机，同时也能将远地主机的输出通过 TCP 连接返回到用户屏幕。这种服务是透明的，因为用户感觉到好像键盘和显示器是直接连在远地主机上
- 又称为终端仿真协议
### TELNET 使用客户 - 服务器方式
- 现在由于PC的功能越来越强，用户已经较少使用TELNET了
- TELNET也使用客户-服务器方式。在本地系统运行TELNET客户进程，而在远地主机则运行TELNET服务器进程
- 和FTP的情况相似，服务器中的主进程等待新的请求，并产生从属进程来处理每一个连接
### TELNET 使用网络虚拟终端 NVT 格式 
- TELNET 的选项协商 (Option Negotiation) 使客户和服务器可商定使用更多的终端功能，协商的双方是平等的
#### NVT （Network Virtual Terminal ）格式
- 客户端把用户的击键和命令转换成 NVT 格式，并送交服务器
- 服务器端把收到的数据和命令，从 NVT 格式转换成远地系统所需的格式
- 向客户返回数据时，服务器把远地系统的格式转换为 NVT 格式，本地客户再从 NVT 格式转换到本地系统所需的格式

## 万维网 WWW
### 万维网概述
- 万维网 WWW (World Wide Web) 并非某种特殊的计算机网络
- 万维网是一个大规模的、联机式的信息储藏所
- 万维网用链接的方法能非常方便地从互联网上的一个站点访问另一个站点，从而主动地按需获取丰富的信息
#### 这种访问方式称为“链接”
- 万维网提供分布式服务
#### 超媒体与超文本
- 万维网是分布式超媒体 (hypermedia) 系统，是超文本 (hypertext) 系统的扩充
##### 超文本
由多个信息源链接成。是万维网的基础。一个超文本由多个信息源链接成。利用一个链接可使用户找到另一个文档。这些文档可以位于世界上任何一个接在互联网上的超文本系统中
- 超媒体与超文本的区别是文档内容不同
  - 超文本文档仅包含文本信息
  - 超媒体文档还包含其他信息，如图形、图像、声音、动画，甚至活动视频图像等
##### 分布式系统
信息分布在整个互联网上。每台主机上的文档都独立进行管理
#### 万维网的工作方式
- 万维网以客户-服务器方式工作
- 浏览器就是在用户计算机上的万维网客户程序。万维网文档所驻留的计算机则运行服务器程序，因此这个计算机也称为万维网服务器
- 客户程序向服务器程序发出请求，服务器程序向客户程序送回客户所要的万维网文档
- 在一个客户程序主窗口上显示出的万维网文档称为页面 (page)
#### 万维网必须解决的问题
怎样标志分布在整个互联网上的万维网文档？ 
- 使用统一资源定位符 URL (Uniform Resource Locator) 来标志万维网上的各种文档
- 使每一个文档在整个互联网的范围内具有唯一的标识符 URL

用什么协议来实现万维网上的各种链接？ 
- 使用超文本传送协议 HTTP (HyperText Transfer Protocol)
- HTTP 是一个应用层协议，使用 TCP 连接进行可靠的传送


怎样使不同作者创作的不同风格的万维网文档都能在互联网上的各种主机上显示出来，同时使用户清楚地知道在什么地方存在着链接？
- 使用超文本标记语言 HTML (HyperText Markup Language) 

怎样使用户能够很方便地找到所需的信息？ 
- 使用各种的搜索工具（即搜索引擎）

### 统一资源定位符 URL
#### URL概念
- 是对互联网上资源的位置和访问方法的一种简洁表示
- 给资源的位置提供一种抽象的识别方法，并用这种方法给资源定位
- 实际上就是在互联网上的资源的地址
- 显然，互联网上的所有资源，都有一个唯一确定的URL
- 资源：指在互联网上可以被访问的任何对象，包括文件目录、文件、文档、图像、声音等，以及与互联网相连的任何形式的数据


URL 相当于一个文件名在网络范围的扩展。因此，URL 是与互联网相连的机器上的任何可访问对象的一个指针

#### URL 的格式
=由以冒号（:）隔开的两大部分组成，对字符大写或小写没有要求
##### URL一般形式
```
<协议>://<主机>:<端口>/<路径>
```
###### <协议>

| 协议   | 描述               |
|:---------|:------------------|
| ftp       | 文件传送协议 FTP     |
| http      | 超文本传送协议 HTTP  |
| News      | USENET 新闻         |

###### ;//
规定的格式
###### <主机>
是存放资源的主机在互联网中的域名
###### <端口>
即端口号。省略时使用默认端口号
###### <路径>
资源所在目录位置。区分大小写。省略时使用所定义的默认路径。后面可能还有一些选项

现在有些浏览器为了方便用户，在输入URL时，可以把最前面的“http://”甚至把主机名最前面的“www”省略，然后浏览器替用户把省略字符添上

例如，用户只要键入google.com，浏览器自动会把未键入的字符补齐，变成http://www.google.com

#### 使用 HTTP 的 URL
http://<主机>:<端口>/<路径>
##### http
表示使用HTTP协议
##### :// 
是规定的格式
##### <主机>
主机域名或IP地址
##### <端口>
HTTP的默认端口号是80，可省略
##### /<路径>
省略时指到互联网上的某个主页（home page）。更复杂一些的路径是指向层次结构的从属页面

### 超文本传送协议 HTTP
#### HTTP概述
- HTTP 是面向事务的 (transaction-oriented) 应用层协议
- HTTP 使用 TCP 连接进行可靠的传送
- HTTP 定义了浏览器与万维网服务器通信的格式和规则
- HTTP 是万维网上能够可靠地交换文件（包括文本、声音、图像等各种多媒体文件）的重要基础
- HTTP 不仅传送完成超文本跳转所必需的信息，而且也传送任何可从互联网上得到的信息，如文本、超文本、声音和图像等
#### HTTP的操作过程
- 为了使超文本的连接能够高效率地完成，需要用HTTP协议来传送一切必须的信息
- 从层次的角度看，HTTP是面向事务的（transaction-oriented）应用层协议，它是万维网上能够可靠地交换文件（包括文本、声音、图像等各种多媒体文件）的重要基础
#### 用户浏览页面的两种方法
- 在浏览器的地址窗口中键入所要找的页面的 URL
- 在某一个页面中用鼠标点击一个可选部分，这时浏览器会自动在互联网上找到所要链接的页面

用户点击URL：http://www.tsinghua.edu.cn/chn/yxsz/index.htm后发生的事件
- 浏览器分析超链接指向页面的URL
- 浏览器向DNS请求解析www.tsinghua.edu.cn的IP地址
- 浏览器与服务器建立TCP连接
- 浏览器发出取文件命令：GET/chn/yxsz/index.htm
- 服务器给出响应，把文件index。htm发给浏览器
- TCP连接释放
- 浏览器显示“清华大学院系设置”文件index.htm中的所有文本

#### HTTP的主要特点
- HTTP 使用了面向连接的 TCP 作为运输层协议，保证了数据的可靠传输
- HTTP 协议本身也是无连接的，虽然它使用了面向连接的TCP向上提供的服务
- HTTP 是无状态的 (stateless)，简化了服务器的设计，使服务器更容易支持大量并发的 HTTP 请求

#### 请求一个万维网文档所需的时间
所需的时间 >= RTT（三报文握手建立 TCP 连接）+ RTT（请求和接收文档）+ 文档的传输时间 = 2 RTT +文档的传输时间

#### 协议 HTTP/1.0 的主要缺点
- 每请求一个文档就要有两倍 RTT 的开销
- 客户和服务器每一次建立新的 TCP 连接都要分配缓存和变量
- 这种非持续连接使服务器的负担很重

#### 协议 HTTP/1.1 使用持续连接
- 持续连接（persistent connection）：服务器在发送响应后仍然在一段时间内保持这条连接（不释放），使同一个客户（浏览器）和该服务器可以继续在这条连接上传送后续的 HTTP 请求报文和响应报文
- 这并不局限于传送同一个页面上链接的文档，只要文档都在同一个服务器上，就可以继续使用该 TCP 连接
- 目前一些流行的浏览器的默认设置就是使用HTTP/1.1

##### 持续连接的两种工作方式
###### 非流水线方式 (without pipelining)
客户在收到前一个响应之后才能发出下一个请求。这比非持续连接的两倍RTT的开销节省了建立TCP连接所需的一个RTT时间。但服务器在发送完一个对象后，其TCP连接就处于空闲状态，浪费了服务器资源
###### 流水线方式 (with pipelining)
客户在收到HTTP的响应报文之前就能够接着发送新的请求报文。一个接一个的请求报文到达服务器后，服务器就可连续发回响应报文。使用流水线方式时，客户访问所有的对象只需花费一个RTT时间，使TCP连接中的空闲时间减少，提高了下载文档的效率

#### 协议 HTTP/2
- 是协议 HTTP/1.1 的升级版本
- 服务器可以并行发回响应（使用同一个 TCP 连接）
- 允许客户复用 TCP 连接进行多个请求
- 把所有的报文都划分为许多较小的二进制编码的帧，并采用了新的压缩算法，不发送重复的首部字段，大大减小了首部的开销，提高了传输效率
- 向后兼容

#### 代理服务器
- 代理服务器 (proxy server) 又称为万维网高速缓存 (Web cache)，它代表浏览器发出 HTTP 请求
- 万维网高速缓存把最近的一些请求和响应暂存在本地磁盘中
- 当与暂时存放的请求相同的新请求到达时，万维网高速缓存就把暂存的响应发送出去，而不需要按URL的地址再去互联网访问该资源
- 使用高速缓存可减少访问互联网服务器的时延

#### 使用高速缓存的情况
- 浏览器访问互联网的服务器时，先与校园网的高速缓存建立 TCP 连接，并向高速缓存发出 HTTP 请求报文
- 若高速缓存已经存放了所请求的对象，则将此对象放入 HTTP 响应报文中返回给浏览器
- 若未存放，高速缓存就代表浏览器与互联网上的源点服务器建立 TCP 连接，并发送 HTTP 请求报文
- 源点服务器将所请求的对象放在 HTTP 响应报文中返回给校园网的高速缓存
- 高速缓存收到对象后，先复制到本地存储器中（留待以后用），然后将该对象放在 HTTP 响应报文中，通过已建立的 TCP 连接，返回给请求该对象的浏览器

#### HTTP 的报文结构
##### 两类报文
###### 请求报文
从客户向服务器的请求
###### 响应报文
从服务器到客户的回答

由于 HTTP 是面向正文的 (text-oriented)，因此报文中每一个字段的值都是一些 ASCII 码串，每个字段的长度都是不确定的
##### 三个组成部分
###### 开始行
用于区分是请求报文还是响应报文
###### 首部行
说明浏览器、服务器或报文主体的一些信息。可以有多行，也可以不使用
###### 实体主体
请求报文中一般不用，响应报文中也可能没有该字段

##### 请求报文
=在请求报文中，开始行是请求行
###### 报文结构
```
请求行 方法 URL 版本 CRLF（回车换行）
       首部字段名:值 CRLF
首部行 ...
       首部字段名:值 CRLF
       CRLF
       实体主体（通常不用）
```

###### 方法
方法是面向对象技术中使用的专用名词。是对所请求的对象进行的操作，这些方法实际上就是一些命令。因此，请求报文的类型是由它所采用的方法决定的
###### HTTP 请求报文的一些方法

| 方法       | 描述                                 |
|:------------|:--------------------------------------|
| OPTION       | 请求一些选项的信息                      |
| GET          | 请求读取由 URL 所标志的信息              |
| HEAD         | 请求读取由 URL 所标志的信息的首部         |
| POST         | 给服务器添加信息（例如：注释）            |
| PUT          | 在指明的 URL 下存储一个文档               |
| DELETE       | 删除指明的 URL 所标志的资源               |
| TRACE        | 用来进行回显测试的请求报文                 |
| CONNECT      | 用于代理服务器                            |

###### URL
所请求的资源的 URL
###### 版本
HTTP 的版本

##### 响应报文
###### 报文结构
```
状态行 版本 状态码 短语 CRLF（回车换行）
       首部字段名:值 CRLF
首部行 ...
       首部字段名:值 CRLF
       CRLF
       实体主体（有些响应报文不用）
```

在响应报文中，开始行是状态行

###### 版本
HTTP 的版本
###### 状态码
- 服务器操作完成的状态
- 都是三位数字，分为5大类

| 状态码分类 | 含义说明                                        |
|:------------|:------------------------------------------------|
| 1xx          | 通知信息，如请求收到了或正在进行处理               |
| 2xx          | 成功，如接受或知道了                                |
| 3xx          | 重定向，表示要完成请求还必须采取进一步的行动            |
| 4xx          | 客户端错误，如请求中有错误的语法或不能完成             |
| 5xx          | 服务器错误，如服务器失效无法完成请求                  |

###### 短语
解释状态码

#### 在服务器上存放用户的信息
- 万维网使用 Cookie 跟踪用户
- Cookie表示在 HTTP 服务器和客户之间传递的状态信息
- 使用Cookie的网站服务器为用户产生一个惟一的识别码。利用此识别码，网站就能够跟踪该用户在该网站的活动

### 万维网的文档
#### 相关概念
- 在一个客户程序主窗口上显示出的万维网文档称为页面 (page)
- 页面制作的标准语言：HTML

分为：
- 静态万维网文档。内容不会改变。简单
- 动态万维网文档。文档的内容由应用程序动态创建
- 活动万维网文档。由浏览器端改变文档的内容

#### 超文本标记语言 HTML (HyperText Markup Language)
超文本标记语言 HTML (HyperText Markup Language) 是一种制作万维网页面的标准语言，它消除了不同计算机之间信息交流的障碍，是万维网的重要基础 [RFC 2854]，Markup就是“设置标记”

最新 HTML 5.0 增加了 ```<audio>``` 和 ```<video>``` 两个标签，实现对多媒体中的音频、视频使用的支持，增加了能够在移动设备上支持多媒体功能

**注意：HTML 不是应用层的协议，它只是万维网浏览器使用的一种语言**

HTML 定义了许多用于排版的命令（即标签）

HTML 把各种标签嵌入到万维网的页面中，构成了所谓的 HTML 文档

HTML 文档是一种可以用任何文本编辑器创建的 ASCII 码文件

HTML 文档的后缀：.html 或 .htm

如果HTML文档改成 .txt 为后缀，则HTML解释程序就不对标签进行解释，而浏览器只能看见原来的文本文件

当浏览器从服务器读取HTML文档后，就按照HTML文档中的各种标签，根据浏览器所使用的显示器的尺寸和分辨率大小，重新进行排版并恢复出所读取的页面

#### 可扩展标记语言 XML (Extensible Markup Language)
可扩展标记语言 XML (Extensible Markup Language) 和 HTML 很相似

但是 XML 的设计宗旨是：传输数据，而不是显示数据

XML不是要替换HTML，而是对HTML的补充
##### 特点和优点
- 可用来标记数据、定义数据类型
- 允许用户对自己的标记语言进行自定义，并且是无限制的
- 简单，与平台无关
- 将用户界面与结构化数据分隔开来

#### 可扩展超文本标记语言 XHTML (Extensible HTML)
可扩展超文本标记语言 XHTML (Extensible HTML) 与 HTML 4.01 几乎相同，是更严格的 HTML 版本

作为一种 XML 应用被重新定义的 HTML，将逐渐取代 HTML

#### 层叠样式表 CSS (Cascading Style Sheets) 
层叠样式表 CSS (Cascading Style Sheets) 是一种样式表语言，用于为 HTML 文档定义布局
##### CSS 与 HTML 的区别
HTML 用于结构化内容，而 CSS 则用于格式化结构化的内容

例如：精确规定在浏览器上显示的字体、颜色、边距、高度、宽度、背景图像等

#### 动态万维网文档
##### 静态文档
静态文档创作完毕后就存放在万维网服务器中，在被用户浏览的过程中，内容不会改变
##### 动态文档
文档的内容是在浏览器访问万维网服务器时才由应用程序动态创建

动态文档和静态文档之间的主要差别体现在服务器端
文档内容的生成方法不同。从浏览器的角度看，这两种文档并没有区别

#### 万维网服务器功能的扩充
##### 增加一个应用程序
处理浏览器发来的数据，并创建动态文档
##### 增加一个机制
使万维网服务器把浏览器发来的数据传送给这个应用程序，然后万维网服务器能够解释这个应用程序的输出，并向浏览器返回 HTML 文档

#### 通用网关接口 CGI (Common Gateway Interface)
##### 通用网关接口 CGI (Common Gateway Interface) 
定义动态文档应如何创建，输入数据应如何提供给应用程序，以及输出结果应如何使用的一种标准
##### 通用
CGI 标准所定义的规则对其他任何语言都是通用的
##### 网关
CGI 程序的作用像网关
##### 接口
有一些已定义好的变量和调用等可供其他 CGI 程序使用

##### CGI 网关程序
###### 正式名字：CGI 脚本 (script)
###### 脚本
指的是一个程序，它被另一个程序（解释程序）而不是计算机的处理机来解释或执行
###### 脚本语言 (script language)
如 Perl, JavaScript，Tcl/Tk 等。也可用一些常用的编程语言写出，如 C，C++等

- 脚本运行起来要比一般的编译程序要慢
- 脚本不一定是一个独立的程序，可以是一个动态装入的库，甚至是服务器的一个子程序
- CGI 程序又称为 cgi-bin 脚本，因为在许多万维网服务器上，将 CGI 程序放在 /cgi-bin 的目录下

#### 活动万维网文档
活动文档 (active document) 技术：把屏幕连续更新的工作转移给浏览器端，它把所有的工作都转移给浏览器端

每当浏览器请求一个活动文档时，服务器就返回一段程序副本在浏览器端运行

活动文档程序可与用户直接交互，并可连续地改变屏幕的显示

由于活动文档技术不需要服务器的连续更新传送，对网络带宽的要求也不会太高

##### 用 Java 语言创建活动文档
Java 语言是一项用于创建和运行活动文档的技术

在 Java 技术中使用小应用程序 (applet) 来描述活动文档程序

用户从万维网服务器下载嵌入了 applet 的 HTML 文档后，可在浏览器的屏幕上点击某个图像，就可看到动画效果，或在下拉式菜单中点击某个项目，就可看到计算结果

Java 技术是活动文档技术的一部分

### 万维网的信息检索系统
#### 基本概念
- 使用户能够很方便地找到所需的信息
- 在万维网中用来进行搜索的程序叫做搜索引擎 (search engine)
#### 全文检索搜索引擎
- 一种纯技术型的检索工具
- 通过搜索软件（例如一种叫做“蜘蛛”或“网络机器人”的 Spider 程序）到  互联网上的各网站收集信息
- 按照一定的规则建立一个很大的在线索引数据库
- 用户在查询时只要输入关键词，从已经建立的索引数据库里查询（非实时）

需要定期更新维护数据库（并不是实时地在互联网上检索到的信息）

#### 分类目录搜索引擎
- 分类目录搜索引擎不采集网站的任何信息，而是利用各网站向搜索引擎提交的网站信息时填写的关键词和网站描述等信息，经过人工审核编辑后，输入到分类目录的数据库中，供网上用户查询
- 分类目录搜索也叫做分类网站搜索
- 查询时只需要按照分类，不需要使用关键词，查询的准确性较好
- 查询的结果不是具体的页面，而是被收录网站主页的 URL 地址

#### 一些著名的搜索引擎
##### 全文检索搜索引擎

| 类型               | 名称     | 网站地址               |
|:--------------------|:----------|:------------------------|
| 综合搜索引擎         | Google    | [www.google.com](https://www.google.com) |
|                      | 必应       | [cn.bing.com](https://cn.bing.com)       |
|                      | 百度       | [www.baidu.com](https://www.baidu.com)   |
| 分类目录搜索引擎     | 雅虎       | [www.yahoo.com](https://www.yahoo.com)   |
|                      | 新浪       | [www.sina.com](https://www.sina.com)     |
|                      | 搜狐       | [www.sohu.com](https://www.sohu.com)     |
|                      | 网易       | [www.163.com](https://www.163.com)       |


#### 垂直搜索引擎 (Vertical Search Engine)
- 针对某一特定领域、特定人群或某一特定需求提供搜索服务
- 也是提供关键字来进行搜索，但被放到一个行业知识的上下文中，返回的结果更倾向于信息、消息、条目等
- 目前热门的垂直搜索行业有：购物、旅游、汽车、求职、房产、交友等

#### 元搜索引擎 (Meta Search Engine) 
- 把用户提交的检索请求发送到多个独立的搜索引擎上去搜索，并把检索结果集中统一处理，以统一的格式提供给用户，因此是搜索引擎之上的搜索引擎
- 主要精力放在提高搜索速度、智能化处理搜索结果、个性化搜索功能的设置和用户检索界面的友好性上
- 其查全率和查准率都比较高

### 博客和微博
#### 博客
- 万维网日志 (weblog) 的简称
- 使网民不仅是互联网上内容的消费者，而且还是互联网上内容的生产者
#### 微博
- 微型博客 (microblog)，又称为微博客
- 只记录片段、碎语，三言两语，现场记录，发发感慨，晒晒心情，永远只针对一个问题进行回答
- 开通的多种 API 使用户可通过手机、网络等方式即时更新自己的信息
- 是一种互动及传播性极快的工具
### 社交网站 SNS (Social Networking Site)
社交网站 SNS (Social Networking Site) 是为一群拥有相同兴趣与活动的人创建在线社区
#### 功能丰富
如电子邮件、即时传信（在线聊天）、博客撰写、共享相册、上传视频、网页游戏、创建社团、刊登广告等
#### 热门
- Facebook
- YouTube
- Twitter
- 微信
- 抖音

## 电子邮件
### 电子邮件概述
电子邮件 (e-mail)：指使用电子设备交换的邮件及其方法

电子邮件（e-mail）是互联网上使用的最多的和最受用户欢迎的一种应用

电子邮件把邮件发送到收件人使用的邮件服务器，并放在其中的收件人邮箱中，收件人可随时上网到自己使用的邮件服务器进行读取
#### 优点
- 使用方便
- 传递迅速
- 费用低廉

现在电子邮件不仅可以传送文字信息，而且还可以附上声音和图像
#### 重要标准
- 简单邮件发送协议：SMTP
- 互联网文本报文格式
- 邮件读取协议：POP3 和 IMAP
- 通用互联网邮件扩充 MIME

MIME在其邮件首部中说明了邮件的数据类型（如文本、声音、图像、视像等），使用MIME可在邮件中同时传送多种类型的数据

#### 电子邮件系统的组成----3个主要构件
- 用户代理
- 邮件服务器
- 邮件发送和读取协议

#### 用户代理 UA (User Agent)

用户代理UA就是用户与电子邮件系统的接口，是电子邮件客户端软件

用户代理的功能
- 撰写
- 显示
- 处理和通信

邮件服务器的功能是发送和接收邮件，同时还要向发信人报告邮件发送的情况（已交付、被拒绝、丢失等）

#### 发送和接收电子邮件的几个重要步骤
- 发件人调用PC中的用户代理撰写和编辑要发送的邮件
- 发件人的用户代理把邮件用SMTP协议发给发送方邮件
- SMTP服务器把邮件临时存放在邮件缓存队列中，等待发送
- 发送方邮件服务器的SMTP客户与接收方邮件服务器的SMTP服务器建立TCP连接，然后把邮件缓存队列中的邮件依次发送出去
- 运行在接收方邮件服务器的SMTP服务器进程收到邮件后，把邮件放入收件人的用户邮箱中，等待收件人进行读取
- 收件人在打算收信时，就运行PC机中的用户代理，使用POP3或IMAP协议读取发送给自己的邮件

**注意：POP3服务器和POP3客户之间的通信是由POP3客户发起的**

#### 电子邮件的组成
- 电子邮件由信封 (envelope) 和内容 (content) 两部分组成
- 电子邮件的传输程序根据邮件信封上的信息来传送邮件
- 用户在从自己的邮箱中读取邮件时才能见到邮件的内容
- 在邮件的信封上，最重要的就是收件人的地址

#### 电子邮件的格式
- 在邮件的信封上，最重要的就是收件人的地址。 
- TCP/IP 体系的电子邮件系统规定电子邮件地址的格式如下：
  - 收件人邮箱名@邮箱所在主机的域名
  - 用户名在该域名范围内是惟一的
  - 邮箱所在的主机的域名在全世界必须是惟一的
  - 符号“@”读作“at”，表示“在”的意思


### 简单邮件传送协议 SMTP
#### SMTP概述
SMTP所规定的就是在两个相互通信的SMTP进程之间应如何交换信息

由于SMTP使用客户服务器方式，因此负责发送邮件的SMTP进程就是SMTP客户，而负责接收邮件的SMTP进程就是SMTP服务器

SMTP规定了14条命令和21种应答信息。每条命令用4个字母组成，而每一种应答信息一般只有一行信息，由一个3位数字的代码开始后面附上（也可不附上）很简单的文字说明
#### SMTP 通信的三个阶段
##### 连接建立
连接是在发送主机的 SMTP 客户和接收主机的 SMTP 服务器之间建立的。SMTP 不使用中间的邮件服务器
##### 邮件传送
##### 连接释放
邮件发送完毕后，SMTP 应释放 TCP 连接

### 电子邮件的信息格式
#### 一个电子邮件分为信封和内容两大部分
##### 信封
```
MAIL FROM:one@abc.edu
RCPT TO:two@xyz.com
```
##### 内容
###### 首部（header）
```
From: LionKing@abc.edu
To: TigerWang@xyz.com
Date: 2018-08-18
Subject: Greetings
Cc: Manager@zoo.com
```
###### 空行
###### 主体（body）
纯文本信息 （ASCII编码）
无特定结构和含义

RFC 5322 只规定了邮件内容中的首部 (header) 格式

邮件的主体 (body) 部分则让用户自由撰写

用户写好首部后，邮件系统将自动地将信封所需的信息提取出来并写在信封上。所以用户不需要填写电子邮件信封上的信息

邮件内容首部包括一些关键字，后面加上冒号，最重要的关键字是:To和Subject

#### 邮件内容的首部
##### To:
后面填入一个或多个收件人的电子邮件地址。用户只需打开地址簿，点击收件人名字，收件人的电子邮件地址就会自动地填入到合适的位置上
##### Subject:
是邮件的主题。它反映了邮件的主要内容，便于用户查找邮件
##### Cc:
表示应给某某人发送一个邮件副本
##### From和Date
表示发件人的电子邮件地址和发信日期
##### Reply-To
是对方回信所用的地址

#### SMTP通信的三个阶段
##### 连接建立
连接是在发送主机的SMTP客户和接收主机的SMTP服务器之间建立的。SMTP不使用中间的邮件服务器
##### 邮件传送
##### 连接释放
邮件发送完毕后，SMTP应释放TCP连接

### 邮件读取协议 POP3 和 IMAP
两个常用的邮件读取协议：
#### POP3
邮局协议 (Post Office Protocol) 第3个版本 
- 邮局协议POP是一个非常简单、但功能有限的邮件读取协议，现在使用的是它的第三个版本POP3
- POP也使用客户-服务器的工作方式
- 在接收邮件的用户PC机中必须运行POP客户程序，而在用户所连接的ISP的邮件服务器中运行POP服务器程序
- POP3 支持用户鉴别
- POP3 服务器删除被用户读取了的邮件
#### IMAP
网际报文存取协议 (Internet Message Access Protocol)
- IMAP也是按客户-服务器方式工作，现在较新的是版本4，即IMAP4
- 连接后只下载邮件首部（部分下载）
- 用户在自己的PC机上就可以操纵ISP的邮件服务器的邮箱，用户直接在 IMAP 服务器上创建和管理文件夹，就像在本地操纵一样
- 因此IMAP是一个联机协议。当用户PC机上的IMAP客户程序打开IMAP服务器的邮箱时，用户就可以看到邮件的首部。若用户需要打开某个邮件，则该邮件才传到用户的计算机上
- 用户可以搜索邮件内容
- 用户可以在不同的地方使用不同的计算机随时上网阅读和处理自己的邮件
-
 允许收信人只读取邮件中的某一个部分
##### 缺点
要想查阅邮件，必须先联网

注意
- 不要将邮件读取协议POP或IMAP与邮件传送协议SMTP弄混
- 发信人的用户代理向源邮件服务器发送邮件，以及源邮件服务器向目的邮件服务器发送邮件，都是使用SMTP协议
- 而POP协议或IMAP协议则是用户从目的邮件服务器上读取邮件所使用的协议

### 基于万维网的电子邮件
#### 用户代理 (UA) 的缺点
- 必须在计算机中安装用户代理软件
- 收发邮件不方便
#### 万维网电子邮件优点
- 不需要在计算机中再安装用户代理软件
- 计算机能联网，就能非常方便地收发电子邮件
- 界面非常友好

#### 万维网电子邮件
- 发送、接收电子邮件时使用 HTTP 协议
- 两个邮件服务器之间传送邮件时使用 SMTP
- 使用 HTTP POST 方法提交要发送的邮件
- 使用 HTTP GET 方法读取邮件

### 通用互联网邮件扩充 MIME
#### SMTP 缺点
- 不能传送可执行文件或其他的二进制对象
- 限于传送 7 位的 ASCII 码，无法传送非 ASCII 编码的信息
- 服务器会拒绝超过一定长度的邮件
- 某些 SMTP 的实现并没有完全按照 [RFC 821] 的 SMTP 标准
#### MIME概述
- 通用互联网邮件扩充 MIME 并没有改动 SMTP 或取代它
- MIME意图：继续使用目前的 [RFC 822] 格式，但增加了邮件主体的结构，并定义了传送非 ASCII 码的编码规则

#### MIME 和 SMTP 的关系
用户<-- 非ASCII码 -->MIME<-- 7位ASCII码 -->SMTP<-- 7位ASCII码 -->SMTP<-- 7位ASCII码 -->MIME<-- 非ASCII码 -->用户
#### MIME 主要包括三个部分
- 5 个新的邮件首部字段，它们可包含在[RFC822]首部中。这些字段提供了有关邮件主体的信息
- 定义了许多邮件内容的格式，对多媒体电子邮件的表示方法进行了标准化
- 定义了传送编码，可对任何内容格式进行转换，而不会被邮件系统改变

#### MIME 增加 5 个新的邮件首部
##### MIME-Version
MIME 的版本。若无此行，则为英文文本
##### Content-Description
这是可读字符串，此邮件的说明
##### Content-Id
邮件的唯一标识符
##### Content-Transfer-Encoding
传送时邮件主体使用的编码方法
##### Content-Type
邮件内容类型/子类型

#### 内容传送编码(Content-Transfer-Encoding)
- 最简单的编码就是7位ASCII码，而每行不能超过1000个字符。MIME对这种由ASCII码构成的邮件主体不进行任何转换
- 另一种编码称为quoted-printable，这种编码方法适用于当所传送的数据中只有少量的非ASCII码
- 对于任意的二进制文件，可用base64编码

## 动态主机配置协议 DHCP
### DHCP概述
- 为了将软件协议做成通用的和便于移植，协议软件的编写者把协议软件参数化。这就使得在很多台计算机上使用同一个经过编译的二进制代码成为可能
- 在协议软件中，给协议参数赋值的动作叫做协议配置
- 一个协议软件在使用之前必须是已正确配置的
- 具体的配置信息取决于协议栈

连接到互联网的计算机的协议软件需要正确配置的参数包括
- IP 地址
- 子网掩码
- 默认路由器的 IP 地址
- 域名服务器的 IP 地址

这些信息通常存储在一个配置文件中，计算机在引导过程中可以对这个文件进行存取

#### 动态主机配置协议 DHCP (Dynamic Host Configuration Protocol) 
提供了即插即用连网 (plug-and-play networking) 的机制，允许一台计算机加入网络和获取 IP 地址，而不用手工配置
- DHCP 给运行服务器软件、且位置固定的计算机指派一个永久地址，给运行客户端软件的计算机分配一个临时地址

### DHCP使用客户-服务器方式
- 需要IP地址的主机在启动时就向DHCP服务器广播发送发现报文（DHCPDISCOVER），这时该主机就成为DHCP客户
- 本地网络上所有主机都能收到此广播报文，但只有DHCP服务器才回答此广播报文
- DHCP服务器先在其数据库中查找该计算机的配置信息。若找到，则返回找到的信息。若找不到，则从服务器的IP地址池（address pool）中取一个地址分配给该计算机。DHCP服务器的回答报文叫做提供报文（DHCPOFFER）

### DHCP 中继代理 (relay agent) 
- 并不是每个网络上都有DHCP服务器，这样会使DHCP服务器的数量太多。现在是每一个网络至少有一个DHCP中继代理，它配置了DHCP服务器的IP地址信息
- 当DHCP中继代理收到主机发送的发现报文后，就以单播方式向DHCP服务器转发此报文，并等待其回答。收到DHCP服务器回答的提供报文后，DHCP中继代理再将此提供报文发回给主机

**注意：DHCP报文只是UDP用户数据报中的数据**

### 租用期 (lease period) 
- DHCP 服务器分配给 DHCP 客户的 IP 地址的临时的，因此 DHCP 客户只能在一段有限的时间内使用这个分配到的 IP 地址。DHCP 协议称这段时间为租用期 
- 租用期的数值应由 DHCP 服务器自己决定
- DHCP 客户也可在自己发送的报文中（例如，发现报文）提出对租用期的要求

### DHCP 协议的工作过程
- 步骤1：DHCP 服务器被动打开 UDP 端口 67，等待客户端发来的报文
- 步骤2：DHCP 客户从 UDP 端口 68 发送 DHCP 发现报文 DHCPDISCOVER
- 步骤3：凡收到 DHCP 发现报文的 DHCP 服务器都发出 DHCP 提供报文 DHCPOFFER，因此 DHCP 客户可能收到多个 DHCP 提供报文
- 步骤4：DHCP 客户从几个 DHCP 服务器中选择其中的一个，并向所选择的 DHCP 服务器发送 DHCP 请求报文 DHCPREQUEST
- 步骤5：被选择的 DHCP 服务器发送确认报文 DHCPACK，DHCP 客户可开始使用得到的临时 IP 地址了，进入已绑定状态
DHCP 客户现在要根据服务器提供的租用期 T 设置两个计时器 T1 和 T2，它们的超时时间分别是 0.5T 和 0.875T。当超时时间到时，就要请求更新租用期
- 步骤6：租用期过了一半（T1 时间到），DHCP 发送请求报文 DHCPREQUEST，要求更新租用期
- 步骤7：DHCP 服务器若同意，则发回确认报文 DHCPACK。DHCP 客户得到了新的租用期，重新设置计时器
- 步骤8：DHCP 服务器若不同意，则发回否认报 DHCPNACK。这时 DHCP 客户必须立即停止使用原来的 IP 地址，而必须重新申请 IP 地址（回到步骤 2）
若 DHCP 服务器不响应步骤6 的请求报文 DHCPREQUEST，则在租用期过了 87.5% 时 (T2 时间到)，DHCP 客户必须重新发送请求报文 DHCPREQUEST（重复步骤6），然后又继续后面的步骤
- 步骤9：DHCP 客户可随时提前终止服务器所提供的租用期，这时只需向 DHCP 服务器发送释放报文 DHCPRELEASE 即可

## 简单网络管理协议 SNMP
### 网络管理的基本概念
#### 网络管理概述
- 网络管理包括对硬件、软件和人力的使用、综合与协调，以便对网络资源进行监视、测试、配置、分析、评价和控制，这样就能以合理的价格满足网络的一些需求，如实时运行性能，服务质量等
- 网络管理常简称为网管
- 网络管理并不是指对网络进行行政上的管理
#### 网络管理的五大功能

| 管理类型         | 描述                                             |
|:----------------|:------------------------------------------------|
| 故障管理         | 故障检测、隔离和纠正                              |
| 配置管理         | 初始化网络，并配置网络                              |
| 计费管理         | 记录网络资源的使用                                  |
| 性能管理         | 估价系统资源的运行状况及通信效率等                     |
| 网络安全管理     | 对授权机制、访问控制、加密和加密关键字的管理             |


#### 网络管理的一般模型
网络管理员使用管理程序（运行SNMP客户端程序）对被管设备进行管理，被管设备使用代理程序（运行SNMP服务器程序）

网络管理模型中的主要构件
- 管理站也常称为网络运行中心 NOC (Network Operations Center)，是网络管理系统的核心
- 管理程序是管理站中的关键构件，在运行时就成为管理进程
- 管理站（硬件）或管理程序（软件）都可称为管理者(manager)。Manager 不是指人，而是指机器或软件
- 网络管理员 (administrator) 指的是负责网络管理的人员
- 大型网络往往实行多级管理，因而有多个管理者，而一个管理者一般只管理本地网络的设备

##### 被管对象 (Managed Object)
- 网络的每一个被管设备（包括设备中的软件）中可能有多个被管对象
- 被管设备有时可称为网络元素或网元
- 在被管设备中也会有一些不能被管的对象

##### 代理 (agent)
- 在每一个被管设备中都要运行一个程序，以便和管理站中的管理程序进行通信
- 这些运行着的程序叫做网络管理代理程序，或简称为代理
- 代理程序在管理程序的命令和控制下在被管设备上采取本地的行动

#### 网络管理协议
- 网络管理协议简称为网管协议
- 网络管理协议是管理程序和代理程序之间进行通信的规则
- 网络管理员利用网络管理协议，通过管理站对网络中的被管设备进行管理。

**注意：网管协议本身不管理网络**

#### 简单网络管理协议 SNMP
- 简单网络管理协议 SNMP (Simple Network Management Protocol) 中的管理程序和代理程序按客户服务器方式工作
- 管理程序运行 SNMP 客户程序，向某个代理程序发出请求 (或命令)
- 代理程序运行 SNMP 服务器程序，返回响应 (或执行某个动作)
- 在网管系统中，往往是一个（或少数几个）客户程序与很多的服务器程序进行交互

#### 网络管理的基本原理
若要管理某个对象，就必然会给该对象添加一些软件或硬件，但这种“添加”必须对原有对象的影响尽量小些

#### SNMP 的基本功能
最重要的指导思想：尽可能简单
##### 基本功能
- 监视网络性能
- 检测分析网络差错
- 配置网络设备等

#### SNMP 网络管理组成
##### 简单网络管理协议 SNMP(Simple Network Management Protocol)
- SNMP 定义了管理站和代理之间所交换的分组格式
- 所交换的分组包含各代理中的对象（变量）名及其状态（值）
- SNMP 负责读取和改变这些数值
##### 管理信息结构 SMI (Structure of Management Information)
- SMI 定义了命名对象和定义对象类型（包括范围和长度）的通用规则，以及把对象和对象的值进行编码的规则，以确保网络管理数据的语法和语义的无二义性
- 但从 SMI 的名称并不能看出它的功能
- SMI 并不定义一个实体应管理的对象数目，也不定义被管对象名以及对象名及其值之间的关联
##### 管理信息库 MIB (Management Information Base)
- MIB 在被管理的实体中创建了命名对象，并规定了其类型
- 管理程序使用 MIB 中的信息，对网络进行管理

### 管理信息结构 SMI
#### SMI 的功能
- 被管对象应怎样命名
- 用来存储被管对象的数据类型有哪些种
- 在网络上传送的管理数据应如何编码

**SMI 规定：所有被管对象必须在命名树上**

#### SMI 使用 ASN.1
- SMI 标准指明：所有的 MIB 变量必须使用抽象语法记法 1 (ASN.1) 来定义
- SMI 既是 ASN.1 的子集，又是 ASN.1 的超集 
- ASN.1 的记法很严格，使得数据的含义不存在任何可能的二义性
#### SMI 数据类型
##### 数据
###### 类型
值集合的名字
###### 值
某个值集合中的一个元素
##### SMI 把数据类型分为两大类
- 简单类型
- 结构化类型

#### 基本编码规则 BER
- ISO 在制订 ASN.1 语言的同时也为它定义了一种标准的编码方案，即基本编码规则 BER (Basic Encoding Rule)
- BER 指明了每种数据类型中每个数据的值的表示
- SMI 使用 ASN.1 制定的 BER 进行数据的编码
- 发送端用 BER 编码，可将用 ASN.1 所表述的报文转换成唯一的比特序列
- 接收端用 BER 进行解码，得到该比特序列所表示的 ASN.1 报文

### 管理信息库 MIB
- 被管对象必须维持可供管理程序读写的若干控制和状态信息。这些信息总称为管理信息库 MIB (Management Information Base)
- 管理程序使用 MIB 中这些信息的值对网络进行管理（如读取或重新设置这些值）
- 只有在 MIB 中的对象才是 SNMP 所能够管理的


### SNMP 的协议数据单元和报文
#### SNMP 的操作只有两种基本的管理功能
##### “读”操作
用 get 报文来检测各被管对象的状况
##### “写”操作
用 set 报文来改变各被管对象的状况

SNMP 的这些功能通过探询操作来实现

#### SNMP 的探询操作
SNMP 管理进程定时向被管理设备周期性地发送探询信息
##### 好处
- 可使系统相对简单
- 能限制通过网络所产生的管理信息的通信量
##### 缺点
- 不够灵活，而且所能管理的设备数目不能太多
- 开销也较大
#### 陷阱 (trap)
- SNMP 允许不经过询问就能发送某些信息。这种信息称为陷阱，表示它能够捕捉“事件”
- 当被管对象的代理检测到有事件发生时，就检查其门限值。代理只向管理进程报告达到某些门限值的事件（即过滤）
##### 过滤的好处
- 仅在严重事件发生时才发送陷阱
- 陷阱信息很简单且所需字节数很少

#### SNMP 是有效的网络管理协议
- 使用探询（至少是周期性地）以维持对网络资源的实时监视
- 同时也采用陷阱机制报告特殊事件，使得 SNMP 成为一种有效的网络管理协议

#### SNMP 使用无连接的 UDP
- 运行代理程序的服务器端用 UDP 熟知端口 161 接收 get 或 set 报文，发送响应报文。与熟知端口通信的客户端使用临时端口
- 运行管理程序的客户端则使用 UDP 熟知端口 162 来接收来自各代理的 trap 报文

## 应用进程跨越网络的通信
### 系统调用和应用编程接口
- 大多数操作系统使用系统调用 (system call ) 的机制在应用程序和操作系统之间传递控制权
- 对程序员来说，每一个系统调用和一般程序设计中的函数调用非常相似，只是系统调用是将控制权传递给了操作系统

#### 多个应用进程使用系统调用的机制 
- 用户地址空间中的应用程序
- 系统调用接口
- 系统地址空间中的协议软件

#### 应用编程接口 API
- 系统调用接口实际上就是应用进程的控制权和操作系统的控制权进行转换的一个接口
- 使用系统调用之前要编写一些程序，特别是需要设置系统调用中的许多参数，因此这种系统调用接口又称为应用编程接口 API (Application Programming Interface) 

#### 几种应用编程接口 API
- Berkeley UNIX 操作系统定义了一种 API，它又称为套接字接口 (socket interface)
- 微软公司在其操作系统中采用了套接字接口  API，形成了一个稍有不同的 API，并称之为  Windows Socket
- AT&T 为其 UNIX 系统 V 定义了一种 API，简写为 TLI (Transport Layer Interface)

#### 套接字的作用
- 当应用进程需要使用网络进行通信时就发出系统调用，请求操作系统为其创建套接字，以便把网络通信所需要的系统资源分配给该应用进程
- 操作系统为这些资源的总和用一个套接字描述符的号码来表示
- 应用进程所进行的网络操作都必须使用这个套接字描述符
- 通信完毕后，应用进程通过一个关闭套接字的系统调用通知操作系统回收与该套接字描述符相关的所有资源

### 几种常用的系统调用
#### TCP 提供面向连接的服务

使用 TCP 服务需要经历 3 个阶段
- 连接建立阶段
- 数据传送阶段
- 连接释放阶段

#### 并发方式工作的服务器
调用 accept 要完成的动作较多。这是因为一个服务器必须能够同时处理多个连接。这样的服务器常称为并发方式 (concurrent) 工作的服务器

## P2P 应用
### P2P 工作方式概述
- 自从互联网能够提供音频/视频服务后，宽带上网用户数也急剧增长。很多用户使用宽带接入的目的就是为了更快地下载音频/视频文件
- P2P工作方式受到广大网民的欢迎。这种工作方式解决了集中式媒体服务器可能出现的瓶颈问题
- 在P2P工作方式下，所有的音频/视频文件都是在普通的互联网用户之间传输。这是相当于有很多分散在各地的媒体服务器向其他用户提供所要下载的音频/视频文件
- 在互联网流量中，P2P工作方式下的文件分发已占据最大的份额，比万维网应用所占的比例大得多

### 具有集中目录服务器的 P2P 工作方式
#### Napster
- Napster 最早使用 P2P 技术，提供免费下载 MP3 音乐
- Napster 将所有音乐文件的索引信息都集中存放在 Napster 目录服务器中
使用者只要查找目录服务器，就可知道应从何处下载所要的 MP3 文件
- 用户要及时向 Napster 的目录服务器报告自己存有的音乐文件
- Napster 的文件传输是分散的，文件的定位则是集中的
- 这种集中式目录服务器的缺点就是可靠性差。Napster被判决属于“间接侵害版权”，在2000年7月底Napster网站被迫关闭
### 具有全分布式结构的 P2P 文件共享程序
#### Gnutella
- Gnutella 是第二代 P2P 文件共享程序，采用全分布方法定位内容的 P2P 文件共享应用程序。
- Gnutella 与 Napster 最大的区别就是不使用集中式的目录服务器，而是使用洪泛法在大量 Gnutella 用户之间进行查询
- 为了不使查询的通信量过大，Gnutella 设计了一种有限范围的洪泛查询，减少了倾注到互联网的查询流量，但也影响到查询定位的准确性
#### 电骡eMule
- 第三代 P2P 文件共享程序采用分散定位和分散传输技术。例如 KaZaA，电骡 eMule，比特洪流 BT (Bit Torrent) 等
- 电骡eMule使用分散定位和分散传输技术，把每一个文件划分为许多小文件块，并使用多源文件传输协议MFTP进行传送。因此用户可以同时从很多地方下载一个文件中的不同文件块。由于每一个文件块都很小，并且是并行下载，所以下载可以比较快的完成
- eMule用户在下载文件的同时，也在上传文件，因此，互联网上成千上万的eMule用户在同时下载和上传一个个小的文件块

#### 使用 P2P 的比特洪流 BT
- BitTorrent 所有对等方集合称为一个洪流 (torrent)
- 下载文件的数据单元为长度固定的文件块 (chunk)
- 基础设施结点，叫做追踪器 (tracker)
- A 和对等方建立了 TCP 连接。所有与 A 建立了 TCP 连接的对等方为相邻对等方(neighboring peers)

#### BT 协议
- 当一个新的对等方A加入洪流时，追踪器就随机地从参与的对等方集合中选择若干个（例如30个），并把这些对等方的IP地址告诉A。于是A就和这些对等方建立了TCP连接。所有与A建立了TCP连接的对等方为“相邻对等方”（neighboring peers）
- A使用最稀有的优先（rarest first）的技术，首先向其相邻对等方请求对应的文件块
- 凡当前以最高数据率向A传送文件块的某相邻对等方，A就优先把所请求的文件块传送给该相邻对等方
### P2P 文件分发的分析
#### 相关概念
- 从互联网传送数据到主机，叫做下载 (download)
- 从主机向互联网传送，则称为上传 (upload) 或上载

































